<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¢ ê³¼ëª©ë³„ ê²Œì„ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #2C5530; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 10px; 
            background: rgba(255,255,255,0.7); 
            border-left: 5px solid #4169E1; 
        }
        button { 
            background: linear-gradient(45deg, #28a745, #20c997); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 5px; 
            transition: all 0.3s ease; 
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        .subject-btn { background: linear-gradient(45deg, #4169E1, #1E90FF); }
        .level-btn { background: linear-gradient(45deg, #9370DB, #8A2BE2); }
        .test-result { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 8px; 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
        }
        .success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        
        .auto-login { 
            background: linear-gradient(45deg, #FF6347, #FF7F50); 
            margin-bottom: 20px; 
        }
        
        .question-display { 
            background: #fff; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 15px 0; 
            border: 2px solid #4169E1; 
        }
        
        .question-text { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #2C5530; 
            margin-bottom: 15px; 
        }
        
        .options { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
        }
        
        .option-btn { 
            background: linear-gradient(45deg, #89CFF0, #4682B4); 
            font-size: 1rem; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¢ ê³¼ëª©ë³„ ê²Œì„ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="test-section">
            <h3>ğŸ® ìë™ ë¡œê·¸ì¸ ë° ê²Œì„ ì‹œì‘</h3>
            <button class="auto-login" onclick="autoLoginAndStart()">ğŸ“± ìë™ ë¡œê·¸ì¸ í›„ ê²Œì„ ì‹œì‘</button>
            <div id="login-status"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“š ê³¼ëª© ì„ íƒ í…ŒìŠ¤íŠ¸</h3>
            <button class="subject-btn" onclick="testSubject('math')">ğŸ”¢ ìˆ˜í•™</button>
            <button class="subject-btn" onclick="testSubject('english')">ğŸ‡¬ğŸ‡§ ì˜ì–´</button>
            <button class="subject-btn" onclick="testSubject('social')">ğŸ›ï¸ ì‚¬íšŒ</button>
            <button class="subject-btn" onclick="testSubject('general')">ğŸ§  ì¼ë°˜ìƒì‹</button>
            <div id="subject-result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š ë ˆë²¨ ì„ íƒ í…ŒìŠ¤íŠ¸</h3>
            <button class="level-btn" onclick="testLevel(1)">â­ Level 1</button>
            <button class="level-btn" onclick="testLevel(2)">â­â­ Level 2</button>
            <button class="level-btn" onclick="testLevel(3)">â­â­â­ Level 3</button>
            <div id="level-result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ¯ ê²Œì„ ì‹œì‘ í…ŒìŠ¤íŠ¸</h3>
            <button onclick="startTestGame()">ğŸš€ í˜„ì¬ ì„¤ì •ìœ¼ë¡œ ê²Œì„ ì‹œì‘</button>
            <div id="game-result"></div>
            
            <div class="question-display" id="question-display" style="display: none;">
                <div class="question-text" id="question-text"></div>
                <div class="options" id="question-options"></div>
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="nextQuestion()">â­ï¸ ë‹¤ìŒ ë¬¸ì œ</button>
                    <button onclick="endTestGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”¥ Firebase í…ŒìŠ¤íŠ¸</h3>
            <button onclick="testFirebaseSync()">ğŸŒ Firebase ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
            <div id="firebase-result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š í˜„ì¬ ìƒíƒœ</h3>
            <div id="current-status">
                <p><strong>í˜„ì¬ ê³¼ëª©:</strong> <span id="current-subject">-</span></p>
                <p><strong>í˜„ì¬ ë ˆë²¨:</strong> <span id="current-level">-</span></p>
                <p><strong>ë¡œê·¸ì¸ ìƒíƒœ:</strong> <span id="login-state">-</span></p>
                <p><strong>Firebase ìƒíƒœ:</strong> <span id="firebase-state">-</span></p>
            </div>
        </div>
    </div>

    <script type="module">
        // í•„ìš”í•œ ëª¨ë“ˆ import
        import { initializeFirebase, handleLogin } from './js/auth/firebase-auth.js';
        import { loadAllSubjectData, SUBJECTS, LEVELS } from './js/game/subject-data.js';
        import './js/game/game-logic.js';
        
        let testGameData = {
            questions: [],
            currentIndex: 0,
            score: 0,
            isPlaying: false
        };
        
        // Firebase ì´ˆê¸°í™”
        async function initializeTest() {
            console.log('ğŸ”¥ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™”...');
            
            try {
                // Firebase ì´ˆê¸°í™”
                const firebaseInitialized = await initializeFirebase();
                updateStatus('firebase-state', firebaseInitialized ? 'ì—°ê²°ë¨' : 'ì—°ê²° ì‹¤íŒ¨');
                
                // ê³¼ëª© ë°ì´í„° ë¡œë“œ
                const dataLoaded = await loadAllSubjectData();
                console.log('ğŸ“š ê³¼ëª© ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', dataLoaded);
                
                updateStatus('current-subject', window.getCurrentSubject ? window.getCurrentSubject() : 'math');
                updateStatus('current-level', window.getCurrentLevel ? window.getCurrentLevel() : '1');
                
            } catch (error) {
                console.error('âŒ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatus(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        }
        
        // ìë™ ë¡œê·¸ì¸ ë° ê²Œì„ ì‹œì‘
        window.autoLoginAndStart = async function() {
            const statusEl = document.getElementById('login-status');
            statusEl.innerHTML = '<div class="test-result">ğŸ”„ ìë™ ë¡œê·¸ì¸ ì¤‘...</div>';
            
            try {
                // ì„ì‹œ DOM ìš”ì†Œ ìƒì„±
                const nameInput = document.createElement('input');
                nameInput.id = 'player-name-input';
                nameInput.value = 'ì•„ë¹ ';
                document.body.appendChild(nameInput);
                
                const pinInput = document.createElement('input');
                pinInput.id = 'player-pin-input';
                pinInput.value = '9329';
                document.body.appendChild(pinInput);
                
                const feedback = document.createElement('div');
                feedback.id = 'login-feedback';
                document.body.appendChild(feedback);
                
                // ë¡œê·¸ì¸ ì‹¤í–‰
                await handleLogin();
                
                // ê²°ê³¼ í™•ì¸
                if (window.currentUserProfile) {
                    statusEl.innerHTML = `
                        <div class="test-result success">
                            âœ… ë¡œê·¸ì¸ ì„±ê³µ: ${window.currentUserProfile.name}
                            <br>ì´ì : ${window.currentUserProfile.totalScore || 0}ì 
                        </div>
                    `;
                    updateStatus('login-state', 'ë¡œê·¸ì¸ë¨');
                } else {
                    statusEl.innerHTML = '<div class="test-result error">âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨</div>';
                }
                
                // DOM ì •ë¦¬
                document.body.removeChild(nameInput);
                document.body.removeChild(pinInput);
                document.body.removeChild(feedback);
                
            } catch (error) {
                statusEl.innerHTML = `<div class="test-result error">âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        };
        
        // ê³¼ëª© í…ŒìŠ¤íŠ¸
        window.testSubject = function(subject) {
            const resultEl = document.getElementById('subject-result');
            
            console.log(`ğŸ“š ê³¼ëª© í…ŒìŠ¤íŠ¸: ${subject}`);
            
            if (window.changeSubject) {
                window.changeSubject(subject);
                updateStatus('current-subject', SUBJECTS[subject]?.name || subject);
                
                resultEl.innerHTML = `
                    <div class="test-result success">
                        âœ… ${SUBJECTS[subject]?.icon} ${SUBJECTS[subject]?.name} ì„ íƒë¨
                        <br>${SUBJECTS[subject]?.description}
                    </div>
                `;
            } else {
                resultEl.innerHTML = '<div class="test-result error">âŒ changeSubject í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</div>';
            }
        };
        
        // ë ˆë²¨ í…ŒìŠ¤íŠ¸
        window.testLevel = function(level) {
            const resultEl = document.getElementById('level-result');
            
            console.log(`ğŸ“Š ë ˆë²¨ í…ŒìŠ¤íŠ¸: ${level}`);
            
            if (window.onDifficultyChange) {
                window.onDifficultyChange(level);
                updateStatus('current-level', level);
                
                resultEl.innerHTML = `
                    <div class="test-result success">
                        âœ… Level ${level} ì„ íƒë¨ (${LEVELS[level]?.name})
                        <br>${LEVELS[level]?.description}
                    </div>
                `;
            } else {
                resultEl.innerHTML = '<div class="test-result error">âŒ onDifficultyChange í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</div>';
            }
        };
        
        // ê²Œì„ ì‹œì‘ í…ŒìŠ¤íŠ¸
        window.startTestGame = async function() {
            const resultEl = document.getElementById('game-result');
            
            console.log('ğŸ¯ ê²Œì„ ì‹œì‘ í…ŒìŠ¤íŠ¸...');
            
            if (!window.startGame) {
                resultEl.innerHTML = '<div class="test-result error">âŒ startGame í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</div>';
                return;
            }
            
            const currentSubject = window.getCurrentSubject ? window.getCurrentSubject() : 'math';
            const currentLevel = window.getCurrentLevel ? window.getCurrentLevel() : 1;
            
            try {
                const started = await window.startGame(currentSubject, currentLevel);
                
                if (started) {
                    // í˜„ì¬ ê²Œì„ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
                    const gameState = window.getCurrentGameState ? window.getCurrentGameState() : {};
                    
                    if (gameState.questions && gameState.questions.length > 0) {
                        testGameData = {
                            questions: gameState.questions,
                            currentIndex: 0,
                            score: 0,
                            isPlaying: true
                        };
                        
                        resultEl.innerHTML = `
                            <div class="test-result success">
                                âœ… ê²Œì„ ì‹œì‘ ì„±ê³µ!
                                <br>ê³¼ëª©: ${SUBJECTS[currentSubject]?.name}
                                <br>ë ˆë²¨: Level ${currentLevel}
                                <br>ë¬¸ì œ ìˆ˜: ${gameState.questions.length}ê°œ
                            </div>
                        `;
                        
                        showCurrentQuestion();
                    } else {
                        resultEl.innerHTML = '<div class="test-result error">âŒ ë¬¸ì œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŒ</div>';
                    }
                } else {
                    resultEl.innerHTML = '<div class="test-result error">âŒ ê²Œì„ ì‹œì‘ ì‹¤íŒ¨</div>';
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="test-result error">âŒ ê²Œì„ ì‹œì‘ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        };
        
        // í˜„ì¬ ë¬¸ì œ í‘œì‹œ
        function showCurrentQuestion() {
            if (!testGameData.isPlaying || testGameData.currentIndex >= testGameData.questions.length) {
                return;
            }
            
            const question = testGameData.questions[testGameData.currentIndex];
            const questionDisplay = document.getElementById('question-display');
            const questionText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('question-options');
            
            // ì§ˆë¬¸ í…ìŠ¤íŠ¸ ì„¤ì •
            if (question.korean) {
                questionText.textContent = `[ì˜ì–´] ${question.korean}`;
            } else if (question.question) {
                questionText.textContent = question.question;
            } else {
                questionText.textContent = question.questionText || 'ë¬¸ì œë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
            }
            
            // ì„ íƒì§€ ìƒì„±
            optionsContainer.innerHTML = '';
            if (question.options && Array.isArray(question.options)) {
                question.options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option;
                    btn.onclick = () => selectTestAnswer(option, question);
                    optionsContainer.appendChild(btn);
                });
            }
            
            questionDisplay.style.display = 'block';
        }
        
        // í…ŒìŠ¤íŠ¸ìš© ë‹µë³€ ì„ íƒ
        window.selectTestAnswer = function(selected, question) {
            const currentSubject = window.getCurrentSubject ? window.getCurrentSubject() : 'math';
            let isCorrect = false;
            
            if (currentSubject === 'english') {
                isCorrect = selected === question.english;
            } else {
                isCorrect = selected === question.options[question.answer];
            }
            
            if (isCorrect) {
                testGameData.score += 10;
                alert(`âœ… ì •ë‹µ! í˜„ì¬ ì ìˆ˜: ${testGameData.score}ì `);
            } else {
                const correct = currentSubject === 'english' ? question.english : question.options[question.answer];
                alert(`âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. ì •ë‹µ: ${correct}`);
            }
        };
        
        // ë‹¤ìŒ ë¬¸ì œ
        window.nextQuestion = function() {
            testGameData.currentIndex++;
            if (testGameData.currentIndex < testGameData.questions.length) {
                showCurrentQuestion();
            } else {
                alert(`ğŸ‰ ê²Œì„ ì™„ë£Œ! ìµœì¢… ì ìˆ˜: ${testGameData.score}ì `);
                endTestGame();
            }
        };
        
        // ê²Œì„ ì¢…ë£Œ
        window.endTestGame = function() {
            testGameData.isPlaying = false;
            document.getElementById('question-display').style.display = 'none';
        };
        
        // Firebase ë™ê¸°í™” í…ŒìŠ¤íŠ¸
        window.testFirebaseSync = async function() {
            const resultEl = document.getElementById('firebase-result');
            
            if (!window.currentUserProfile) {
                resultEl.innerHTML = '<div class="test-result error">âŒ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!</div>';
                return;
            }
            
            try {
                // ì ìˆ˜ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
                if (window.updateGameScore) {
                    await window.updateGameScore(testGameData.score + 100);
                    resultEl.innerHTML = '<div class="test-result success">âœ… Firebase ë™ê¸°í™” ì™„ë£Œ!</div>';
                } else {
                    resultEl.innerHTML = '<div class="test-result error">âŒ updateGameScore í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</div>';
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="test-result error">âŒ Firebase ë™ê¸°í™” ì‹¤íŒ¨: ${error.message}</div>`;
            }
        };
        
        // Firebase ì¸ì¦ ì™„ë£Œ ì½œë°±
        window.onFirebaseReady = function(user) {
            if (user) {
                window.currentUserId = user.uid;
                updateStatus('firebase-state', 'ì¸ì¦ë¨');
                console.log('ğŸ”‘ Firebase ì¸ì¦ ì™„ë£Œ:', user.uid);
            }
        };
        
        // ì´ˆê¸°í™” ì‹¤í–‰
        initializeTest();
    </script>
</body>
</html>