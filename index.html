<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐾 동물 수집 학습 게임 🐾</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 로그인 모달 -->
    <div id="login-overlay">
        <div id="login-modal">
            <h2>🐾 동물 수집 학습 게임 🐾</h2>
            <input type="text" id="player-name-input" class="login-input" placeholder="플레이어 이름">
            <input type="password" id="player-pin-input" class="login-input" placeholder="4자리 숫자 PIN" maxlength="4" pattern="\d*">
            <button id="login-btn" class="login-btn">로그인</button>
            <button id="signup-btn" class="login-btn">새 플레이어 만들기</button>
            <p id="login-feedback"></p>
            <!-- 명예의 전당 -->
            <div id="hall-of-fame">
                <h3>🏆 명예의 전당 🏆</h3>
                <div id="fame-species" class="fame-entry">
                    <span class="trophy">🥇</span> 최다 수집가: <span class="player-name">계산 중...</span>
                </div>
                <div id="fame-level" class="fame-entry">
                    <span class="trophy">🥇</span> 최고 레벨 동물: <span class="player-name">계산 중...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="game-container" style="display: none;">
        <!-- 헤더 -->
        <div class="header">
            <h1>🐾 동물 수집 학습 게임 🐾</h1>
            
            <div class="nav-buttons">
                <div class="subject-selector">
                    <select id="subject-select" onchange="changeSubject()" class="subject-dropdown">
                        <option value="english">영어 🇬🇧</option>
                        <option value="social">사회 🏛️</option>
                        <option value="math">수학 🔢</option>
                        <option value="general">상식 🧠</option>
                    </select>
                    <button class="nav-btn active" onclick="showPage('game', this)">동물 잡기</button>
                </div>
                <button class="nav-btn" onclick="showPage('learning', this)">학습 통계 📈</button>
                <button class="nav-btn" onclick="showLearningReport()">개인 분석 🎯</button>
                <button class="nav-btn" onclick="showPage('synthesis', this)">동물 합성 🧬</button>
                <button class="nav-btn" onclick="showPage('market', this)">동물 시장 🏪</button>
                <button class="nav-btn" onclick="showPage('farm', this)">농장 꾸미기 🏡</button>
                <button class="nav-btn" onclick="showPage('encyclopedia', this)">동물 도감 📚</button>
                <button class="nav-btn" onclick="showPage('ranking', this)">랭킹 🏆</button>
                <button class="nav-btn" onclick="logout()">로그아웃 🚪</button>
            </div>

            <div class="user-info" id="user-info">
                <div class="current-user">현재 플레이어: <span id="current-user-name"></span></div>
            </div>

            <div class="game-stats" id="game-stats">
                <div class="stat-item">레벨 <span id="level">1</span></div>
                <div class="stat-item">점수: <span id="score">0</span></div>
                <div class="stat-item">💰 코인: <span id="coins">0</span></div>
                <div class="stat-item">동물 종류: <span id="species-count">0</span>종</div>
                <div class="stat-item">총 동물: <span id="total-animals">0</span>마리</div>
            </div>
        </div>

        <!-- 게임 페이지 -->
        <div id="game-page" class="page active">
            <div class="game-content">
                <div class="english-quiz-section">
                    <h2>🇬🇧 영어 퀴즈: 동물 잡기!</h2>
                    
                    <!-- 난이도 선택 -->
                    <div class="difficulty-selector">
                        <h3>난이도 선택:</h3>
                        <div class="difficulty-buttons">
                            <button class="difficulty-btn active" data-level="1" onclick="selectDifficulty(1)">
                                초급 📝<br><small>+10점</small>
                            </button>
                            <button class="difficulty-btn" data-level="2" onclick="selectDifficulty(2)">
                                중급 📚<br><small>+20점</small>
                            </button>
                            <button class="difficulty-btn" data-level="3" onclick="selectDifficulty(3)">
                                고급 🎓<br><small>+30점</small>
                            </button>
                            <button class="difficulty-btn" data-level="review" onclick="selectDifficulty('review')">
                                복습 🔄<br><small>틀린문제</small>
                            </button>
                        </div>
                    </div>

                    <div class="english-question-container">
                        <div class="english-question" id="english-question">난이도를 선택하고 시작하세요!</div>
                        <span id="speak-button" class="speak-btn" title="단어 발음 듣기" style="display: none;">🔊</span>
                    </div>
                    
                    <!-- 단어 출처 표시 -->
                    <div class="word-source" id="word-source" style="display: none;">
                        <span class="source-badge ai-generated" id="source-badge">🤖 AI 생성</span>
                    </div>
                    
                    <div class="english-options" id="english-options"></div>
                    <div class="feedback" id="feedback"></div>
                    
                    <!-- 학습 통계 -->
                    <div class="learning-stats" id="learning-stats" style="display: none;">
                        <h4>📊 현재 단어 통계</h4>
                        <div class="stats-row">
                            <span>정답: <strong id="word-correct">0</strong>회</span>
                            <span>오답: <strong id="word-incorrect">0</strong>회</span>
                            <span>정답률: <strong id="word-accuracy">0</strong>%</span>
                        </div>
                    </div>
                </div>

                <div class="collection-section">
                    <h2>🐾 내 동물 컬렉션</h2>
                    <p class="collection-hint">💡 동물을 클릭해서 수학 문제로 레벨업 시켜요!</p>
                    <div class="animal-grid" id="animal-collection"></div>
                </div>
            </div>
        </div>
        
        <!-- 학습 통계 페이지 -->
        <div id="learning-page" class="page">
            <div class="learning-container">
                <h2>📈 나의 영어 학습 통계</h2>
                
                <!-- 전체 학습 통계 -->
                <div class="overall-stats">
                    <h3>📊 전체 학습 현황</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-words-learned">0</div>
                            <div class="stat-label">학습한 단어</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-correct">0</div>
                            <div class="stat-label">총 정답수</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-accuracy">0%</div>
                            <div class="stat-label">전체 정답률</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="mastered-words">0</div>
                            <div class="stat-label">완전 학습</div>
                        </div>
                    </div>
                </div>
                
                <!-- 취약 단어 목록 -->
                <div class="weak-words-section">
                    <h3>🎯 복습이 필요한 단어들</h3>
                    <div class="weak-words-grid" id="weak-words-grid">
                        <p class="no-data">복습이 필요한 단어가 없습니다. 더 많은 문제를 풀어보세요!</p>
                    </div>
                </div>
                
                <!-- 우수 단어 목록 -->
                <div class="strong-words-section">
                    <h3>⭐ 잘 알고 있는 단어들</h3>
                    <div class="strong-words-grid" id="strong-words-grid">
                        <p class="no-data">아직 완전히 학습한 단어가 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 동물 합성 페이지 -->
        <div id="synthesis-page" class="page">
            <div class="synthesis-container">
                <h2>🧬 동물 합성 연구소</h2>
                <div class="synthesis-grid" id="synthesis-grid"></div>
            </div>
        </div>
        
        <!-- 시장 페이지 -->
        <div id="market-page" class="page">
            <div class="market-container">
                <h2>🏪 동물 시장</h2>
                <div class="market-sell-section">
                    <h3>내 동물 판매하기</h3>
                    <select id="sell-animal-select"></select>
                    <input type="number" id="sell-price-input" placeholder="판매 가격 (코인)">
                    <button class="nav-btn" onclick="sellAnimal()">판매 등록</button>
                </div>
                <h3>판매 중인 동물 목록</h3>
                <div class="market-table-container">
                    <table class="market-table">
                        <thead>
                            <tr>
                                <th>동물</th>
                                <th>이름</th>
                                <th>레벨</th>
                                <th>판매자</th>
                                <th>가격(🪙)</th>
                                <th>남은 시간</th>
                                <th>구매</th>
                            </tr>
                        </thead>
                        <tbody id="market-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 농장 꾸미기 페이지 -->
        <div id="farm-page" class="page">
            <div class="farm-page-container">
                <div class="farm-controls">
                    <h3>🌳 상점 💰</h3>
                    <div class="shop-grid" id="shop-grid"></div>
                    <hr style="margin: 20px 0;">
                    <h3>🎒 보관함</h3>
                    <div class="inventory-grid" id="inventory-grid"></div>
                </div>
                <div class="farm-area">
                    <div class="farm-grid" id="farm-grid"></div>
                </div>
            </div>
        </div>
        
        <!-- 동물 도감 페이지 -->
        <div id="encyclopedia-page" class="page">
            <div class="encyclopedia-container">
                <h2>📚 동물 도감</h2>
                <div class="encyclopedia-progress">
                    수집률: <span id="collection-progress">0 / 105</span> 종
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar-fill"></div>
                    </div>
                </div>
                <div class="encyclopedia-grid" id="encyclopedia-grid"></div>
            </div>
        </div>

        <!-- 랭킹 페이지 -->
        <div id="ranking-page" class="page">
            <div class="ranking-container">
                <h2>🏆 전체 랭킹 (점수 기준)</h2>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>순위</th>
                            <th>이름</th>
                            <th>점수</th>
                            <th>레벨</th>
                            <th>동물 종류</th>
                            <th>플레이 시간</th>
                            <th>농장 방문</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 수학 문제 모달 -->
    <div id="math-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMathModal()">&times;</span>
            <h3>🧮 동물 레벨업!</h3>
            <div id="math-question">5 + 3 = ?</div>
            <input type="number" id="math-answer-input" placeholder="정답은?">
            <br>
            <button id="math-submit-btn">확인</button>
            <div id="math-feedback"></div>
        </div>
    </div>
    
    <!-- AI 이야기 모달 -->
    <div id="story-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeStoryModal()">&times;</span>
            <h3 id="story-modal-title">동물 이야기</h3>
            <div id="story-content-area">
                <div id="story-loading" style="display: none;">
                    <p>이야기를 만들고 있어요... 잠시만 기다려주세요! 📖</p>
                    <div class="spinner"></div>
                </div>
                <p id="story-text"></p>
            </div>
        </div>
    </div>

    <!-- 농장 방문 모달 -->
    <div id="farm-visit-modal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <span class="close-btn" onclick="closeFarmVisitModal()">&times;</span>
            <h3 id="visit-farm-title">🏡 농장 방문</h3>
            <div style="margin: 15px 0; text-align: center;">
                <span id="farm-owner-info" style="background: linear-gradient(45deg, #FF69B4, #FFB6C1); color: white; padding: 8px 16px; border-radius: 15px; font-weight: bold;"></span>
            </div>
            <div style="background: linear-gradient(to bottom, #a8e063, #56ab2f); padding: 20px; border-radius: 15px; margin-top: 20px;">
                <div id="visit-farm-grid" class="farm-grid" style="pointer-events: none;"></div>
            </div>
            <div style="text-align: center; margin-top: 15px; color: #666; font-style: italic;">
                💡 다른 사용자의 농장은 구경만 가능합니다
            </div>
        </div>
    </div>

    <!-- JavaScript 파일들 - 순서대로 로드 -->
    <script src="function/game-data.js"></script>
    <script src="function/game-functions.js"></script>
    <script src="function/main.js"></script>
    
    <!-- Firebase SDK - DOM 로드 완료 후 초기화 -->
    <script>
        // DOM과 모든 스크립트 로드 완료 후 Firebase 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 잠시 대기 후 실행하여 모든 스크립트 함수가 로드되도록 함
            setTimeout(async function() {
                try {
                    console.log("Firebase 초기화 시작...");
                    
                    // 필수 함수들이 로드되었는지 확인
                    let checkCount = 0;
                    const maxChecks = 50; // 최대 5초 대기
                    
                    function checkFunctionsReady() {
                        return new Promise((resolve) => {
                            const checkInterval = setInterval(() => {
                                checkCount++;
                                console.log(`함수 로딩 확인 중... (${checkCount}/${maxChecks})`);
                                
                                if (typeof window.updateHallOfFame === 'function' && 
                                    typeof window.loadAnimalsFromJSON === 'function') {
                                    clearInterval(checkInterval);
                                    console.log("모든 필수 함수 로딩 완료!");
                                    resolve(true);
                                } else if (checkCount >= maxChecks) {
                                    clearInterval(checkInterval);
                                    console.error("함수 로딩 시간 초과");
                                    resolve(false);
                                }
                            }, 100); // 100ms마다 확인
                        });
                    }
                    
                    const functionsReady = await checkFunctionsReady();
                    
                    if (!functionsReady) {
                        console.error("필수 함수들이 로드되지 않았습니다.");
                        return;
                    }
                    
                    // Firebase 모듈들을 동적으로 import
                    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                    const { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                    const { getFirestore, doc, getDoc, setDoc, collection, getDocs, writeBatch, runTransaction, deleteDoc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                    const { getFunctions, httpsCallable } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js");

                    let auth, db, functions;
                    
                    // Firebase 초기화
                    const firebaseConfig = {
                      apiKey: "AIzaSyC2JV9KsIZ-M1crdnnxLfxyaRtGS1Brtcc",
                      authDomain: "animal-math-game-6eec2.firebaseapp.com",
                      projectId: "animal-math-game-6eec2",
                      storageBucket: "animal-math-game-6eec2.firebasestorage.app",
                      messagingSenderId: "104144283045",
                      appId: "1:104144283045:web:f0a387d83292a0d508744c",
                      measurementId: "G-M63W08193X"
                    };
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    functions = getFunctions(app);

                    console.log("Firebase 초기화 성공");

                    window.firebase = { auth, db, functions, doc, getDoc, setDoc, collection, getDocs, writeBatch, runTransaction, deleteDoc, onSnapshot, httpsCallable };

                    onAuthStateChanged(auth, async (user) => {
                        console.log("Auth 상태 변경:", user ? "로그인됨" : "로그아웃됨");
                        if (user) {
                            console.log("Firebase Auth User:", user.uid);
                            console.log("onFirebaseReady 호출됨");
                            
                            window.currentUserId = user.uid;
                            console.log("현재 사용자 ID 설정:", window.currentUserId);
                            
                            try {
                                console.log("동물 데이터 로딩 시작...");
                                await window.loadAnimalsFromJSON();
                                console.log("명예의 전당 업데이트 시작...");
                                await window.updateHallOfFame();
                                console.log("초기화 완료");
                            } catch (error) {
                                console.error('초기화 오류:', error);
                            }
                            
                            console.log("로그인 오버레이 표시");
                            const overlayEl = document.getElementById('login-overlay');
                            if (overlayEl) {
                                overlayEl.style.display = 'flex';
                            }
                        } else {
                             try {
                                console.log("익명 로그인 시도...");
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    const result = await signInAnonymously(auth);
                                    console.log("익명 로그인 성공:", result.user.uid);
                                }
                            } catch (error) {
                                console.error("익명 로그인 실패:", error);
                                alert("Firebase 인증 실패: " + error.message);
                            }
                        }
                    });
                } catch (error) {
                    console.error("Firebase 초기화 실패:", error);
                }
            }, 500); // 500ms 대기 후 실행
        });
    </script>
</body>
</html>