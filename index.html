<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêæ ÎèôÎ¨º ÏàòÏßë ÌïôÏäµ Í≤åÏûÑ üêæ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #FFB6C1 100%); min-height: 100vh; color: #333; }
        .game-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .header h1 { color: #2C5530; font-size: 2.8rem; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .nav-buttons { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .nav-btn { background: linear-gradient(45deg, #4169E1, #1E90FF); color: white; border: none; padding: 12px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.8rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .nav-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .nav-btn.active { background: linear-gradient(45deg, #32CD32, #228B22); }
        
        /* Í≥ºÎ™© ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ Ïä§ÌÉÄÏùº */
        .subject-selector { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 20px;
        }
        
        .subject-dropdown {
            background: linear-gradient(45deg, #9370DB, #8A2BE2);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .subject-dropdown:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .subject-dropdown option {
            background: #8A2BE2;
            color: white;
            padding: 10px;
        }
        .user-info { margin: 15px 0; }
        .current-user { background: linear-gradient(45deg, #FF69B4, #FFB6C1); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.2); word-break: break-all; }
        .game-stats { display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .stat-item { background: linear-gradient(45deg, #FFD700, #FFA500); padding: 10px 20px; border-radius: 20px; font-weight: bold; color: #8B4513; box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-width: 120px; text-align: center; }
        .page { display: none; }
        .page.active { display: block; }
        .game-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .english-quiz-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; }
        .english-quiz-section h2 { color: #2C5530; margin-bottom: 20px; font-size: 1.8rem; }
        .english-question-container { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .english-question { font-size: 2.5rem; color: #4169E1; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .speak-btn { font-size: 2.5rem; cursor: pointer; transition: transform 0.2s; }
        .speak-btn:hover { transform: scale(1.2); }
        .english-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .english-option-btn { background: linear-gradient(45deg, #89CFF0, #4682B4); color: white; border: none; padding: 20px; border-radius: 15px; font-size: 1.5rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .english-option-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .english-option-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .feedback { margin: 20px 0; padding: 20px; border-radius: 20px; font-weight: bold; text-align: center; font-size: 1.2rem; min-height: 60px; display: flex; align-items: center; justify-content: center; transition: all 0.5s ease; }
        .feedback.correct { background: linear-gradient(45deg, #90EE90, #32CD32); color: #006400; }
        .feedback.incorrect { background: linear-gradient(45deg, #FFB6C1, #FF69B4); color: #8B0000; }
        .collection-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .collection-section h2 { color: #2C5530; margin-bottom: 20px; text-align: center; font-size: 1.8rem; }
        .collection-hint { text-align: center; color: #666; margin-bottom: 20px; font-style: italic; }
        .animal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; max-height: 450px; overflow-y: auto; padding: 5px; }
        .animal-card { background: linear-gradient(45deg, #FFE4E1, #F0E68C); border-radius: 20px; padding: 15px; text-align: center; box-shadow: 0 6px 20px rgba(0,0,0,0.15); transition: all 0.3s ease; cursor: pointer; border: 3px solid transparent; }
        .animal-card:hover { transform: scale(1.08); box-shadow: 0 12px 35px rgba(0,0,0,0.25); }
        .animal-emoji { font-size: 3.5rem; display: block; margin-bottom: 10px; }
        .animal-name { font-weight: bold; color: #2C5530; margin-bottom: 5px; font-size: 1rem; word-break: keep-all; }
        .animal-level { font-weight: bold; font-size: 1.1rem; color: #8A2BE2; margin-bottom: 8px; }
        .special-name { color: #8B4513; font-style: italic; font-size: 0.9rem; margin-bottom: 8px; }
        .rarity-badge { background: linear-gradient(45deg, #FFD700, #FFA500); color: #8B4513; font-size: 0.8rem; font-weight: bold; padding: 4px 10px; border-radius: 12px; display: inline-block; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { margin: auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; }
        #math-modal .modal-content { background: linear-gradient(135deg, #e0f7fa, #ffffff, #fffde7); }
        #math-question { font-size: 2.5rem; color: #4169E1; margin: 25px 0; font-weight: bold; }
        #math-answer-input { font-size: 1.8rem; padding: 15px 20px; border: 3px solid #87CEEB; border-radius: 20px; width: 250px; margin: 15px; text-align: center; }
        #math-answer-input:disabled { background-color: #eee; }
        #math-submit-btn { background: linear-gradient(45deg, #32CD32, #228B22); color: white; border: none; padding: 18px 35px; font-size: 1.3rem; border-radius: 20px; cursor: pointer; margin: 15px; font-weight: bold; }
        #math-submit-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        #math-feedback { min-height: 40px; margin-top: 15px; font-weight: bold; font-size: 1.1rem; }
        .instructions { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-width: 900px; margin: 0 auto; }
        .instructions h2 { color: #2C5530; font-size: 2.2rem; margin-bottom: 25px; text-align: center; }
        .instructions h3 { color: #4169E1; font-size: 1.4rem; margin: 25px 0 15px 0; }
        .instructions p, .instructions li { font-size: 1.1rem; line-height: 1.7; color: #333; margin-bottom: 12px; }
        .instructions ul { margin-left: 25px; margin-bottom: 18px; }
        .encyclopedia-container { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .encyclopedia-container h2 { color: #2C5530; text-align: center; font-size: 2rem; margin-bottom: 20px; }
        .encyclopedia-progress { text-align: center; font-size: 1.2rem; font-weight: bold; color: #4169E1; margin-bottom: 20px; }
        .progress-bar-container { width: 80%; max-width: 500px; height: 25px; background-color: #e0e0e0; border-radius: 15px; margin: 10px auto; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #98FB98, #32CD32); border-radius: 15px; transition: width 0.5s ease-in-out; }
        .encyclopedia-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; max-height: 60vh; overflow-y: auto; padding: 10px; }
        .encyclopedia-card { background: #fff; border-radius: 15px; padding: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .encyclopedia-card.uncollected { filter: grayscale(100%); opacity: 0.6; }
        .encyclopedia-card .animal-emoji { font-size: 3rem; }
        .encyclopedia-card .animal-name { font-size: 1rem; }
        .encyclopedia-card .animal-count { font-size: 0.9rem; color: #666; }
        .farm-page-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .farm-controls { background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .farm-controls h3 { color: #2C5530; text-align: center; margin-bottom: 15px; }
        .shop-grid, .inventory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 250px; overflow-y: auto; padding: 5px; }
        .shop-item, .inventory-item { background: #f0f8ff; border-radius: 15px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s ease; border: 2px solid #87CEEB; }
        .shop-item:hover, .inventory-item:hover { transform: scale(1.05); background: #e0f0ff; }
        .inventory-item.selected { border-color: #FF69B4; background: #ffe6f0; }
        .item-emoji { font-size: 2.5rem; }
        .item-name { font-weight: bold; font-size: 0.9rem; }
        .item-price, .item-count { font-size: 0.8rem; color: #555; }
        .farm-area { background: linear-gradient(to bottom, #a8e063, #56ab2f); padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .farm-grid { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(6, 1fr); gap: 5px; aspect-ratio: 8 / 6; }
        .farm-cell { background: rgba(255, 255, 255, 0.2); border-radius: 10px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; position: relative; }
        .farm-cell:hover { background: rgba(255, 255, 255, 0.4); }
        .farm-cell .placed-animal { position: absolute; bottom: 5px; opacity: 0.9; animation: bounce 2s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .synthesis-container { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .synthesis-container h2 { color: #2C5530; text-align: center; font-size: 2rem; margin-bottom: 20px; }
        .synthesis-grid { display: grid; grid-template-columns: 1fr; gap: 20px; max-height: 70vh; overflow-y: auto; padding: 10px; }
        .synthesis-card { background: linear-gradient(45deg, #f0e6ff, #e6f3ff); border-radius: 20px; padding: 20px; display: flex; align-items: center; justify-content: space-around; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .synthesis-ingredient, .synthesis-result { text-align: center; }
        .synthesis-ingredient .animal-emoji { font-size: 3rem; }
        .synthesis-ingredient.not-owned { filter: grayscale(100%); opacity: 0.5; }
        .synthesis-symbol { font-size: 2.5rem; font-weight: bold; color: #4169E1; }
        .synthesis-btn { background: linear-gradient(45deg, #9370DB, #8A2BE2); color: white; border: none; padding: 12px 24px; border-radius: 15px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .synthesis-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Îß§Ïùº Î°úÍ∑∏Ïù∏ Î≥¥ÏÉÅ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes rewardPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes coinFall {
            0% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(80vh) rotate(360deg); 
                opacity: 0; 
            }
        }
        
        /* ÌååÌã∞ÌÅ¥ Ìö®Í≥º */
        @keyframes sparkle {
            0%, 100% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1) rotate(180deg); opacity: 1; }
        }
        
        .sparkle-particle {
            position: fixed;
            width: 10px;
            height: 10px;
            background: gold;
            border-radius: 50%;
            animation: sparkle 1.5s ease-in-out;
            z-index: 3000;
            pointer-events: none;
        }
        
        /* Ïù¥Î≤§Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï∂îÍ∞Ä */
        @keyframes sparkleEffect {
            0% { transform: scale(0.5) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        @keyframes mysticalGlow {
            0% { box-shadow: 0 0 0 rgba(147, 112, 219, 0.5); }
            50% { box-shadow: 0 0 30px rgba(147, 112, 219, 0.8); }
            100% { box-shadow: 0 0 20px rgba(147, 112, 219, 0.6); }
        }
        
        @keyframes mysteryBox {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotateY(5deg); }
            75% { transform: scale(0.95) rotateY(-5deg); }
        }
        
        @keyframes slideInRight {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInDown {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        /* Ï†ïÎãµ/Ïò§Îãµ Ïï†ÎãàÎ©îÏù¥ÏÖò Í∞ïÌôî */
        @keyframes correctPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(50, 205, 50, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(50, 205, 50, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(50, 205, 50, 0.7); }
        }
        
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes levelUpBurst {
            0% { 
                transform: scale(0) rotate(0deg); 
                opacity: 0; 
                background: #FFD700; 
            }
            50% { 
                transform: scale(1.2) rotate(180deg); 
                opacity: 1; 
                background: #FFA500; 
            }
            100% { 
                transform: scale(1) rotate(360deg); 
                opacity: 0.8; 
                background: #FF69B4; 
            }
        }
        
        @keyframes animalHop {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }
        
        @keyframes coinGlow {
            0%, 100% { text-shadow: 0 0 5px gold; }
            50% { text-shadow: 0 0 20px gold, 0 0 30px orange; }
        }
        
        /* Ìò∏Î≤Ñ Ìö®Í≥º Í∞ïÌôî */
        .english-option-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: coinGlow 1s infinite;
        }
        
        .animal-card:hover .animal-emoji {
            animation: animalHop 0.6s ease-in-out;
        }
        
        /* ÌîºÎìúÎ∞± Í∞ïÌôî ÌÅ¥ÎûòÏä§ */
        .feedback.correct {
            animation: correctPulse 0.8s ease-out;
        }
        
        .feedback.incorrect {
            animation: incorrectShake 0.6s ease-out;
        }
        .new-animal-alert { z-index: 1000; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(45deg, #FFD700, #FFA500); padding: 35px; border-radius: 25px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: popIn 0.6s ease; }
        .new-animal-alert .new-animal-emoji { font-size: 6rem; display: block; margin-bottom: 20px; }
        .new-animal-alert h3 { color: #8B4513; margin-bottom: 15px; font-size: 1.5rem; }
        .new-animal-alert p { color: #8B4513; font-weight: bold; margin-bottom: 10px; }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        #login-modal { background: white; padding: 40px; border-radius: 25px; width: 90%; max-width: 450px; text-align: center; }
        #login-modal h2 { margin-bottom: 20px; color: #2C5530; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; font-size: 1.2rem; border-radius: 15px; border: 2px solid #ccc; }
        .login-btn { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 15px; border: none; color: white; cursor: pointer; margin-top: 10px; font-weight: bold; }
        #login-btn { background: linear-gradient(45deg, #4169E1, #1E90FF); }
        #signup-btn { background: linear-gradient(45deg, #32CD32, #228B22); }
        #login-feedback { margin-top: 15px; color: red; font-weight: bold; min-height: 20px; }
        
        #hall-of-fame { border-top: 2px dashed #ccc; margin-top: 25px; padding-top: 20px; }
        #hall-of-fame h3 { color: #8B4513; margin-bottom: 15px; }
        .fame-entry { margin-bottom: 10px; font-size: 1.1rem; }
        .fame-entry .trophy { margin-right: 8px; }
        .fame-entry .player-name { font-weight: bold; color: #4169E1; }

        .ranking-container, .market-container { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .ranking-container h2, .market-container h2 { color: #2C5530; text-align: center; font-size: 2rem; margin-bottom: 20px; }
        .ranking-table, .market-table { width: 100%; border-collapse: collapse; }
        .ranking-table th, .ranking-table td, .market-table th, .market-table td { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; }
        .ranking-table th, .market-table th { background-color: #e0f0ff; color: #4169E1; }
        .ranking-table tr:nth-child(even), .market-table tr:nth-child(even) { background-color: #f9f9f9; }
        .ranking-table .my-rank { background-color: #fffde7; font-weight: bold; }
        .clickable-user-name:hover { color: #FF69B4 !important; background-color: rgba(255, 105, 180, 0.1); padding: 2px 6px; border-radius: 8px; }
        .market-sell-section { background: #e6f3ff; padding: 20px; border-radius: 20px; margin-bottom: 30px; }
        .market-sell-section h3 { color: #4169E1; margin-bottom: 15px; }
        .market-sell-section select, .market-sell-section input { padding: 10px; border-radius: 10px; border: 1px solid #ccc; margin: 0 5px; }
        .market-table-container { max-height: 40vh; overflow-y: auto; }

        /* ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù Ïä§ÌÉÄÏùº */
        .difficulty-selector { margin-bottom: 20px; text-align: center; }
        .difficulty-selector h3 { color: #2C5530; margin-bottom: 15px; }
        .difficulty-buttons { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .difficulty-btn { background: linear-gradient(45deg, #e0e0e0, #f5f5f5); color: #333; border: 3px solid #ccc; padding: 15px 20px; border-radius: 15px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; min-width: 80px; text-align: center; }
        .difficulty-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .difficulty-btn.active { background: linear-gradient(45deg, #32CD32, #228B22); color: white; border-color: #228B22; }
        .difficulty-btn small { display: block; font-size: 0.8rem; margin-top: 5px; }

        /* ÌïôÏäµ ÌÜµÍ≥Ñ Ïä§ÌÉÄÏùº */
        .learning-stats { background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 15px; margin-top: 20px; border: 2px solid #87CEEB; }
        .learning-stats h4 { color: #4169E1; margin-bottom: 10px; text-align: center; }
        .stats-row { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
        .stats-row span { background: #f0f8ff; padding: 8px 12px; border-radius: 10px; font-size: 0.9rem; }

        /* Î≥µÏäµ Î™®Îìú Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .review-mode .english-quiz-section { border: 3px solid #FF6B6B; background: linear-gradient(135deg, #fff5f5, #ffffff); }
        .review-mode .english-quiz-section h2::after { content: " (Î≥µÏäµ Î™®Îìú)"; color: #FF6B6B; }

        /* ÌïôÏäµ ÌÜµÍ≥Ñ ÌéòÏù¥ÏßÄ Ïä§ÌÉÄÏùº */
        .learning-container { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .learning-container h2 { color: #2C5530; text-align: center; font-size: 2rem; margin-bottom: 30px; }
        .learning-container h3 { color: #4169E1; margin: 25px 0 15px 0; font-size: 1.4rem; }
        
        .overall-stats { background: linear-gradient(135deg, #f0f8ff, #e6f3ff); padding: 20px; border-radius: 20px; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: #4169E1; margin-bottom: 10px; }
        .stat-label { color: #666; font-size: 0.9rem; }
        
        .weak-words-section, .strong-words-section { background: linear-gradient(135deg, #fff5f5, #ffe6f0); padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .strong-words-section { background: linear-gradient(135deg, #f0fff0, #e6ffe6); }
        
        .weak-words-grid, .strong-words-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; max-height: 300px; overflow-y: auto; }
        .word-progress-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 5px solid #FF6B6B; }
        .word-progress-card.strong { border-left-color: #32CD32; }
        .word-progress-card .word-pair { font-weight: bold; margin-bottom: 8px; color: #2C5530; }
        .word-progress-card .progress-stats { font-size: 0.9rem; color: #666; display: flex; justify-content: space-between; }
        .word-progress-card .accuracy-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 5px; margin: 8px 0; overflow: hidden; }
        .word-progress-card .accuracy-fill { height: 100%; background: linear-gradient(90deg, #FF6B6B, #FFB6C1); transition: width 0.3s ease; }
        .word-progress-card.strong .accuracy-fill { background: linear-gradient(90deg, #32CD32, #98FB98); }
        .no-data { text-align: center; color: #999; font-style: italic; grid-column: 1 / -1; padding: 40px; }

        /* Îã®Ïñ¥ Ï∂úÏ≤ò ÌëúÏãú Ïä§ÌÉÄÏùº */
        .word-source { text-align: center; margin: 10px 0; }
        .source-badge { display: inline-block; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; border: 2px solid; }
        .source-badge.ai-generated { background: linear-gradient(45deg, #4CAF50, #81C784); color: white; border-color: #4CAF50; animation: aiGlow 2s ease-in-out infinite alternate; }
        .source-badge.hardcoded { background: linear-gradient(45deg, #FF9800, #FFB74D); color: white; border-color: #FF9800; }
        .source-badge.fallback { background: linear-gradient(45deg, #9E9E9E, #BDBDBD); color: white; border-color: #9E9E9E; }
        .source-badge.json-file { background: linear-gradient(45deg, #2196F3, #64B5F6); color: white; border-color: #2196F3; }
        
        @keyframes aiGlow { 0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); } 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.8), 0 0 30px rgba(76, 175, 80, 0.6); } }

        /* AI Ïù¥ÏïºÍ∏∞ Î™®Îã¨ Ïä§ÌÉÄÏùº */
        #story-modal .modal-content { background: linear-gradient(135deg, #fffde7, #fff); text-align: left; }
        #story-content-area { max-height: 60vh; overflow-y: auto; margin-top: 20px; padding-right: 15px; line-height: 1.8; font-size: 1.1rem; }
        #story-text { white-space: pre-wrap; }
        
        .story-content { margin-bottom: 20px; line-height: 1.8; }
        .story-info { border-top: 1px solid #e0e0e0; padding-top: 15px; margin-top: 20px; text-align: center; }
        .story-info small { color: #666; font-size: 0.85rem; background: #f5f5f5; padding: 8px 12px; border-radius: 10px; display: inline-block; }
        .story-info strong { color: #4169E1; }
        
        .story-btn { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; border: none; padding: 5px 10px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; margin-top: 8px; transition: background 0.3s; }
        .story-btn:hover { background: linear-gradient(45deg, #ff8e8e, #ff6b6b); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #8A2BE2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .game-content, .farm-page-container { grid-template-columns: 1fr; }
            .farm-controls { margin-bottom: 20px; }
        }
        @media (max-width: 768px) {
            .game-container { padding: 15px; }
            .header h1 { font-size: 2.2rem; }
            .game-stats { flex-direction: column; align-items: center; gap: 10px; }
            .nav-buttons { flex-direction: column; align-items: center; gap: 10px; }
            .english-question { font-size: 2rem; }
            .english-option-btn { font-size: 1.2rem; padding: 15px; }
            .animal-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
            .encyclopedia-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .synthesis-card { flex-direction: column; gap: 10px; }
        }
        
        /* ==================== Î∞∞ÌãÄÎ™®Îìú Ïä§ÌÉÄÏùº ==================== */
        
        /* Î∞∞ÌãÄ Ïª®ÌÖåÏù¥ÎÑà */
        .battle-container { background: rgba(0, 0, 0, 0.9); color: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .battle-container h2 { color: #FFD700; text-align: center; font-size: 2.5rem; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        
        /* Î∞∞ÌãÄ ÌôîÎ©¥ Ï†ÑÌôò */
        .battle-screen { display: none; }
        .battle-screen.active { display: block; }
        
        /* Î©îÏù∏ Î©îÎâ¥ Í∑∏Î¶¨Îìú */
        .battle-menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .battle-option { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 30px 20px; 
            border-radius: 20px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: 2px solid #333;
        }
        .battle-option:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3); 
            border-color: #FFD700; 
        }
        .battle-icon { font-size: 3rem; margin-bottom: 15px; }
        .battle-option h3 { color: #FFD700; margin: 15px 0 10px 0; font-size: 1.3rem; }
        .battle-option p { color: #ccc; font-size: 0.9rem; line-height: 1.4; }
        
        /* Ìèº Ïä§ÌÉÄÏùº */
        .room-setup, .join-room-form, .public-rooms-list, .battle-stats { 
            max-width: 500px; 
            margin: 0 auto; 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 30px; 
            border-radius: 20px; 
            border: 2px solid #333;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #FFD700; font-weight: bold; margin-bottom: 8px; font-size: 1.1rem; }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #444; 
            border-radius: 10px; 
            background: #2a2a3e; 
            color: white; 
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus { 
            outline: none; 
            border-color: #FFD700; 
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); 
        }
        
        .radio-group { display: flex; gap: 20px; }
        .radio-group label { display: flex; align-items: center; color: white; font-weight: normal; }
        .radio-group input[type="radio"] { width: auto; margin-right: 8px; }
        
        /* Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .button-group { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn-primary { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            color: #000; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 25px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 1.1rem;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4); }
        
        .btn-secondary { 
            background: linear-gradient(45deg, #666, #888); 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 25px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 1.1rem;
        }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        
        .btn-refresh { 
            background: linear-gradient(45deg, #4169E1, #1E90FF); 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 25px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 1.1rem;
        }
        
        /* ÎåÄÍ∏∞Ïã§ Ïä§ÌÉÄÏùº */
        .waiting-room { max-width: 600px; margin: 0 auto; }
        .room-info { text-align: center; background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 2px solid #333; }
        .room-info h3 { color: #FFD700; font-size: 1.8rem; margin-bottom: 10px; }
        .room-details { color: #ccc; font-size: 1rem; }
        
        .players-list { background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 2px solid #333; }
        .players-list h4 { color: #FFD700; text-align: center; margin-bottom: 15px; font-size: 1.3rem; }
        
        .player-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #2a2a3e; 
            padding: 12px 20px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            border: 2px solid #444;
        }
        .player-name { color: white; font-weight: bold; }
        .player-status { 
            padding: 5px 15px; 
            border-radius: 15px; 
            font-size: 0.9rem; 
            font-weight: bold;
        }
        .player-status.ready { background: #32CD32; color: white; }
        .player-status.waiting { background: #FFA500; color: white; }
        
        .ready-section { text-align: center; margin: 30px 0; }
        .btn-ready { 
            background: linear-gradient(45deg, #32CD32, #228B22); 
            color: white; 
            border: none; 
            padding: 20px 40px; 
            border-radius: 30px; 
            font-size: 1.3rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        .btn-ready:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(50, 205, 50, 0.4); }
        .btn-ready.ready { background: linear-gradient(45deg, #FF6347, #DC143C); }
        
        /* Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ */
        .countdown { margin-top: 20px; }
        .countdown-number { font-size: 4rem; color: #FFD700; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .countdown-text { font-size: 1.2rem; color: #ccc; }
        
        /* Î∞∞ÌãÄ Í≤åÏûÑ ÌôîÎ©¥ */
        .battle-game { position: relative; }
        .game-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            border: 2px solid #333;
        }
        
        .time-left { text-align: center; }
        .timer-text { display: block; color: #ccc; font-size: 0.9rem; margin-bottom: 5px; }
        .timer-number { 
            font-size: 2.5rem; 
            color: #FFD700; 
            font-weight: bold; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .timer-number.warning { color: #FF6347; animation: pulse 1s infinite; }
        
        .current-score { text-align: center; font-size: 2rem; color: #32CD32; font-weight: bold; }
        
        .question-section { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 30px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            text-align: center; 
            border: 2px solid #333;
        }
        .question-number { color: #FFD700; font-size: 1.1rem; margin-bottom: 15px; font-weight: bold; }
        .question-text { color: white; font-size: 1.4rem; line-height: 1.6; }
        
        .battle-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .battle-option-btn { 
            background: linear-gradient(135deg, #2a2a3e, #1a1a2e); 
            color: white; 
            border: 2px solid #444; 
            padding: 20px; 
            border-radius: 15px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 1.1rem; 
            font-weight: bold;
        }
        .battle-option-btn:hover { 
            border-color: #FFD700; 
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); 
            transform: translateY(-3px); 
        }
        .battle-option-btn.correct { background: linear-gradient(135deg, #32CD32, #228B22); border-color: #32CD32; }
        .battle-option-btn.incorrect { background: linear-gradient(135deg, #FF6347, #DC143C); border-color: #FF6347; }
        
        .battle-progress { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            border: 2px solid #333;
        }
        .progress-bar { 
            width: 100%; 
            height: 10px; 
            background: #444; 
            border-radius: 5px; 
            overflow: hidden; 
            margin-bottom: 10px;
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(45deg, #32CD32, #228B22); 
            transition: width 0.3s ease;
        }
        .progress-text { text-align: center; color: #ccc; font-size: 1rem; }
        
        /* Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ */
        .live-ranking { 
            position: fixed; 
            right: 20px; 
            top: 50%; 
            transform: translateY(-50%); 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 20px; 
            border-radius: 15px; 
            border: 2px solid #333; 
            width: 200px;
            z-index: 1000;
        }
        .live-ranking h4 { color: #FFD700; text-align: center; margin-bottom: 15px; font-size: 1.1rem; }
        
        .rank-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid #444; 
            color: white; 
            font-size: 0.9rem;
        }
        .rank-item:last-child { border-bottom: none; }
        .rank-item.me { background: rgba(255, 215, 0, 0.2); padding: 8px; border-radius: 5px; }
        
        /* Í≤∞Í≥º ÌôîÎ©¥ */
        .battle-result { max-width: 600px; margin: 0 auto; }
        .result-header { text-align: center; margin-bottom: 30px; }
        
        .final-ranking { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            border: 2px solid #333;
        }
        .final-ranking h4 { color: #FFD700; text-align: center; margin-bottom: 20px; font-size: 1.3rem; }
        
        .ranking-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 10px; 
            background: #2a2a3e;
        }
        .ranking-item.first { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
        .ranking-item.second { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: #000; }
        .ranking-item.third { background: linear-gradient(135deg, #CD7F32, #B8860B); color: white; }
        
        .rank-position { font-size: 1.5rem; font-weight: bold; width: 40px; text-align: center; }
        .rank-player { flex: 1; margin: 0 15px; }
        .rank-player-name { font-weight: bold; font-size: 1.1rem; }
        .rank-player-stats { font-size: 0.9rem; opacity: 0.8; }
        .rank-score { font-size: 1.2rem; font-weight: bold; }
        
        .my-result { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            border: 2px solid #FFD700;
        }
        .my-result h4 { color: #FFD700; text-align: center; margin-bottom: 20px; font-size: 1.3rem; }
        
        .result-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .result-stats .stat-item { 
            text-align: center; 
            background: #2a2a3e; 
            padding: 15px; 
            border-radius: 10px;
        }
        .result-stats .stat-label { display: block; color: #ccc; font-size: 0.9rem; margin-bottom: 5px; }
        .result-stats .stat-value { display: block; color: white; font-size: 1.5rem; font-weight: bold; }
        
        .rewards { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            border: 2px solid #32CD32;
        }
        .rewards h4 { color: #32CD32; text-align: center; margin-bottom: 20px; font-size: 1.3rem; }
        
        .reward-item { 
            display: flex; 
            align-items: center; 
            padding: 10px; 
            background: #2a2a3e; 
            border-radius: 10px; 
            margin-bottom: 10px;
        }
        .reward-icon { font-size: 2rem; margin-right: 15px; }
        .reward-text { color: white; font-weight: bold; }
        
        /* Î∞∞ÌãÄ ÌÜµÍ≥Ñ */
        .rank-info { text-align: center; margin-bottom: 30px; }
        .current-rank { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 30px; 
            border-radius: 20px; 
            border: 2px solid #333;
        }
        .rank-badge { 
            display: inline-block; 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            color: #000; 
            padding: 10px 25px; 
            border-radius: 25px; 
            font-size: 1.3rem; 
            font-weight: bold; 
            margin-bottom: 15px;
        }
        .rank-points { color: #ccc; font-size: 1.1rem; margin-bottom: 15px; }
        .rank-progress { width: 100%; max-width: 300px; margin: 0 auto; }
        .rank-progress-bar { 
            width: 100%; 
            height: 12px; 
            background: #444; 
            border-radius: 6px; 
            overflow: hidden;
        }
        .rank-progress-fill { 
            height: 100%; 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            transition: width 0.3s ease;
        }
        
        .battle-history { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            padding: 20px; 
            border-radius: 15px; 
            border: 2px solid #333;
        }
        .battle-history h4 { color: #FFD700; text-align: center; margin-bottom: 20px; font-size: 1.3rem; }
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Í≥µÍ∞úÎ∞© Î™©Î°ù */
        .room-item { 
            background: #2a2a3e; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 15px; 
            border: 2px solid #444; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        .room-item:hover { border-color: #FFD700; box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
        
        .room-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .room-name { color: #FFD700; font-size: 1.2rem; font-weight: bold; }
        .room-players { color: #32CD32; font-weight: bold; }
        
        .room-info-line { color: #ccc; font-size: 0.9rem; }
        
        /* ÏòàÏÅú Ï∞∏Í∞Ä Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .btn-join {
            background: linear-gradient(45deg, #32CD32, #228B22) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 25px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 15px rgba(50, 205, 50, 0.3) !important;
            font-size: 1rem !important;
            min-width: 80px !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .btn-join:hover {
            transform: translateY(-2px) scale(1.05) !important;
            box-shadow: 0 8px 25px rgba(50, 205, 50, 0.4) !important;
            background: linear-gradient(45deg, #228B22, #32CD32) !important;
        }
        
        .btn-join:active {
            transform: translateY(0px) scale(0.98) !important;
        }
        
        .btn-join::before {
            content: 'üéÆ' !important;
            margin-right: 8px !important;
        }
        
        .btn-join::after {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            width: 0 !important;
            height: 0 !important;
            background: rgba(255, 255, 255, 0.3) !important;
            border-radius: 50% !important;
            transform: translate(-50%, -50%) !important;
            transition: width 0.3s, height 0.3s !important;
        }
        
        .btn-join:hover::after {
            width: 120% !important;
            height: 120% !important;
        }
        
        /* Î∞© ÏïÑÏù¥ÌÖú Ï†ÑÏ≤¥ Ïä§ÌÉÄÏùº Í∞úÏÑ† */
        .room-item {
            background: linear-gradient(135deg, #1a1a2e, #16213e) !important;
            padding: 20px !important;
            border-radius: 15px !important;
            margin-bottom: 15px !important;
            border: 2px solid #444 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }
        
        .room-item:hover {
            border-color: #FFD700 !important;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3) !important;
            transform: translateY(-3px) !important;
        }
        
        .room-info {
            flex: 1 !important;
            color: white !important;
        }
        
        .room-info h4 {
            color: #FFD700 !important;
            font-size: 1.3rem !important;
            margin-bottom: 8px !important;
            font-weight: bold !important;
        }
        
        .room-details {
            color: #32CD32 !important;
            font-weight: bold !important;
            margin-bottom: 5px !important;
        }
        
        .room-host {
            color: #ccc !important;
            font-size: 0.9rem !important;
        }

        /* Î™®Î∞îÏùº Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .battle-menu-grid { grid-template-columns: 1fr; }
            .live-ranking { position: relative; right: auto; top: auto; transform: none; margin-top: 20px; width: 100%; }
            .game-header { flex-direction: column; gap: 15px; }
            .battle-options { grid-template-columns: 1fr; }
            .result-stats { grid-template-columns: repeat(2, 1fr); }
            .button-group { flex-direction: column; }
        }

    </style>
</head>
<body>
    <!-- Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
    <div id="login-overlay">
        <div id="login-modal">
            <h2>üêæ ÎèôÎ¨º ÏàòÏßë ÌïôÏäµ Í≤åÏûÑ üêæ</h2>
            <input type="text" id="player-name-input" class="login-input" placeholder="ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ" onkeypress="if(event.key==='Enter') document.getElementById('player-pin-input').focus()">
            <input type="password" id="player-pin-input" class="login-input" placeholder="4ÏûêÎ¶¨ Ïà´Ïûê PIN" maxlength="4" pattern="\d*" onkeypress="if(event.key==='Enter') handleLogin()">
            <button id="login-btn" class="login-btn" onclick="handleLogin()">Î°úÍ∑∏Ïù∏</button>
            <button id="signup-btn" class="login-btn" onclick="handleSignup()">ÏÉà ÌîåÎ†àÏù¥Ïñ¥ ÎßåÎì§Í∏∞</button>
            <p id="login-feedback"></p>
            <!-- Î™ÖÏòàÏùò Ï†ÑÎãπ -->
            <div id="hall-of-fame">
                <h3>üèÜ Î™ÖÏòàÏùò Ï†ÑÎãπ üèÜ</h3>
                <div id="fame-species" class="fame-entry">
                    <span class="trophy">ü•á</span> ÏµúÎã§ ÏàòÏßëÍ∞Ä: <span class="player-name">Í≥ÑÏÇ∞ Ï§ë...</span>
                </div>
                <div id="fame-level" class="fame-entry">
                    <span class="trophy">ü•á</span> ÏµúÍ≥† Î†àÎ≤® ÎèôÎ¨º: <span class="player-name">Í≥ÑÏÇ∞ Ï§ë...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="game-container" style="display: none;">
        <!-- Ìó§Îçî -->
        <div class="header">
            <h1>üêæ ÎèôÎ¨º ÏàòÏßë ÌïôÏäµ Í≤åÏûÑ üêæ</h1>
            
            <div class="nav-buttons">
                <div class="subject-selector">
                    <select id="subject-select" onchange="changeSubject()" class="subject-dropdown">
                        <option value="english">ÏòÅÏñ¥ üá¨üáß</option>
                        <option value="social">ÏÇ¨Ìöå üèõÔ∏è</option>
                        <option value="math">ÏàòÌïô üî¢</option>
                        <option value="general">ÏÉÅÏãù üß†</option>
                    </select>
                    <button class="nav-btn active" onclick="showPage('game', this)">ÎèôÎ¨º Ïû°Í∏∞</button>
                </div>
                <button class="nav-btn" onclick="showPage('battle', this)">Î∞∞ÌãÄÎ™®Îìú ü•ä</button>
                <button class="nav-btn" onclick="showPage('learning', this)">ÌïôÏäµ ÌÜµÍ≥Ñ üìà</button>
                <button class="nav-btn" onclick="showLearningReport()">Í∞úÏù∏ Î∂ÑÏÑù üéØ</button>
                <button class="nav-btn" onclick="showPage('synthesis', this)">ÎèôÎ¨º Ìï©ÏÑ± üß¨</button>
                <button class="nav-btn" onclick="showPage('market', this)">ÎèôÎ¨º ÏãúÏû• üè™</button>
                <button class="nav-btn" onclick="showPage('farm', this)">ÎÜçÏû• Íæ∏ÎØ∏Í∏∞ üè°</button>
                <button class="nav-btn" onclick="showPage('encyclopedia', this)">ÎèôÎ¨º ÎèÑÍ∞ê üìö</button>
                <button class="nav-btn" onclick="showPage('ranking', this)">Îû≠ÌÇπ üèÜ</button>
                <button class="nav-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ üö™</button>
            </div>

            <div class="user-info" id="user-info">
                <div class="current-user">ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥: <span id="current-user-name"></span></div>
            </div>

            <div class="game-stats" id="game-stats">
                <div class="stat-item">Î†àÎ≤® <span id="level">1</span></div>
                <div class="stat-item">Ï†êÏàò: <span id="score">0</span></div>
                <div class="stat-item">üí∞ ÏΩîÏù∏: <span id="coins">0</span></div>
                <div class="stat-item">ÎèôÎ¨º Ï¢ÖÎ•ò: <span id="species-count">0</span>Ï¢Ö</div>
                <div class="stat-item">Ï¥ù ÎèôÎ¨º: <span id="total-animals">0</span>ÎßàÎ¶¨</div>
            </div>
        </div>

        <!-- Í≤åÏûÑ ÌéòÏù¥ÏßÄ -->
        <div id="game-page" class="page active">
            <div class="game-content">
                <div class="english-quiz-section">
                    <h2>üá¨üáß ÏòÅÏñ¥ ÌÄ¥Ï¶à: ÎèôÎ¨º Ïû°Í∏∞!</h2>
                    
                    <!-- ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù -->
                    <div class="difficulty-selector">
                        <h3>ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù:</h3>
                        <div class="difficulty-buttons">
                            <button class="difficulty-btn active" data-level="1" onclick="selectDifficulty(1)">
                                Ï¥àÍ∏â üìù<br><small>+10Ï†ê</small>
                            </button>
                            <button class="difficulty-btn" data-level="2" onclick="selectDifficulty(2)">
                                Ï§ëÍ∏â üìö<br><small>+20Ï†ê</small>
                            </button>
                            <button class="difficulty-btn" data-level="3" onclick="selectDifficulty(3)">
                                Í≥†Í∏â üéì<br><small>+30Ï†ê</small>
                            </button>
                            <button class="difficulty-btn" data-level="review" onclick="selectDifficulty('review')">
                                Î≥µÏäµ üîÑ<br><small>ÌãÄÎ¶∞Î¨∏Ï†ú</small>
                            </button>
                        </div>
                    </div>

                    <div class="english-question-container">
                        <div class="english-question" id="english-question">ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌïòÍ≥† ÏãúÏûëÌïòÏÑ∏Ïöî!</div>
                        <span id="speak-button" class="speak-btn" title="Îã®Ïñ¥ Î∞úÏùå Îì£Í∏∞" style="display: none;">üîä</span>
                    </div>
                    
                    <!-- Îã®Ïñ¥ Ï∂úÏ≤ò ÌëúÏãú -->
                    <div class="word-source" id="word-source" style="display: none;">
                        <span class="source-badge ai-generated" id="source-badge">ü§ñ AI ÏÉùÏÑ±</span>
                    </div>
                    
                    <div class="english-options" id="english-options"></div>
                    <div class="feedback" id="feedback"></div>
                    
                    <!-- ÌïôÏäµ ÌÜµÍ≥Ñ -->
                    <div class="learning-stats" id="learning-stats" style="display: none;">
                        <h4>üìä ÌòÑÏû¨ Îã®Ïñ¥ ÌÜµÍ≥Ñ</h4>
                        <div class="stats-row">
                            <span>Ï†ïÎãµ: <strong id="word-correct">0</strong>Ìöå</span>
                            <span>Ïò§Îãµ: <strong id="word-incorrect">0</strong>Ìöå</span>
                            <span>Ï†ïÎãµÎ•†: <strong id="word-accuracy">0</strong>%</span>
                        </div>
                    </div>
                </div>

                <div class="collection-section">
                    <h2>üêæ ÎÇ¥ ÎèôÎ¨º Ïª¨Î†âÏÖò</h2>
                    <p class="collection-hint">üí° ÎèôÎ¨ºÏùÑ ÌÅ¥Î¶≠Ìï¥ÏÑú ÏàòÌïô Î¨∏Ï†úÎ°ú Î†àÎ≤®ÏóÖ ÏãúÏºúÏöî!</p>
                    <div class="animal-grid" id="animal-collection"></div>
                </div>
            </div>
        </div>
        
        <!-- Î∞∞ÌãÄÎ™®Îìú ÌéòÏù¥ÏßÄ -->
        <div id="battle-page" class="page">
            <div class="battle-container">
                <h2>ü•ä Î∞∞ÌãÄÎ™®Îìú</h2>
                
                <!-- Î∞∞ÌãÄ ÏÉÅÌÉúÎ≥Ñ ÌôîÎ©¥ -->
                
                <!-- Î©îÏù∏ Î©îÎâ¥ -->
                <div id="battle-menu" class="battle-screen active">
                    <div class="battle-menu-grid">
                        <div class="battle-option" onclick="showCreateRoomModal()">
                            <div class="battle-icon">üè†</div>
                            <h3>Î∞© ÎßåÎì§Í∏∞</h3>
                            <p>ÏÉàÎ°úÏö¥ Î∞∞ÌãÄ Î∞©ÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§</p>
                        </div>
                        <div class="battle-option" onclick="showJoinRoomModal()">
                            <div class="battle-icon">üö™</div>
                            <h3>Î∞© Ï∞∏Í∞Ä</h3>
                            <p>ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥ Î∞©Ïóê Ï∞∏Í∞ÄÌï©ÎãàÎã§</p>
                        </div>
                        <div class="battle-option" onclick="showPublicRooms()">
                            <div class="battle-icon">üåê</div>
                            <h3>Í≥µÍ∞úÎ∞© Î™©Î°ù</h3>
                            <p>Ï∞∏Í∞Ä Í∞ÄÎä•Ìïú Í≥µÍ∞úÎ∞©ÏùÑ Ï∞æÏäµÎãàÎã§</p>
                        </div>
                        <div class="battle-option" onclick="showBattleStats()">
                            <div class="battle-icon">üèÜ</div>
                            <h3>Î∞∞ÌãÄ ÌÜµÍ≥Ñ</h3>
                            <p>ÎÇòÏùò Î∞∞ÌãÄ Ï†ÑÏ†ÅÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§</p>
                        </div>
                    </div>
                </div>

                <!-- Î∞© ÏÉùÏÑ± ÌôîÎ©¥ -->
                <div id="create-room-screen" class="battle-screen">
                    <div class="room-setup">
                        <h3>üè† ÏÉà Î∞∞ÌãÄÎ∞© ÎßåÎì§Í∏∞</h3>
                        <div class="setup-form">
                            <div class="form-group">
                                <label>Î∞© Ïù¥Î¶Ñ</label>
                                <input type="text" id="room-name-input" placeholder="Î∞∞ÌãÄÎ∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="20">
                            </div>
                            <div class="form-group">
                                <label>Í≥ºÎ™© ÏÑ†ÌÉù</label>
                                <select id="battle-subject-select">
                                    <option value="english">ÏòÅÏñ¥ üá¨üáß</option>
                                    <option value="social">ÏÇ¨Ìöå üèõÔ∏è</option>
                                    <option value="math">ÏàòÌïô üî¢</option>
                                    <option value="general">ÏÉÅÏãù üß†</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÎÇúÏù¥ÎèÑ</label>
                                <select id="battle-level-select">
                                    <option value="1">Level 1 (Ïâ¨ÏõÄ)</option>
                                    <option value="2">Level 2 (Î≥¥ÌÜµ)</option>
                                    <option value="3">Level 3 (Ïñ¥Î†§ÏõÄ)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÏµúÎåÄ Ïù∏Ïõê</label>
                                <select id="max-players-select">
                                    <option value="2">2Î™Ö</option>
                                    <option value="4" selected>4Î™Ö</option>
                                    <option value="6">6Î™Ö</option>
                                    <option value="8">8Î™Ö</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Í≥µÍ∞ú ÏÑ§Ï†ï</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="room-type" value="public" checked> Í≥µÍ∞úÎ∞©</label>
                                    <label><input type="radio" name="room-type" value="private"> ÎπÑÍ≥µÍ∞úÎ∞©</label>
                                </div>
                            </div>
                            <div class="button-group">
                                <button class="btn-secondary" onclick="showBattleMenu()">Ï∑®ÏÜå</button>
                                <button class="btn-primary" onclick="createBattleRoom()">Î∞© ÎßåÎì§Í∏∞</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Î∞© Ï∞∏Í∞Ä ÌôîÎ©¥ -->
                <div id="join-room-screen" class="battle-screen">
                    <div class="join-room-form">
                        <h3>üö™ Î∞© Ï∞∏Í∞ÄÌïòÍ∏∞</h3>
                        <div class="code-input-section">
                            <label>ÏûÖÏû• ÏΩîÎìú (6ÏûêÎ¶¨)</label>
                            <input type="text" id="room-code-input" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                            <div class="button-group">
                                <button class="btn-secondary" onclick="showBattleMenu()">Ï∑®ÏÜå</button>
                                <button class="btn-primary" onclick="joinBattleRoom()">Ï∞∏Í∞ÄÌïòÍ∏∞</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Í≥µÍ∞úÎ∞© Î™©Î°ù -->
                <div id="public-rooms-screen" class="battle-screen">
                    <div class="public-rooms-list">
                        <h3>üåê Í≥µÍ∞úÎ∞© Î™©Î°ù</h3>
                        <div class="rooms-container" id="public-rooms-container">
                            <div class="loading">Í≥µÍ∞úÎ∞©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                        </div>
                        <div class="button-group">
                            <button class="btn-secondary" onclick="showBattleMenu()">Îí§Î°úÍ∞ÄÍ∏∞</button>
                            <button class="btn-refresh" onclick="refreshPublicRooms()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                        </div>
                    </div>
                </div>

                <!-- ÎåÄÍ∏∞Ïã§ -->
                <div id="waiting-room-screen" class="battle-screen">
                    <div class="waiting-room">
                        <div class="room-info">
                            <h3 id="current-room-name">Î∞∞ÌãÄÎ∞©</h3>
                            <div class="room-details">
                                <span id="room-subject-info">ÏàòÌïô</span> | 
                                <span id="room-level-info">Level 1</span> | 
                                <span id="room-code-info">Î∞© ÏΩîÎìú: 123456</span>
                            </div>
                        </div>
                        
                        <div class="players-list">
                            <h4>Ï∞∏Í∞ÄÏûê Î™©Î°ù</h4>
                            <div id="players-container"></div>
                        </div>
                        
                        <div class="ready-section">
                            <button id="ready-button" class="btn-ready" onclick="toggleReady()">Ï§ÄÎπÑ ÏôÑÎ£å</button>
                            <div class="countdown" id="game-countdown" style="display:none;">
                                <div class="countdown-number">3</div>
                                <div class="countdown-text">Í≤åÏûÑ ÏãúÏûëÍπåÏßÄ</div>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn-secondary" onclick="leaveBattleRoom()">Î∞© ÎÇòÍ∞ÄÍ∏∞</button>
                        </div>
                    </div>
                </div>

                <!-- Î∞∞ÌãÄ Í≤åÏûÑ ÌôîÎ©¥ -->
                <div id="battle-game-screen" class="battle-screen">
                    <div class="battle-game">
                        <div class="game-header">
                            <div class="time-left">
                                <span class="timer-text">ÎÇ®ÏùÄ ÏãúÍ∞Ñ</span>
                                <span class="timer-number" id="battle-timer">60</span>
                            </div>
                            <div class="current-score">
                                <span id="battle-current-score">0</span>Ï†ê
                            </div>
                        </div>
                        
                        <div class="question-section">
                            <div class="question-number">Î¨∏Ï†ú <span id="battle-question-number">1</span></div>
                            <div class="question-text" id="battle-question-text">Î¨∏Ï†úÍ∞Ä Î°úÎî©Ï§ëÏûÖÎãàÎã§...</div>
                        </div>
                        
                        <div class="battle-options" id="battle-options-container">
                            <!-- ÏÑ†ÌÉùÏßÄÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
                        </div>
                        
                        <div class="battle-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="battle-progress-fill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="battle-correct-count">0</span>Í∞ú Ï†ïÎãµ / 
                                <span id="battle-total-attempts">0</span>Í∞ú ÏãúÎèÑ
                            </div>
                        </div>
                        
                        <!-- Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ (Ïö∞Ï∏° ÏÇ¨Ïù¥ÎìúÎ∞î) -->
                        <div class="live-ranking">
                            <h4>Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ</h4>
                            <div id="live-ranking-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Í≤∞Í≥º ÌôîÎ©¥ -->
                <div id="battle-result-screen" class="battle-screen">
                    <div class="battle-result">
                        <div class="result-header">
                            <h3>üèÜ Î∞∞ÌãÄ Í≤∞Í≥º</h3>
                        </div>
                        
                        <div class="final-ranking">
                            <h4>ÏµúÏ¢Ö ÏàúÏúÑ</h4>
                            <div id="final-ranking-list"></div>
                        </div>
                        
                        <div class="my-result">
                            <h4>ÎÇ¥ ÏÑ±Ï†Å</h4>
                            <div class="result-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ÏàúÏúÑ</span>
                                    <span class="stat-value" id="my-rank">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Ï†ïÎãµ Ïàò</span>
                                    <span class="stat-value" id="my-correct">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Ï†ïÎãµÎ•†</span>
                                    <span class="stat-value" id="my-accuracy">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ÌöçÎìù Ï†êÏàò</span>
                                    <span class="stat-value" id="my-points">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rewards">
                            <h4>Î≥¥ÏÉÅ</h4>
                            <div id="battle-rewards"></div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn-secondary" onclick="showBattleMenu()">Î©îÏù∏ÏúºÎ°ú</button>
                            <button class="btn-primary" onclick="playAgain()">Îã§Ïãú ÌïòÍ∏∞</button>
                        </div>
                    </div>
                </div>

                <!-- Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÌôîÎ©¥ -->
                <div id="battle-stats-screen" class="battle-screen">
                    <div class="battle-stats">
                        <h3>üèÜ ÎÇ¥ Î∞∞ÌãÄ ÌÜµÍ≥Ñ</h3>
                        
                        <div class="rank-info">
                            <div class="current-rank">
                                <div class="rank-badge" id="current-rank-badge">Î∏åÎ°†Ï¶à</div>
                                <div class="rank-points">
                                    <span id="current-points">0</span> / <span id="next-rank-points">100</span> ÏäπÏ†ê
                                </div>
                                <div class="rank-progress">
                                    <div class="rank-progress-bar">
                                        <div class="rank-progress-fill" id="rank-progress-fill"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="battle-history">
                            <h4>Ï†ÑÏ†Å</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="total-battles">0</div>
                                    <div class="stat-label">Ï¥ù Í≤åÏûÑ</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="battle-wins">0</div>
                                    <div class="stat-label">ÏäπÎ¶¨</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="battle-winrate">0%</div>
                                    <div class="stat-label">ÏäπÎ•†</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="battle-points">0</div>
                                    <div class="stat-label">ÏäπÏ†ê</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn-secondary" onclick="showBattleMenu()">Îí§Î°úÍ∞ÄÍ∏∞</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÌïôÏäµ ÌÜµÍ≥Ñ ÌéòÏù¥ÏßÄ -->
        <div id="learning-page" class="page">
            <div class="learning-container">
                <h2>üìà ÎÇòÏùò ÏòÅÏñ¥ ÌïôÏäµ ÌÜµÍ≥Ñ</h2>
                
                <!-- Ï†ÑÏ≤¥ ÌïôÏäµ ÌÜµÍ≥Ñ -->
                <div class="overall-stats">
                    <h3>üìä Ï†ÑÏ≤¥ ÌïôÏäµ ÌòÑÌô©</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-words-learned">0</div>
                            <div class="stat-label">ÌïôÏäµÌïú Îã®Ïñ¥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-correct">0</div>
                            <div class="stat-label">Ï¥ù Ï†ïÎãµÏàò</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-accuracy">0%</div>
                            <div class="stat-label">Ï†ÑÏ≤¥ Ï†ïÎãµÎ•†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="mastered-words">0</div>
                            <div class="stat-label">ÏôÑÏ†Ñ ÌïôÏäµ</div>
                        </div>
                    </div>
                </div>
                
                <!-- Ï∑®ÏïΩ Îã®Ïñ¥ Î™©Î°ù -->
                <div class="weak-words-section">
                    <h3>üéØ Î≥µÏäµÏù¥ ÌïÑÏöîÌïú Îã®Ïñ¥Îì§</h3>
                    <div class="weak-words-grid" id="weak-words-grid">
                        <p class="no-data">Î≥µÏäµÏù¥ ÌïÑÏöîÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§. Îçî ÎßéÏùÄ Î¨∏Ï†úÎ•º ÌíÄÏñ¥Î≥¥ÏÑ∏Ïöî!</p>
                    </div>
                </div>
                
                <!-- Ïö∞Ïàò Îã®Ïñ¥ Î™©Î°ù -->
                <div class="strong-words-section">
                    <h3>‚≠ê Ïûò ÏïåÍ≥† ÏûàÎäî Îã®Ïñ¥Îì§</h3>
                    <div class="strong-words-grid" id="strong-words-grid">
                        <p class="no-data">ÏïÑÏßÅ ÏôÑÏ†ÑÌûà ÌïôÏäµÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÎèôÎ¨º Ìï©ÏÑ± ÌéòÏù¥ÏßÄ -->
        <div id="synthesis-page" class="page">
            <div class="synthesis-container">
                <h2>üß¨ ÎèôÎ¨º Ìï©ÏÑ± Ïó∞Íµ¨ÏÜå</h2>
                <div class="synthesis-grid" id="synthesis-grid"></div>
            </div>
        </div>
        
        <!-- ÏãúÏû• ÌéòÏù¥ÏßÄ -->
        <div id="market-page" class="page">
            <div class="market-container">
                <h2>üè™ ÎèôÎ¨º ÏãúÏû•</h2>
                <div class="market-sell-section">
                    <h3>ÎÇ¥ ÎèôÎ¨º ÌåêÎß§ÌïòÍ∏∞</h3>
                    <select id="sell-animal-select"></select>
                    <input type="number" id="sell-price-input" placeholder="ÌåêÎß§ Í∞ÄÍ≤© (ÏΩîÏù∏)">
                    <button class="nav-btn" onclick="sellAnimal()">ÌåêÎß§ Îì±Î°ù</button>
                </div>
                <h3>ÌåêÎß§ Ï§ëÏù∏ ÎèôÎ¨º Î™©Î°ù</h3>
                <div class="market-table-container">
                    <table class="market-table">
                        <thead>
                            <tr>
                                <th>ÎèôÎ¨º</th>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>Î†àÎ≤®</th>
                                <th>ÌåêÎß§Ïûê</th>
                                <th>Í∞ÄÍ≤©(ü™ô)</th>
                                <th>ÎÇ®ÏùÄ ÏãúÍ∞Ñ</th>
                                <th>Íµ¨Îß§</th>
                            </tr>
                        </thead>
                        <tbody id="market-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ÎÜçÏû• Íæ∏ÎØ∏Í∏∞ ÌéòÏù¥ÏßÄ -->
        <div id="farm-page" class="page">
            <div class="farm-page-container">
                <div class="farm-controls">
                    <h3>üå≥ ÏÉÅÏ†ê üí∞</h3>
                    <div class="shop-grid" id="shop-grid"></div>
                    <hr style="margin: 20px 0;">
                    <h3>üéí Î≥¥Í¥ÄÌï®</h3>
                    <div class="inventory-grid" id="inventory-grid"></div>
                </div>
                <div class="farm-area">
                    <div class="farm-grid" id="farm-grid"></div>
                </div>
            </div>
        </div>
        
        <!-- ÎèôÎ¨º ÎèÑÍ∞ê ÌéòÏù¥ÏßÄ -->
        <div id="encyclopedia-page" class="page">
            <div class="encyclopedia-container">
                <h2>üìö ÎèôÎ¨º ÎèÑÍ∞ê</h2>
                <div class="encyclopedia-progress">
                    ÏàòÏßëÎ•†: <span id="collection-progress">0 / 105</span> Ï¢Ö
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar-fill"></div>
                    </div>
                </div>
                <div class="encyclopedia-grid" id="encyclopedia-grid"></div>
            </div>
        </div>

        <!-- Îû≠ÌÇπ ÌéòÏù¥ÏßÄ -->
        <div id="ranking-page" class="page">
            <div class="ranking-container">
                <h2>üèÜ Ï†ÑÏ≤¥ Îû≠ÌÇπ (Ï†êÏàò Í∏∞Ï§Ä)</h2>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>ÏàúÏúÑ</th>
                            <th>Ïù¥Î¶Ñ</th>
                            <th>Ï†êÏàò</th>
                            <th>Î†àÎ≤®</th>
                            <th>ÎèôÎ¨º Ï¢ÖÎ•ò</th>
                            <th>ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ</th>
                            <th>ÎÜçÏû• Î∞©Î¨∏</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- ÏàòÌïô Î¨∏Ï†ú Î™®Îã¨ -->
    <div id="math-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMathModal()">&times;</span>
            <h3>üßÆ ÎèôÎ¨º Î†àÎ≤®ÏóÖ!</h3>
            <div id="math-question">5 + 3 = ?</div>
            <input type="number" id="math-answer-input" placeholder="Ï†ïÎãµÏùÄ?">
            <br>
            <button id="math-submit-btn">ÌôïÏù∏</button>
            <div id="math-feedback"></div>
        </div>
    </div>
    
    <!-- AI Ïù¥ÏïºÍ∏∞ Î™®Îã¨ -->
    <div id="story-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeStoryModal()">&times;</span>
            <h3 id="story-modal-title">ÎèôÎ¨º Ïù¥ÏïºÍ∏∞</h3>
            <div id="story-content-area">
                <div id="story-loading" style="display: none;">
                    <p>Ïù¥ÏïºÍ∏∞Î•º ÎßåÎì§Í≥† ÏûàÏñ¥Ïöî... Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî! üìñ</p>
                    <div class="spinner"></div>
                </div>
                <p id="story-text"></p>
            </div>
        </div>
    </div>

    <!-- ÎÜçÏû• Î∞©Î¨∏ Î™®Îã¨ -->
    <div id="farm-visit-modal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <span class="close-btn" onclick="closeFarmVisitModal()">&times;</span>
            <h3 id="visit-farm-title">üè° ÎÜçÏû• Î∞©Î¨∏</h3>
            <div style="margin: 15px 0; text-align: center;">
                <span id="farm-owner-info" style="background: linear-gradient(45deg, #FF69B4, #FFB6C1); color: white; padding: 8px 16px; border-radius: 15px; font-weight: bold;"></span>
            </div>
            <div style="background: linear-gradient(to bottom, #a8e063, #56ab2f); padding: 20px; border-radius: 15px; margin-top: 20px;">
                <div id="visit-farm-grid" class="farm-grid" style="pointer-events: none;"></div>
            </div>
            <div style="text-align: center; margin-top: 15px; color: #666; font-style: italic;">
                üí° Îã§Î•∏ ÏÇ¨Ïö©ÏûêÏùò ÎÜçÏû•ÏùÄ Íµ¨Í≤ΩÎßå Í∞ÄÎä•Ìï©ÎãàÎã§
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, writeBatch, runTransaction, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        let auth, db, functions;
        
        // ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•Ìï† Ï†ÑÏó≠ Î≥ÄÏàò (window.animalTypesÎ°ú ÏÉÅÎã® Ï†ïÏùòÎê®)

        // (loadAnimalsFromJSON Ìï®ÏàòÎäî ÏÉÅÎã®ÏúºÎ°ú Ïù¥ÎèôÎê®)
        
        // (getAllProfiles and updateHallOfFame Ìï®ÏàòÎì§ÏùÄ ÏÉÅÎã®ÏúºÎ°ú Ïù¥ÎèôÎê®)
        
        // ==================== Î∞∞ÌãÄÎ™®Îìú ÏãúÏä§ÌÖú ====================
        
        // Î∞∞ÌãÄ ÏÉÅÌÉú Í¥ÄÎ¶¨
        let battleState = {
            currentRoom: null,
            isInBattle: false,
            playerReady: false,
            battleTimer: null,
            currentQuestion: null,
            questionCount: 0,
            correctAnswers: 0,
            totalAttempts: 0,
            battleScore: 0,
            realtimeRanking: [],
            gameStartTime: null
        };
        
        // Î∞∞ÌãÄÎ™®Îìú Î©îÏù∏ ÌôîÎ©¥ ÌëúÏãú
        function showBattleMenu() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('battle-menu').classList.add('active');
        }
        
        // Î∞© ÏÉùÏÑ± Î™®Îã¨ ÌëúÏãú
        function showCreateRoomModal() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('create-room-screen').classList.add('active');
            document.getElementById('room-name-input').value = `${currentUserProfile.name}Ïùò Î∞∞ÌãÄÎ∞©`;
        }
        
        // Î∞© Ï∞∏Í∞Ä Î™®Îã¨ ÌëúÏãú
        function showJoinRoomModal() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('join-room-screen').classList.add('active');
            document.getElementById('room-code-input').value = '';
        }
        
        // Í≥µÍ∞úÎ∞© Î™©Î°ù ÌëúÏãú
        function showPublicRooms() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('public-rooms-screen').classList.add('active');
            refreshPublicRooms();
        }
        
        // Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÌôîÎ©¥ ÌëúÏãú
        function showBattleStats() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('battle-stats-screen').classList.add('active');
            updateBattleStats();
        }
        
        // Î∞∞ÌãÄ Î∞© ÏÉùÏÑ±
        async function createBattleRoom() {
            const roomName = document.getElementById('room-name-input').value.trim();
            const subject = document.getElementById('battle-subject-select').value;
            const level = document.getElementById('battle-level-select').value;
            const maxPlayers = parseInt(document.getElementById('max-players-select').value);
            const isPublic = document.querySelector('input[name="room-type"]:checked').value === 'public';
            
            if (!roomName) {
                alert('Î∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            try {
                // 6ÏûêÎ¶¨ ÎûúÎç§ Î∞© ÏΩîÎìú ÏÉùÏÑ±
                const roomCode = Math.floor(100000 + Math.random() * 900000).toString();
                
                const roomData = {
                    id: roomCode,
                    name: roomName,
                    host: currentUserProfile.name,
                    hostId: window.currentUserId,
                    subject: subject,
                    level: parseInt(level),
                    maxPlayers: maxPlayers,
                    currentPlayers: 1,
                    isPublic: isPublic,
                    status: 'waiting',
                    createdAt: Date.now(),
                    players: {
                        [window.currentUserId]: {
                            name: currentUserProfile.name,
                            ready: false,
                            score: 0,
                            joinedAt: Date.now()
                        }
                    }
                };
                
                // FirebaseÏóê Î∞© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                const roomRef = window.firebase.doc(window.firebase.db, 'battleRooms', roomCode);
                await window.firebase.setDoc(roomRef, roomData);
                
                // Î∞©Ïóê ÏûÖÏû•
                battleState.currentRoom = roomData;
                showWaitingRoom();
                
                console.log('Î∞∞ÌãÄ Î∞© ÏÉùÏÑ± ÏôÑÎ£å:', roomCode);
                
            } catch (error) {
                console.error('Î∞© ÏÉùÏÑ± Ïò§Î•ò:', error);
                alert('Î∞© ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }
        
        // Î∞∞ÌãÄ Î∞© Ï∞∏Í∞Ä
        async function joinBattleRoom() {
            const roomCode = document.getElementById('room-code-input').value.trim();
            
            if (roomCode.length !== 6 || !/^\d{6}$/.test(roomCode)) {
                alert('Ïò¨Î∞îÎ•∏ 6ÏûêÎ¶¨ Î∞© ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            try {
                const roomRef = window.firebase.doc(window.firebase.db, 'battleRooms', roomCode);
                const roomDoc = await window.firebase.getDoc(roomRef);
                
                if (!roomDoc.exists()) {
                    alert('Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Î∞© ÏΩîÎìúÏûÖÎãàÎã§!');
                    return;
                }
                
                const roomData = roomDoc.data();
                
                if (roomData.currentPlayers >= roomData.maxPlayers) {
                    alert('Î∞©Ïù¥ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§!');
                    return;
                }
                
                if (roomData.status !== 'waiting') {
                    alert('Ïù¥ÎØ∏ ÏãúÏûëÎêú Í≤åÏûÑÏûÖÎãàÎã§!');
                    return;
                }
                
                // Î∞©Ïóê ÌîåÎ†àÏù¥Ïñ¥ Ï∂îÍ∞Ä
                const updatedPlayers = {
                    ...roomData.players,
                    [window.currentUserId]: {
                        name: currentUserProfile.name,
                        ready: false,
                        score: 0,
                        joinedAt: Date.now()
                    }
                };
                
                await window.firebase.setDoc(roomRef, {
                    ...roomData,
                    currentPlayers: roomData.currentPlayers + 1,
                    players: updatedPlayers
                });
                
                battleState.currentRoom = {...roomData, players: updatedPlayers};
                showWaitingRoom();
                
                console.log('Î∞© Ï∞∏Í∞Ä ÏôÑÎ£å:', roomCode);
                
            } catch (error) {
                console.error('Î∞© Ï∞∏Í∞Ä Ïò§Î•ò:', error);
                alert('Î∞© Ï∞∏Í∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }
        
        // ÎåÄÍ∏∞Ïã§ ÌôîÎ©¥ ÌëúÏãú
        function showWaitingRoom() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('waiting-room-screen').classList.add('active');
            
            const room = battleState.currentRoom;
            document.getElementById('current-room-name').textContent = room.name;
            document.getElementById('room-subject-info').textContent = getSubjectName(room.subject);
            document.getElementById('room-level-info').textContent = `Level ${room.level}`;
            document.getElementById('room-code-info').textContent = `Î∞© ÏΩîÎìú: ${room.id}`;
            
            updatePlayersDisplay();
            
            // Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupRoomListener();
        }
        
        // ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updatePlayersDisplay() {
            const container = document.getElementById('players-container');
            const players = Object.values(battleState.currentRoom.players);
            
            container.innerHTML = players.map(player => `
                <div class="player-item ${player.ready ? 'ready' : ''}">
                    <span class="player-name">${player.name}</span>
                    <span class="player-status">${player.ready ? 'Ï§ÄÎπÑÏôÑÎ£å ‚úÖ' : 'ÎåÄÍ∏∞Ï§ë ‚è≥'}</span>
                </div>
            `).join('');
        }
        
        // Ï§ÄÎπÑ ÏÉÅÌÉú ÌÜ†Í∏Ä
        async function toggleReady() {
            if (!battleState.currentRoom) return;
            
            const newReadyState = !battleState.playerReady;
            battleState.playerReady = newReadyState;
            
            const button = document.getElementById('ready-button');
            button.textContent = newReadyState ? 'Ï§ÄÎπÑ Ï∑®ÏÜå' : 'Ï§ÄÎπÑ ÏôÑÎ£å';
            button.className = newReadyState ? 'btn-cancel' : 'btn-ready';
            
            try {
                const roomRef = window.firebase.doc(window.firebase.db, 'battleRooms', battleState.currentRoom.id);
                const updatedPlayers = {
                    ...battleState.currentRoom.players,
                    [window.currentUserId]: {
                        ...battleState.currentRoom.players[window.currentUserId],
                        ready: newReadyState
                    }
                };
                
                await window.firebase.setDoc(roomRef, {
                    ...battleState.currentRoom,
                    players: updatedPlayers
                });
                
                battleState.currentRoom.players = updatedPlayers;
                updatePlayersDisplay();
                
                // Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï§ÄÎπÑÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                checkAllPlayersReady();
                
            } catch (error) {
                console.error('Ï§ÄÎπÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                battleState.playerReady = !newReadyState;
                button.textContent = battleState.playerReady ? 'Ï§ÄÎπÑ Ï∑®ÏÜå' : 'Ï§ÄÎπÑ ÏôÑÎ£å';
            }
        }
        
        // Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥ Ï§ÄÎπÑ ÌôïÏù∏ Î∞è Í≤åÏûÑ ÏãúÏûë
        function checkAllPlayersReady() {
            const players = Object.values(battleState.currentRoom.players);
            const allReady = players.length >= 2 && players.every(p => p.ready);
            
            if (allReady && battleState.currentRoom.hostId === window.currentUserId) {
                startGameCountdown();
            }
        }
        
        // Í≤åÏûÑ ÏãúÏûë Ïπ¥Ïö¥Ìä∏Îã§Ïö¥
        function startGameCountdown() {
            const countdownEl = document.getElementById('game-countdown');
            const numberEl = countdownEl.querySelector('.countdown-number');
            countdownEl.style.display = 'block';
            
            let count = 3;
            numberEl.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    numberEl.textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    countdownEl.style.display = 'none';
                    startBattleGame();
                }
            }, 1000);
        }
        
        // Î∞∞ÌãÄ Í≤åÏûÑ ÏãúÏûë
        async function startBattleGame() {
            try {
                // Î∞© ÏÉÅÌÉúÎ•º 'playing'ÏúºÎ°ú Î≥ÄÍ≤Ω
                const roomRef = window.firebase.doc(window.firebase.db, 'battleRooms', battleState.currentRoom.id);
                await window.firebase.setDoc(roomRef, {
                    ...battleState.currentRoom,
                    status: 'playing',
                    gameStartTime: Date.now()
                });
                
                // Í≤åÏûÑ ÌôîÎ©¥ ÌëúÏãú
                document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
                document.getElementById('battle-game-screen').classList.add('active');
                
                // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                battleState.isInBattle = true;
                battleState.questionCount = 0;
                battleState.correctAnswers = 0;
                battleState.totalAttempts = 0;
                battleState.battleScore = 0;
                battleState.gameStartTime = Date.now();
                
                // 60Ï¥à ÌÉÄÏù¥Î®∏ ÏãúÏûë
                startBattleTimer();
                
                // Ï≤´ Î≤àÏß∏ Î¨∏Ï†ú Î°úÎìú
                await loadNextBattleQuestion();
                
            } catch (error) {
                console.error('Í≤åÏûÑ ÏãúÏûë Ïò§Î•ò:', error);
                alert('Í≤åÏûÑ ÏãúÏûëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Î∞∞ÌãÄ ÌÉÄÏù¥Î®∏ ÏãúÏûë
        function startBattleTimer() {
            let timeLeft = 60;
            const timerEl = document.getElementById('battle-timer');
            timerEl.textContent = timeLeft;
            
            battleState.battleTimer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(battleState.battleTimer);
                    endBattleGame();
                }
            }, 1000);
        }
        
        // Îã§Ïùå Î∞∞ÌãÄ Î¨∏Ï†ú Î°úÎìú
        async function loadNextBattleQuestion() {
            try {
                const room = battleState.currentRoom;
                const subject = room.subject;
                const level = room.level;
                
                // Í≥ºÎ™©Î≥Ñ Î¨∏Ï†ú Î°úÎìú
                let questionData;
                if (subject === 'english') {
                    questionData = await loadWordForDifficulty(level);
                } else {
                    const response = await fetch(`./subjects/${subject}/level${level}.json`);
                    const data = await response.json();
                    const randomIndex = Math.floor(Math.random() * data.length);
                    questionData = data[randomIndex];
                }
                
                battleState.currentQuestion = questionData;
                battleState.questionCount++;
                
                // ÌôîÎ©¥Ïóê Î¨∏Ï†ú ÌëúÏãú
                displayBattleQuestion(questionData);
                
            } catch (error) {
                console.error('Î¨∏Ï†ú Î°úÎìú Ïò§Î•ò:', error);
            }
        }
        
        // Î∞∞ÌãÄ Î¨∏Ï†ú ÌôîÎ©¥Ïóê ÌëúÏãú
        function displayBattleQuestion(questionData) {
            const room = battleState.currentRoom;
            
            document.getElementById('battle-question-number').textContent = battleState.questionCount;
            
            if (room.subject === 'english') {
                document.getElementById('battle-question-text').textContent = `"${questionData.word}" Ïùò ÎúªÏùÄ?`;
                
                const optionsContainer = document.getElementById('battle-options-container');
                optionsContainer.innerHTML = questionData.options.map((option, index) => `
                    <button class="battle-option-btn" onclick="selectBattleAnswer(${index})" data-index="${index}">
                        ${option}
                    </button>
                `).join('');
            } else {
                document.getElementById('battle-question-text').textContent = questionData.question;
                
                const optionsContainer = document.getElementById('battle-options-container');
                optionsContainer.innerHTML = questionData.options.map((option, index) => `
                    <button class="battle-option-btn" onclick="selectBattleAnswer(${index})" data-index="${index}">
                        ${option}
                    </button>
                `).join('');
            }
            
            // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
            updateBattleProgress();
        }
        
        // Î∞∞ÌãÄ ÎãµÏïà ÏÑ†ÌÉù
        async function selectBattleAnswer(selectedIndex) {
            if (!battleState.isInBattle || !battleState.currentQuestion) return;
            
            const question = battleState.currentQuestion;
            const isCorrect = selectedIndex === question.answer;
            
            battleState.totalAttempts++;
            
            if (isCorrect) {
                battleState.correctAnswers++;
                const timeBonus = Math.max(0, 60 - Math.floor((Date.now() - battleState.gameStartTime) / 1000));
                battleState.battleScore += 10 + Math.floor(timeBonus / 10);
            }
            
            // ÏÑ†ÌÉùÌïú Î≤ÑÌäº ÌëúÏãú
            const buttons = document.querySelectorAll('.battle-option-btn');
            buttons[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
            buttons.forEach(btn => btn.disabled = true);
            
            // Ïã§ÏãúÍ∞Ñ Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('battle-current-score').textContent = battleState.battleScore;
            updateBattleProgress();
            
            // FirebaseÏóê Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
            await updatePlayerScore();
            
            // 1Ï¥à ÌõÑ Îã§Ïùå Î¨∏Ï†ú
            setTimeout(() => {
                loadNextBattleQuestion();
            }, 1000);
        }
        
        // ÌîåÎ†àÏù¥Ïñ¥ Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
        async function updatePlayerScore() {
            try {
                const roomRef = window.firebase.doc(window.firebase.db, 'battleRooms', battleState.currentRoom.id);
                const updatedPlayers = {
                    ...battleState.currentRoom.players,
                    [window.currentUserId]: {
                        ...battleState.currentRoom.players[window.currentUserId],
                        score: battleState.battleScore,
                        correct: battleState.correctAnswers,
                        attempts: battleState.totalAttempts
                    }
                };
                
                await window.firebase.setDoc(roomRef, {
                    ...battleState.currentRoom,
                    players: updatedPlayers
                });
                
            } catch (error) {
                console.error('Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
            }
        }
        
        // Î∞∞ÌãÄ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
        function updateBattleProgress() {
            const accuracy = battleState.totalAttempts > 0 ? Math.round((battleState.correctAnswers / battleState.totalAttempts) * 100) : 0;
            const progressPercentage = Math.min(100, (battleState.totalAttempts / 20) * 100);
            
            document.getElementById('battle-progress-fill').style.width = `${progressPercentage}%`;
            document.getElementById('battle-correct-count').textContent = battleState.correctAnswers;
            document.getElementById('battle-total-attempts').textContent = battleState.totalAttempts;
        }
        
        // Î∞∞ÌãÄ Í≤åÏûÑ Ï¢ÖÎ£å
        function endBattleGame() {
            battleState.isInBattle = false;
            clearInterval(battleState.battleTimer);
            
            // Í≤∞Í≥º ÌôîÎ©¥ ÌëúÏãú
            showBattleResults();
        }
        
        // Î∞∞ÌãÄ Í≤∞Í≥º ÌëúÏãú
        function showBattleResults() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('battle-result-screen').classList.add('active');
            
            // ÏµúÏ¢Ö ÏàúÏúÑ Í≥ÑÏÇ∞ Î∞è ÌëúÏãú
            const players = Object.values(battleState.currentRoom.players);
            const sortedPlayers = players.sort((a, b) => (b.score || 0) - (a.score || 0));
            
            const rankingList = document.getElementById('final-ranking-list');
            rankingList.innerHTML = sortedPlayers.map((player, index) => `
                <div class="ranking-item ${player.name === currentUserProfile.name ? 'my-result' : ''}">
                    <span class="rank">${index + 1}ÏúÑ</span>
                    <span class="player-name">${player.name}</span>
                    <span class="score">${player.score || 0}Ï†ê</span>
                </div>
            `).join('');
            
            // ÎÇ¥ Í≤∞Í≥º ÌëúÏãú
            const myRank = sortedPlayers.findIndex(p => p.name === currentUserProfile.name) + 1;
            const accuracy = battleState.totalAttempts > 0 ? Math.round((battleState.correctAnswers / battleState.totalAttempts) * 100) : 0;
            
            document.getElementById('my-rank').textContent = `${myRank}ÏúÑ`;
            document.getElementById('my-correct').textContent = `${battleState.correctAnswers}Í∞ú`;
            document.getElementById('my-accuracy').textContent = `${accuracy}%`;
            document.getElementById('my-points').textContent = `${battleState.battleScore}Ï†ê`;
            
            // Î≥¥ÏÉÅ Í≥ÑÏÇ∞ Î∞è ÌëúÏãú
            calculateAndShowRewards(myRank, accuracy);
        }
        
        // Î≥¥ÏÉÅ Í≥ÑÏÇ∞ Î∞è ÌëúÏãú
        function calculateAndShowRewards(rank, accuracy) {
            let coinReward = 0;
            let battlePointsReward = 0;
            
            // ÏàúÏúÑÎ≥Ñ Î≥¥ÏÉÅ
            if (rank === 1) {
                coinReward += 50;
                battlePointsReward += 25;
            } else if (rank === 2) {
                coinReward += 30;
                battlePointsReward += 15;
            } else if (rank === 3) {
                coinReward += 20;
                battlePointsReward += 10;
            } else {
                coinReward += 10;
                battlePointsReward += 5;
            }
            
            // Ï†ïÌôïÎèÑ Î≥¥ÎÑàÏä§
            if (accuracy >= 80) {
                coinReward += 20;
                battlePointsReward += 10;
            } else if (accuracy >= 60) {
                coinReward += 10;
                battlePointsReward += 5;
            }
            
            // Í≤åÏûÑÏóê Î≥¥ÏÉÅ Ï†ÅÏö©
            if (gameState.coins !== undefined) {
                gameState.coins += coinReward;
            }
            if (gameState.battlePoints === undefined) {
                gameState.battlePoints = 0;
            }
            gameState.battlePoints += battlePointsReward;
            
            // Î≥¥ÏÉÅ ÌôîÎ©¥Ïóê ÌëúÏãú
            document.getElementById('battle-rewards').innerHTML = `
                <div class="reward-item">
                    <span class="reward-icon">ü™ô</span>
                    <span class="reward-text">ÏΩîÏù∏ +${coinReward}</span>
                </div>
                <div class="reward-item">
                    <span class="reward-icon">‚öîÔ∏è</span>
                    <span class="reward-text">ÏäπÏ†ê +${battlePointsReward}</span>
                </div>
            `;
            
            // ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            saveCurrentUserData();
        }
        
        // Î∞© ÎÇòÍ∞ÄÍ∏∞
        async function leaveBattleRoom() {
            if (!battleState.currentRoom) return;
            
            try {
                const roomRef = window.firebase.doc(window.firebase.db, 'battleRooms', battleState.currentRoom.id);
                const updatedPlayers = {...battleState.currentRoom.players};
                delete updatedPlayers[window.currentUserId];
                
                const newPlayerCount = Object.keys(updatedPlayers).length;
                
                if (newPlayerCount === 0) {
                    // Î∞©Ïóê ÏïÑÎ¨¥ÎèÑ ÏóÜÏúºÎ©¥ Î∞© ÏÇ≠Ï†ú
                    await window.firebase.deleteDoc(roomRef);
                } else {
                    // ÌîåÎ†àÏù¥Ïñ¥ Ï†úÍ±∞
                    await window.firebase.setDoc(roomRef, {
                        ...battleState.currentRoom,
                        currentPlayers: newPlayerCount,
                        players: updatedPlayers
                    });
                }
                
                battleState.currentRoom = null;
                battleState.playerReady = false;
                showBattleMenu();
                
            } catch (error) {
                console.error('Î∞© ÎÇòÍ∞ÄÍ∏∞ Ïò§Î•ò:', error);
                showBattleMenu();
            }
        }
        
        // Í≥µÍ∞úÎ∞© ÏÉàÎ°úÍ≥†Ïπ®
        async function refreshPublicRooms() {
            try {
                const roomsCollection = window.firebase.collection(window.firebase.db, 'battleRooms');
                const querySnapshot = await window.firebase.getDocs(roomsCollection);
                
                const publicRooms = [];
                querySnapshot.forEach(doc => {
                    const room = doc.data();
                    if (room.isPublic && room.status === 'waiting' && room.currentPlayers < room.maxPlayers) {
                        publicRooms.push(room);
                    }
                });
                
                const container = document.getElementById('public-rooms-container');
                
                if (publicRooms.length === 0) {
                    container.innerHTML = '<div class="no-rooms">Ï∞∏Í∞Ä Í∞ÄÎä•Ìïú Í≥µÍ∞úÎ∞©Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                } else {
                    container.innerHTML = publicRooms.map(room => `
                        <div class="room-item">
                            <div class="room-info">
                                <h4>${room.name}</h4>
                                <div class="room-details">
                                    ${getSubjectName(room.subject)} | Level ${room.level} | ${room.currentPlayers}/${room.maxPlayers}Î™Ö
                                </div>
                                <div class="room-host">Î∞©Ïû•: ${room.host}</div>
                            </div>
                            <button class="btn-join" onclick="joinPublicRoom('${room.id}')">Ï∞∏Í∞Ä</button>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Í≥µÍ∞úÎ∞© Î°úÎìú Ïò§Î•ò:', error);
                document.getElementById('public-rooms-container').innerHTML = '<div class="error">Í≥µÍ∞úÎ∞© Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }
        
        // Í≥µÍ∞úÎ∞© Ï∞∏Í∞Ä
        async function joinPublicRoom(roomCode) {
            document.getElementById('room-code-input').value = roomCode;
            await joinBattleRoom();
        }
        
        // Îã§Ïãú ÌïòÍ∏∞
        function playAgain() {
            showBattleMenu();
        }
        
        // Ïã§ÏãúÍ∞Ñ Î∞© ÏÉÅÌÉú Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupRoomListener() {
            if (!battleState.currentRoom) return;
            
            const roomRef = window.firebase.doc(window.firebase.db, 'battleRooms', battleState.currentRoom.id);
            
            // Firebase Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            window.firebase.onSnapshot(roomRef, (doc) => {
                if (doc.exists()) {
                    const updatedRoom = doc.data();
                    battleState.currentRoom = updatedRoom;
                    
                    if (document.getElementById('waiting-room-screen').classList.contains('active')) {
                        updatePlayersDisplay();
                    }
                } else {
                    // Î∞©Ïù¥ ÏÇ≠Ï†úÎê®
                    alert('Î∞©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    showBattleMenu();
                }
            });
        }
        
        // Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateBattleStats() {
            const battles = gameState.battleHistory || [];
            const wins = battles.filter(b => b.rank === 1).length;
            const totalBattles = battles.length;
            const winRate = totalBattles > 0 ? Math.round((wins / totalBattles) * 100) : 0;
            const battlePoints = gameState.battlePoints || 0;
            
            document.getElementById('total-battles').textContent = totalBattles;
            document.getElementById('battle-wins').textContent = wins;
            document.getElementById('battle-winrate').textContent = `${winRate}%`;
            document.getElementById('battle-points').textContent = battlePoints;
            
            // Îû≠ÌÅ¨ ÏãúÏä§ÌÖú
            const currentRank = calculateBattleRank(battlePoints);
            const nextRankPoints = getNextRankPoints(battlePoints);
            const progress = ((battlePoints % 100) / 100) * 100;
            
            document.getElementById('current-rank-badge').textContent = currentRank;
            document.getElementById('current-points').textContent = battlePoints;
            document.getElementById('next-rank-points').textContent = nextRankPoints;
            document.getElementById('rank-progress-fill').style.width = `${progress}%`;
        }
        
        // Îû≠ÌÅ¨ Í≥ÑÏÇ∞
        function calculateBattleRank(points) {
            if (points < 100) return 'Î∏åÎ°†Ï¶à';
            if (points < 300) return 'Ïã§Î≤Ñ';
            if (points < 600) return 'Í≥®Îìú';
            if (points < 1000) return 'ÌîåÎûòÌã∞ÎÑò';
            return 'Îã§Ïù¥ÏïÑÎ™¨Îìú';
        }
        
        // Îã§Ïùå Îû≠ÌÅ¨ÍπåÏßÄ ÌïÑÏöîÌïú ÏäπÏ†ê
        function getNextRankPoints(points) {
            if (points < 100) return 100;
            if (points < 300) return 300;
            if (points < 600) return 600;
            if (points < 1000) return 1000;
            return 2000;
        }
        
        // Í≥ºÎ™©Î™Ö Î≥ÄÌôò Ìó¨Ìçº
        function getSubjectName(subject) {
            const names = {
                'english': 'ÏòÅÏñ¥ üá¨üáß',
                'social': 'ÏÇ¨Ìöå üèõÔ∏è',
                'math': 'ÏàòÌïô üî¢',
                'general': 'ÏÉÅÏãù üß†'
            };
            return names[subject] || subject;
        }
        
        // Firebase Ï§ÄÎπÑ Ìï®ÏàòÎ•º Î®ºÏ†Ä Ï†ïÏùò
        window.onFirebaseReady = async function(user) {
            console.log("onFirebaseReady Ìò∏Ï∂úÎê®, user:", user);
            
            if (!user) {
                console.log("ÏÇ¨Ïö©Ïûê ÏóÜÏùå, Ïò§ÌîÑÎùºÏù∏ Î™®Îìú");
                const feedbackEl = document.getElementById('login-feedback');
                if (feedbackEl) {
                    feedbackEl.textContent = "ÌÅ¥ÎùºÏö∞Îìú Ïó∞Í≤∞ Ïã§Ìå®! Ïò§ÌîÑÎùºÏù∏ Î™®ÎìúÎ°ú Ïã§ÌñâÌï©ÎãàÎã§.";
                }
                return;
            }
            
            window.currentUserId = user.uid;
            console.log("ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê ID ÏÑ§Ï†ï:", window.currentUserId);
            
            try {
                console.log("ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏãúÏûë...");
                await window.loadAnimalsFromJSON();
                console.log("Î™ÖÏòàÏùò Ï†ÑÎãπ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...");
                await window.updateHallOfFame();
                console.log("Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
            } catch (error) {
                console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
            }
            
            console.log("Î°úÍ∑∏Ïù∏ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú");
            const overlayEl = document.getElementById('login-overlay');
            if (overlayEl) {
                overlayEl.style.display = 'flex';
            }
        }
        
        // Firebase Ï¥àÍ∏∞Ìôî
        try {
            const firebaseConfig = {
              apiKey: "AIzaSyC2JV9KsIZ-M1crdnnxLfxyaRtGS1Brtcc",
              authDomain: "animal-math-game-6eec2.firebaseapp.com",
              projectId: "animal-math-game-6eec2",
              storageBucket: "animal-math-game-6eec2.firebasestorage.app",
              messagingSenderId: "104144283045",
              appId: "1:104144283045:web:f0a387d83292a0d508744c",
              measurementId: "G-M63W08193X"
            };
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            functions = getFunctions(app);

            console.log("Firebase Ï¥àÍ∏∞Ìôî ÏÑ±Í≥µ");

            window.firebase = { auth, db, functions, doc, getDoc, setDoc, collection, getDocs, writeBatch, runTransaction, deleteDoc, onSnapshot, httpsCallable };

            onAuthStateChanged(auth, async (user) => {
                console.log("Auth ÏÉÅÌÉú Î≥ÄÍ≤Ω:", user ? "Î°úÍ∑∏Ïù∏Îê®" : "Î°úÍ∑∏ÏïÑÏõÉÎê®");
                if (user) {
                    console.log("Firebase Auth User:", user.uid);
                    window.onFirebaseReady(user);
                } else {
                     try {
                        console.log("ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ ÏãúÎèÑ...");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            const result = await signInAnonymously(auth);
                            console.log("ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:", result.user.uid);
                        }
                    } catch (error) {
                        console.error("ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ Ïã§Ìå®:", error);
                        alert("Firebase Ïù∏Ï¶ù Ïã§Ìå®: " + error.message);
                        window.onFirebaseReady(null);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", error);
            alert("Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®: " + error.message);
            window.onFirebaseReady(null);
        }
    </script>
    
    <script>
        // ==================== ÌïµÏã¨ Ìï®Ïàò Î®ºÏ†Ä Ï†ïÏùò ====================
        
        // showPage Ìï®Ïàò ÏµúÏö∞ÏÑ† Ï†ïÏùò (Í∞ÄÏû• Ï§ëÏöî!)
        window.showPage = function(pageName, element) {
            console.log('showPage Ìò∏Ï∂ú:', pageName);
            
            // Î™®Îì† ÌéòÏù¥ÏßÄ ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // Î™®Îì† ÎÑ§ÎπÑ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú ÌéòÏù¥ÏßÄ ÌôúÏÑ±Ìôî
            const targetPage = document.getElementById(pageName + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block';
                console.log('ÌéòÏù¥ÏßÄ ÌôúÏÑ±Ìôî:', pageName);
            } else {
                console.error('ÌéòÏù¥ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå:', pageName + '-page');
            }
            
            // ÏÑ†ÌÉùÎêú Î≤ÑÌäº ÌôúÏÑ±Ìôî
            if (element) {
                element.classList.add('active');
            }
            
            // Í≤åÏûÑ ÌÜµÍ≥ÑÏôÄ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú Í¥ÄÎ¶¨
            const gameStats = document.getElementById('game-stats');
            const userInfo = document.getElementById('user-info');
            
            if (gameStats && userInfo) {
                if (pageName === 'game' || pageName === 'farm') {
                    gameStats.style.display = 'flex';
                    userInfo.style.display = 'block';
                } else {
                    gameStats.style.display = 'none';
                    userInfo.style.display = 'block';
                }
            }
            
            // ÌäπÏ†ï ÌéòÏù¥ÏßÄÎ≥Ñ Ï¥àÍ∏∞Ìôî
            if (pageName === 'battle') {
                setTimeout(() => {
                    if (window.showBattleMenu) {
                        showBattleMenu();
                    }
                }, 100);
            }
        };
        
        // selectDifficulty Ìï®Ïàò Ï†ïÏùò
        window.selectDifficulty = function(level) {
            console.log('ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù:', level);
            
            // ÎÇúÏù¥ÎèÑ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const selectedBtn = document.querySelector(`[data-level="${level}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            
            // ÌòÑÏû¨ ÎÇúÏù¥ÎèÑ Ï†ÄÏû•
            window.currentDifficulty = level;
        };

        // loadAnimalsFromJSON Ìï®Ïàò Ï†ïÏùò (ÏµúÏö∞ÏÑ†)
        window.loadAnimalsFromJSON = async function() {
            try {
                console.log('ÎèôÎ¨º JSON ÌååÏùº Î°úÎî© ÏãúÏûë...');
                
                const response = await fetch('./animals.json');
                
                if (!response.ok) {
                    throw new Error(`ÎèôÎ¨º JSON ÌååÏùº Î°úÎìú Ïã§Ìå®: ${response.status}`);
                }
                
                const data = await response.json();
                window.animalTypes = data.animals;
                
                console.log(`ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å: ${window.animalTypes.length}ÎßàÎ¶¨`);
                return true;
                
            } catch (error) {
                console.error('ÎèôÎ¨º JSON Î°úÎìú Ïã§Ìå®, Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©:', error);
                
                // Ìè¥Î∞±: Í∏∞Î≥∏ ÎèôÎ¨º Î™á ÎßàÎ¶¨
                window.animalTypes = [
                    {emoji: 'üê∂', name: 'Í∞ïÏïÑÏßÄ', specialName: 'Î©çÎ©çÏôïÏûê', rarity: 1},
                    {emoji: 'üê±', name: 'Í≥†ÏñëÏù¥', specialName: 'ÏïºÏòπÍ≥µÏ£º', rarity: 1},
                    {emoji: 'üê∞', name: 'ÌÜ†ÎÅº', specialName: 'Íπ°Ï¥ùÎåÄÏû•', rarity: 1},
                    {emoji: 'ü¶Å', name: 'ÏÇ¨Ïûê', specialName: 'Ìô©Í∏àÍ∞àÍ∏∞Ïôï', rarity: 4},
                    {emoji: 'ü¶Ñ', name: 'Ïú†ÎãàÏΩò', specialName: 'ÏàúÏàòÏùò Îøî', rarity: 5}
                ];
                
                return false;
            }
        };

        // getAllProfiles Ìï®Ïàò Ï†ïÏùò (updateHallOfFame Î≥¥Îã§ Î®ºÏ†Ä)
        window.getAllProfiles = async function() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const profilesColRef = window.firebase.collection(window.firebase.db, "artifacts", appId, "public/data/profiles");
            const querySnapshot = await window.firebase.getDocs(profilesColRef);
            const profiles = [];
            querySnapshot.forEach((doc) => {
                profiles.push(doc.data());
            });
            return profiles;
        };

        // updateHallOfFame Ìï®Ïàò Ï†ïÏùò (ÏµúÏö∞ÏÑ†)
        window.updateHallOfFame = async function() {
            try {
                const profiles = await window.getAllProfiles();
                if (profiles.length === 0) {
                     document.querySelector('#fame-species .player-name').textContent = `ÏïÑÏßÅ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.`;
                     document.querySelector('#fame-level .player-name').textContent = `ÏÉàÎ°úÏö¥ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÎêòÏñ¥Î≥¥ÏÑ∏Ïöî!`;
                    return;
                }

                let mostSpecies = { name: '-', count: -1 };
                let highestLevel = { name: '-', animal: '-', level: 0 };

                profiles.forEach(p => {
                    if ((p.speciesCount || 0) > mostSpecies.count) {
                        mostSpecies = { name: p.name, count: p.speciesCount };
                    }
                    if (p.animals) {
                        Object.values(p.animals).forEach(a => {
                            if ((a.animalLevel || 1) > highestLevel.level) {
                                highestLevel = { name: p.name, animal: a.name, level: a.animalLevel };
                            }
                        });
                    }
                });

                document.querySelector('#fame-species .player-name').textContent = `${mostSpecies.name} (${mostSpecies.count}Ï¢Ö)`;
                document.querySelector('#fame-level .player-name').textContent = `${highestLevel.name} (Lv.${highestLevel.level} ${highestLevel.animal})`;
            } catch (error) {
                console.error('Î™ÖÏòàÏùò Ï†ÑÎãπ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
            }
        };

        // updateUI Ìï®Ïàò Ï†ïÏùò (ÏµúÏö∞ÏÑ†)
        window.updateUI = function() {
            if (typeof gameState !== 'undefined') {
                const scoreEl = document.getElementById('score');
                const coinsEl = document.getElementById('coins');
                const levelEl = document.getElementById('level');
                const speciesEl = document.getElementById('species-count');
                const totalEl = document.getElementById('total-animals');
                
                if (scoreEl) scoreEl.textContent = gameState.score;
                if (coinsEl) coinsEl.textContent = gameState.coins;
                if (levelEl) levelEl.textContent = gameState.level;
                if (speciesEl) speciesEl.textContent = gameState.speciesCount;
                if (totalEl) totalEl.textContent = gameState.totalAnimals;
            }
        };

        // updateAnimalCollection Ìï®Ïàò Ï†ïÏùò (ÏµúÏö∞ÏÑ†)
        window.updateAnimalCollection = function() {
            const collection = document.getElementById('animal-collection');
            if (!collection || typeof gameState === 'undefined') return;
            
            collection.innerHTML = '';
            
            const sortedAnimals = Object.values(gameState.animals).sort((a, b) => b.rarity - a.rarity);
            
            sortedAnimals.forEach(animal => {
                if (animal.count === 0) return;

                const card = document.createElement('div');
                card.className = 'animal-card';
                

        
        // ==================== Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ ====================
        
        let gameState = {
            score: 0,
            coins: 0,
            level: 1,
            currentQuestion: {},
            animals: {},
            totalAnimals: 0,
            speciesCount: 0,
            farm: {
                layout: Array(48).fill(null),
                items: {}
            },
            // Îß§Ïùº Î°úÍ∑∏Ïù∏ Î≥¥ÏÉÅ ÏãúÏä§ÌÖú Îç∞Ïù¥ÌÑ∞
            dailyRewards: {
                lastLoginDate: null,
                consecutiveDays: 0,
                hasClaimedToday: false,
                totalDaysLogged: 0
            },
            // Í≥ºÎ™©Î≥Ñ ÎèÖÎ¶ΩÏ†ÅÏù∏ Îç∞Ïù¥ÌÑ∞
            subjects: {
                english: { 
                    progress: {}, 
                    level: 1, 
                    score: 0, 
                    currentDifficulty: 1,
                    totalCorrect: 0,
                    totalIncorrect: 0 
                },
                social: { 
                    progress: {}, 
                    level: 1, 
                    score: 0, 
                    currentDifficulty: 1,
                    totalCorrect: 0,
                    totalIncorrect: 0 
                },
                math: { 
                    progress: {}, 
                    level: 1, 
                    score: 0, 
                    currentDifficulty: 1,
                    totalCorrect: 0,
                    totalIncorrect: 0 
                },
                general: { 
                    progress: {}, 
                    level: 1, 
                    score: 0, 
                    currentDifficulty: 1,
                    totalCorrect: 0,
                    totalIncorrect: 0 
                }
            },
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í≥ºÎ™©
            currentSubject: 'english',
            // ÏµúÍ∑º Ï∂úÏ†úÎêú Î¨∏Ï†úÎì§ÏùÑ Ï∂îÏ†ÅÌïòÏó¨ Ï§ëÎ≥µ Î∞©ÏßÄ
            recentQuestions: [],
            // Î∞∞ÌãÄÎ™®Îìú Îç∞Ïù¥ÌÑ∞
            battle: {
                isInBattle: false,
                currentRoom: null,
                playerStats: {
                    totalBattles: 0,
                    wins: 0,
                    points: 0,
                    rank: 'bronze'
                },
                currentGame: {
                    score: 0,
                    correctCount: 0,
                    totalAttempts: 0,
                    startTime: null,
                    questions: [],
                    currentQuestionIndex: 0
                }
            }
        };

        // ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Ï∂îÏ†Å Î≥ÄÏàòÎì§
        let sessionStartTime = null;
        let totalPlayTimeMinutes = 0;

        let currentUserId = null;
        let currentUserProfile = {};
        let selectedItemToPlace = null;
        let currentEnglishQuiz = {};
        let marketListener = null;
        
        // ÏÉàÎ°úÏö¥ ÌïôÏäµ ÏãúÏä§ÌÖú Î≥ÄÏàò
        let currentDifficulty = 1;
        let currentWordData = null;
        let isLoadingWord = false;
        let userProgress = {}; // ÏÇ¨Ïö©Ïûê ÌïôÏäµ ÏßÑÌñâÎèÑ



        const shopItems = [
            { name: 'Îπ®Í∞Ñ Î≤Ω', emoji: 'üü•', price: 15 }, { name: 'ÌååÎûÄ Î≤Ω', emoji: 'üü¶', price: 15 }, { name: 'Ï¥àÎ°ù Î≤Ω', emoji: 'üü©', price: 15 }, { name: 'ÎÖ∏ÎûÄ Î≤Ω', emoji: 'üü®', price: 15 }, { name: 'ÌïòÏñÄ Î≤Ω', emoji: '‚¨ú', price: 15 }, { name: 'Í≤ÄÏùÄ Î≤Ω', emoji: '‚¨õ', price: 15 }, { name: 'Ï£ºÌô© Î≤Ω', emoji: 'üüß', price: 15 }, { name: 'Î≥¥Îùº Î≤Ω', emoji: 'üü™', price: 15 }, { name: 'Í∞àÏÉâ Î≤Ω', emoji: 'üü´', price: 15 },
            { name: 'ÏÉàÏãπ', emoji: 'üå±', price: 25 }, { name: 'ÏûêÍ∞àÍ∏∏', emoji: 'ü™®', price: 35 }, { name: 'Ìï¥Î∞îÎùºÍ∏∞', emoji: 'üåª', price: 40 }, { name: 'Ìä§Î¶Ω', emoji: 'üå∑', price: 45 }, { name: 'ÍΩÉ', emoji: 'üå∏', price: 50 }, { name: 'Îç§Î∂à', emoji: 'üåø', price: 55 }, { name: 'Î≤ÑÏÑØ', emoji: 'üçÑ', price: 60 }, { name: 'Î∞Ä', emoji: 'üåæ', price: 65 }, { name: 'ÎÑ§ÏûéÌÅ¥Î°úÎ≤Ñ', emoji: 'üçÄ', price: 75 }, { name: 'ÏÑ†Ïù∏Ïû•', emoji: 'üåµ', price: 80 },
            { name: 'Í∏∏', emoji: 'üõ§Ô∏è', price: 80 }, { name: 'ÍΩÉÎ∞≠', emoji: 'üíê', price: 90 }, { name: 'ÎÇòÎ¨¥', emoji: 'üå≥', price: 100 }, { name: 'Ïö∞Ï≤¥ÌÜµ', emoji: 'üìÆ', price: 110 }, { name: 'Ï±ÑÏÜåÎ∞≠', emoji: 'ü•ï', price: 120 }, { name: 'ÌóàÏàòÏïÑÎπÑ', emoji: 'üßç', price: 130 }, { name: 'ÏÉÅÎ°ùÏàò', emoji: 'üå≤', price: 150 }, { name: 'Ïö∏ÌÉÄÎ¶¨', emoji: 'üöß', price: 150 }, { name: 'Î≤åÏßë', emoji: 'üêù', price: 160 }, { name: 'Î≤öÎÇòÎ¨¥', emoji: 'üå∏', price: 180 }, { name: 'Ï∫†ÌîÑÌååÏù¥Ïñ¥', emoji: 'üî•', price: 180 }, { name: 'Îã®ÌíçÎÇòÎ¨¥', emoji: 'üçÅ', price: 190 }, { name: 'ÏïºÏûêÏàò', emoji: 'üå¥', price: 200 }, { name: 'Í∞ÄÎ°úÎì±', emoji: 'üí°', price: 220 }, { name: 'Î≤§Ïπò', emoji: 'ü™ë', price: 250 }, { name: 'Ïö∞Î¨º', emoji: 'üï≥Ô∏è', price: 280 }, { name: 'Ïó∞Î™ª', emoji: 'üíß', price: 300 },
            { name: 'Î≥¥Î¨ºÏÉÅÏûê', emoji: 'üéÅ', price: 350 }, { name: 'Î∂ÑÏàò', emoji: '‚õ≤', price: 400 }, { name: 'Ï≤úÎßâ', emoji: '‚õ∫', price: 450 }, { name: 'Ïßë', emoji: 'üè†', price: 500 }, { name: 'Ïò®Ïã§', emoji: 'üè°', price: 600 }, { name: 'Îã§Î¶¨', emoji: 'üåâ', price: 800 }, { name: 'ÏÑ±', emoji: 'üè∞', price: 1000 }, { name: 'ÌöåÏ†ÑÎ™©Îßà', emoji: 'üé†', price: 1200 }, { name: 'Î¨¥ÏßÄÍ∞ú', emoji: 'üåà', price: 1500 }, { name: 'Î≥ÑÎò•Î≥Ñ', emoji: 'üå†', price: 2000 }
        ];

        const synthesisRecipes = [
            { result: 'Í∑∏Î¶¨ÌïÄ', ingredients: ['ÏÇ¨Ïûê', 'ÎèÖÏàòÎ¶¨'] },
            { result: 'ÌéòÍ∞ÄÏàòÏä§', ingredients: ['Îßê', 'Î∞±Ï°∞'] },
            { result: 'ÌÇ§Î©îÎùº', ingredients: ['ÏóºÏÜå', 'ÏÇ¨Ïûê'] },
            { result: 'ÌûàÎìúÎùº', ingredients: ['Î±Ä', 'Ïö©'] },
            { result: 'Ïú†ÎãàÏΩò', ingredients: ['Îßê', 'ÏÇ¨Ïä¥'] },
            { result: 'Î∂àÏÇ¨Ï°∞', ingredients: ['ÎèÖÏàòÎ¶¨', 'Ïö©'] },
            { result: 'ÎèôÏñëÏö©', ingredients: ['Î±Ä', 'Î¨ºÍ≥†Í∏∞'] },
            { result: 'ÌéúÎ¶¨Î•¥', ingredients: ['ÎäëÎåÄ', 'Í≥∞'] },
            { result: 'Ïù∏Ïñ¥', ingredients: ['ÎèåÍ≥†Îûò', 'ÏõêÏà≠Ïù¥'] },
            { result: 'ÌïòÌîº', ingredients: ['ÏÉà', 'Î∞ïÏ•ê'] },
            { result: 'ÎåÄÏôïÏò§ÏßïÏñ¥', ingredients: ['Ïò§ÏßïÏñ¥', 'Î¨∏Ïñ¥'] },
            { result: 'Î∞±Ìò∏', ingredients: ['Ìò∏ÎûëÏù¥', 'Î∂ÅÍ∑πÍ≥∞'] },
            { result: 'ÌùëÌëúÎ≤î', ingredients: ['ÌëúÎ≤î', 'ÎäëÎåÄ'] },
            { result: 'Îß§Î®∏Îìú', ingredients: ['ÏΩîÎÅºÎ¶¨', 'Î©ßÎèºÏßÄ'] },
            { result: 'Ìã∞ÎùºÎÖ∏ÏÇ¨Ïö∞Î£®Ïä§', ingredients: ['ÏïÖÏñ¥', 'Îã≠'] },
            { result: 'Î∏åÎùºÌÇ§Ïò§ÏÇ¨Ïö∞Î£®Ïä§', ingredients: ['Í∏∞Î¶∞', 'ÏÜå'] },
            { result: 'Î≥¥ÏÑù Í≥®Î†ò', ingredients: ['Í±∞Î∂ÅÏù¥', 'Í≤å'] },
            { result: 'Î≥ÑÏùò Ï†ïÎ†π', ingredients: ['ÎÇòÎπÑ', 'Ïò¨ÎπºÎØ∏'] },
            { result: 'ÏùÄÌïòÎ£°', ingredients: ['Ïö©', 'Í≥†Îûò'] },
            { result: 'Í∂ÅÍ∑πÏùò Î°úÎ¥á', ingredients: ['Í±∞ÎØ∏', 'Ï†ÑÍ∞à'] }
        ];

        // ==================== ÏïåÎ¶º ÏãúÏä§ÌÖú Í¥ÄÎ†® Ìï®Ïàò ====================
        
        // ÏïåÎ¶º ÏÉùÏÑ±
        async function createNotification(recipientName, type, message, animalData = null) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const notificationsRef = window.firebase.collection(window.firebase.db, "artifacts", appId, "public/data/notifications");
                
                const notificationData = {
                    recipient: recipientName,
                    type: type,
                    message: message,
                    animalData: animalData,
                    createdAt: new Date().toISOString(),
                    read: false
                };
                
                await window.firebase.setDoc(window.firebase.doc(notificationsRef, `${recipientName}_${Date.now()}`), notificationData);
                console.log(`ÏïåÎ¶º ÏÉùÏÑ± ÏôÑÎ£å: ${recipientName}ÏóêÍ≤å ${type} ÏïåÎ¶º`);
                
            } catch (error) {
                console.error('ÏïåÎ¶º ÏÉùÏÑ± Ïò§Î•ò:', error);
            }
        }
        
        // ÏÇ¨Ïö©Ïûê ÏïåÎ¶º Î°úÎìú
        async function loadNotifications(userName) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const notificationsRef = window.firebase.collection(window.firebase.db, "artifacts", appId, "public/data/notifications");
                const querySnapshot = await window.firebase.getDocs(notificationsRef);
                
                const userNotifications = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.recipient === userName && !data.read) {
                        userNotifications.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                // ÏµúÏã†Ïàú Ï†ïÎ†¨
                userNotifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                return userNotifications;
                
            } catch (error) {
                console.error('ÏïåÎ¶º Î°úÎìú Ïò§Î•ò:', error);
                return [];
            }
        }
        
        // ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨ (Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Î≥ÄÍ≤Ω)
        window.markNotificationAsRead = async function(notificationId) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const notificationRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/notifications", notificationId);
                
                await window.firebase.setDoc(notificationRef, { read: true }, { merge: true });
                
            } catch (error) {
                console.error('ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨ Ïò§Î•ò:', error);
            }
        }
        
        // ÏïåÎ¶º ÌëúÏãú
        async function showNotifications(notifications) {
            if (notifications.length === 0) return;
            
            for (const notification of notifications) {
                let alertStyle = 'background: linear-gradient(45deg, #4169E1, #1E90FF);';
                let emoji = 'üì¢';
                
                if (notification.type === 'sale_success') {
                    alertStyle = 'background: linear-gradient(45deg, #32CD32, #90EE90);';
                    emoji = 'üí∞';
                } else if (notification.type === 'sale_expired') {
                    alertStyle = 'background: linear-gradient(45deg, #FF6B6B, #FFB6C1);';
                    emoji = '‚è∞';
                } else if (notification.type === 'purchase_success') {
                    alertStyle = 'background: linear-gradient(45deg, #9370DB, #DDA0DD);';
                    emoji = 'üéâ';
                } else if (notification.type === 'sale_cancelled') {
                    alertStyle = 'background: linear-gradient(45deg, #FFA500, #FFD700);';
                    emoji = 'üîÑ';
                }
                
                const alert = document.createElement('div');
                alert.className = 'new-animal-alert';
                alert.style.cssText = alertStyle;
                alert.innerHTML = `
                    <span class="new-animal-emoji">${emoji}</span>
                    <h3>ÏïåÎ¶º üì¨</h3>
                    <p>${notification.message}</p>
                    <button onclick="this.parentElement.remove(); markNotificationAsRead('${notification.id}')" 
                            style="background: rgba(255,255,255,0.3); border: none; padding: 8px 16px; border-radius: 10px; margin-top: 10px; cursor: pointer; color: inherit; font-weight: bold;">
                        ÌôïÏù∏
                    </button>
                `;
                
                document.body.appendChild(alert);
                
                // 5Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.remove();
                        markNotificationAsRead(notification.id);
                    }
                }, 5000);
                
                // ÏïåÎ¶º Í∞Ñ Í∞ÑÍ≤©
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        
        // ÏïåÎ¶º ÌôïÏù∏ Î∞è ÌëúÏãú
        async function checkAndShowNotifications() {
            if (!currentUserProfile.name) return;
            
            try {
                const notifications = await loadNotifications(currentUserProfile.name);
                if (notifications.length > 0) {
                    console.log(`${notifications.length}Í∞úÏùò ÏÉàÎ°úÏö¥ ÏïåÎ¶ºÏù¥ ÏûàÏäµÎãàÎã§.`);
                    await showNotifications(notifications);
                }
            } catch (error) {
                console.error('ÏïåÎ¶º ÌôïÏù∏ Ïò§Î•ò:', error);
            }
        }

        // ==================== Îß§Ïùº Î°úÍ∑∏Ïù∏ Î≥¥ÏÉÅ ÏãúÏä§ÌÖú ====================
        
        // Ïò§Îäò ÎÇ†ÏßúÎ•º YYYY-MM-DD ÌòïÏãùÏúºÎ°ú Î∞òÌôò
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        
        // Îß§Ïùº Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨ Î∞è Î≥¥ÏÉÅ
        function checkDailyLoginReward() {
            const today = getTodayString();
            const lastLogin = gameState.dailyRewards.lastLoginDate;
            
            // Ïò§Îäò Ïù¥ÎØ∏ Î≥¥ÏÉÅÏùÑ Î∞õÏïòÎã§Î©¥ Î¶¨ÌÑ¥
            if (gameState.dailyRewards.hasClaimedToday && lastLogin === today) {
                return;
            }
            
            // Ïó∞ÏÜç Î°úÍ∑∏Ïù∏ Í≥ÑÏÇ∞
            if (lastLogin) {
                const lastLoginDate = new Date(lastLogin);
                const todayDate = new Date(today);
                const dayDiff = Math.floor((todayDate - lastLoginDate) / (1000 * 60 * 60 * 24));
                
                if (dayDiff === 1) {
                    // Ïó∞ÏÜç Î°úÍ∑∏Ïù∏
                    gameState.dailyRewards.consecutiveDays++;
                } else if (dayDiff > 1) {
                    // Ïó∞ÏÜçÏÑ± ÎÅäÍπÄ
                    gameState.dailyRewards.consecutiveDays = 1;
                } else if (dayDiff === 0 && gameState.dailyRewards.hasClaimedToday) {
                    // Í∞ôÏùÄ ÎÇ† Ïû¨Ï†ëÏÜç
                    return;
                }
            } else {
                // Ï≤´ Î°úÍ∑∏Ïù∏
                gameState.dailyRewards.consecutiveDays = 1;
            }
            
            // Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            gameState.dailyRewards.lastLoginDate = today;
            gameState.dailyRewards.hasClaimedToday = true;
            gameState.dailyRewards.totalDaysLogged++;
            
            // Î≥¥ÏÉÅ ÏßÄÍ∏â
            showDailyRewardModal();
        }
        
        // ÏùºÏùº Î≥¥ÏÉÅ Í≥ÑÏÇ∞
        function calculateDailyReward() {
            const consecutiveDays = gameState.dailyRewards.consecutiveDays;
            let baseCoins = 50;
            let bonus = 0;
            let specialReward = null;
            
            // Ïó∞ÏÜç Î°úÍ∑∏Ïù∏Ïóê Îî∞Î•∏ Î≥¥ÏÉÅ Ï¶ùÍ∞Ä
            if (consecutiveDays >= 7) {
                bonus = Math.min(consecutiveDays * 10, 200); // ÏµúÎåÄ 200 Î≥¥ÎÑàÏä§
                if (consecutiveDays % 7 === 0) {
                    specialReward = {
                        type: 'rare_animal_chance',
                        description: 'üåü Ìù¨Í∑Ä ÎèôÎ¨º Îì±Ïû• ÌôïÎ•† 2Î∞∞!'
                    };
                }
            }
            
            return {
                coins: baseCoins + bonus,
                specialReward: specialReward,
                consecutiveDays: consecutiveDays
            };
        }
        
        // ÏùºÏùº Î≥¥ÏÉÅ Î™®Îã¨ ÌëúÏãú
        function showDailyRewardModal() {
            const reward = calculateDailyReward();
            
            // ÏΩîÏù∏ ÏßÄÍ∏â
            gameState.coins += reward.coins;
            
            // Î™®Îã¨ HTML ÎèôÏ†Å ÏÉùÏÑ±
            const modalHtml = `
                <div id="daily-reward-modal" class="modal" style="display: flex; z-index: 2000;">
                    <div class="modal-content" style="background: linear-gradient(135deg, #FFD700, #FFA500, #FF69B4); color: white; text-align: center; animation: rewardPulse 0.6s ease-out;">
                        <span class="close-btn" onclick="closeDailyRewardModal()">&times;</span>
                        <h2 style="margin-bottom: 20px; font-size: 2rem;">üéâ Îß§Ïùº Î°úÍ∑∏Ïù∏ Î≥¥ÏÉÅ! üéâ</h2>
                        <div style="font-size: 1.5rem; margin-bottom: 15px;">
                            Ïó∞ÏÜç Ï†ëÏÜç: <strong>${reward.consecutiveDays}Ïùº</strong>
                        </div>
                        <div style="font-size: 3rem; margin: 20px 0;">
                            üí∞ +${reward.coins} ÏΩîÏù∏!
                        </div>
                        ${reward.specialReward ? `
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 15px; margin: 15px 0;">
                                <div style="font-size: 1.2rem; font-weight: bold;">ÌäπÎ≥Ñ Î≥¥ÏÉÅ!</div>
                                <div style="font-size: 1rem;">${reward.specialReward.description}</div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 25px;">
                            <button onclick="closeDailyRewardModal()" style="background: white; color: #FF69B4; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
                                Í∞êÏÇ¨Ìï©ÎãàÎã§! üéÆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Î≥¥ÏÉÅ Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º
            setTimeout(() => {
                playRewardSound();
                showCoinAnimation(reward.coins);
            }, 300);
            
            // ÌäπÎ≥Ñ Î≥¥ÏÉÅ Ï†ÅÏö©
            if (reward.specialReward) {
                applySpecialReward(reward.specialReward);
            }
            
            // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            saveCurrentUserData();
        }
        
        // ÏùºÏùº Î≥¥ÏÉÅ Î™®Îã¨ Îã´Í∏∞
        window.closeDailyRewardModal = function() {
            const modal = document.getElementById('daily-reward-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ÏΩîÏù∏ Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º
        function showCoinAnimation(amount) {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const coin = document.createElement('div');
                    coin.innerHTML = 'ü™ô';
                    coin.style.cssText = `
                        position: fixed;
                        font-size: 2rem;
                        z-index: 3000;
                        pointer-events: none;
                        left: ${Math.random() * window.innerWidth}px;
                        top: 20px;
                        animation: coinFall 2s ease-out forwards;
                    `;
                    document.body.appendChild(coin);
                    
                    setTimeout(() => coin.remove(), 2000);
                }, i * 200);
            }
        }
        
        // Î≥¥ÏÉÅ ÏÇ¨Ïö¥Îìú Ìö®Í≥º (Web Audio API ÏÇ¨Ïö©)
        function playRewardSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // ÏÉÅÏäπÌïòÎäî Î©úÎ°úÎîî ÏÉùÏÑ±
                const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C, E, G, C
                
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.3);
                    }, index * 100);
                });
            } catch (error) {
                console.log('Ïò§ÎîîÏò§ Ïû¨ÏÉù Î∂àÍ∞Ä:', error);
            }
        }
        
        // ÌäπÎ≥Ñ Î≥¥ÏÉÅ Ï†ÅÏö©
        function applySpecialReward(specialReward) {
            if (specialReward.type === 'rare_animal_chance') {
                // Ìù¨Í∑Ä ÎèôÎ¨º Îì±Ïû• ÌôïÎ•† 2Î∞∞ Î≤ÑÌîÑÎ•º 24ÏãúÍ∞Ñ Ï†ÅÏö©
                const buffEndTime = Date.now() + (24 * 60 * 60 * 1000);
                gameState.activeBuffs = gameState.activeBuffs || [];
                gameState.activeBuffs.push({
                    type: 'rare_animal_chance_2x',
                    endTime: buffEndTime
                });
            }
        }

        // ==================== Í≥ºÎ™© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú ====================
        
        // Í≥ºÎ™© Î≥ÄÍ≤Ω
        function changeSubject() {
            const selectElement = document.getElementById('subject-select');
            const newSubject = selectElement.value;
            
            if (newSubject !== gameState.currentSubject) {
                // ÌòÑÏû¨ Í≥ºÎ™© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                saveCurrentSubjectProgress();
                
                // ÏÉà Í≥ºÎ™©ÏúºÎ°ú Î≥ÄÍ≤Ω
                gameState.currentSubject = newSubject;
                
                // ÏÉà Í≥ºÎ™© Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                loadCurrentSubjectProgress();
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateSubjectUI();
                
                // ÏÉà Î¨∏Ï†ú ÏÉùÏÑ±
                setTimeout(() => {
                    generatePersonalizedQuiz();
                }, 500);
                
                console.log(`Í≥ºÎ™©Ïù¥ ${newSubject}Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
            }
        }
        
        // ÌòÑÏû¨ Í≥ºÎ™© ÏßÑÌñâÎèÑ Ï†ÄÏû•
        function saveCurrentSubjectProgress() {
            const currentSubject = gameState.currentSubject;
            if (!gameState.subjects[currentSubject]) {
                gameState.subjects[currentSubject] = {
                    progress: {},
                    level: 1,
                    score: 0,
                    currentDifficulty: 1,
                    totalCorrect: 0,
                    totalIncorrect: 0
                };
            }
            
            // ÌòÑÏû¨ ÌïôÏäµ ÏßÑÌñâÎèÑÎ•º Í≥ºÎ™©Î≥ÑÎ°ú Ï†ÄÏû•
            gameState.subjects[currentSubject].progress = { ...userProgress };
            gameState.subjects[currentSubject].currentDifficulty = currentDifficulty;
            
            console.log(`${currentSubject} Í≥ºÎ™© ÏßÑÌñâÎèÑ Ï†ÄÏû•Îê®:`, gameState.subjects[currentSubject]);
        }
        
        // ÌòÑÏû¨ Í≥ºÎ™© ÏßÑÌñâÎèÑ Î°úÎìú
        function loadCurrentSubjectProgress() {
            const currentSubject = gameState.currentSubject;
            
            // Í≥ºÎ™© Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
            if (!gameState.subjects[currentSubject]) {
                gameState.subjects[currentSubject] = {
                    progress: {},
                    level: 1,
                    score: 0,
                    currentDifficulty: 1,
                    totalCorrect: 0,
                    totalIncorrect: 0
                };
            }
            
            // Í≥ºÎ™©Î≥Ñ ÏßÑÌñâÎèÑ Î°úÎìú
            userProgress = { ...gameState.subjects[currentSubject].progress };
            currentDifficulty = gameState.subjects[currentSubject].currentDifficulty || 1;
            
            console.log(`${currentSubject} Í≥ºÎ™© ÏßÑÌñâÎèÑ Î°úÎìúÎê®:`, gameState.subjects[currentSubject]);
        }
        
        // Í≥ºÎ™©Î≥Ñ UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateSubjectUI() {
            const currentSubject = gameState.currentSubject;
            const subjectData = gameState.subjects[currentSubject];
            
            // Í≥ºÎ™© Ïù¥Î¶Ñ ÌëúÏãú
            const gameTitle = document.querySelector('#game-page h2');
            if (gameTitle) {
                const subjectNames = {
                    'english': 'ÏòÅÏñ¥ ÌïôÏäµ üá¨üáß',
                    'social': 'ÏÇ¨Ìöå ÌïôÏäµ üèõÔ∏è'
                };
                gameTitle.textContent = subjectNames[currentSubject] || 'ÌïôÏäµ Í≤åÏûÑ';
            }
            
            // Í≥ºÎ™©Î≥Ñ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            if (subjectData) {
                document.getElementById('word-correct').textContent = subjectData.totalCorrect || 0;
                document.getElementById('word-incorrect').textContent = subjectData.totalIncorrect || 0;
                
                const total = (subjectData.totalCorrect || 0) + (subjectData.totalIncorrect || 0);
                const accuracy = total > 0 ? Math.round(((subjectData.totalCorrect || 0) / total) * 100) : 0;
                document.getElementById('word-accuracy').textContent = accuracy;
            }
        }
        
        // Í≥ºÎ™©Î≥Ñ ÌååÏùº Í≤ΩÎ°ú ÏÉùÏÑ±
        function getSubjectFilePath(level) {
            const currentSubject = gameState.currentSubject;
            return `./subjects/${currentSubject}/level${level}.json`;
        }
        
        // Í≥ºÎ™©Î≥Ñ Îã®Ïñ¥ ID ÏÉùÏÑ±
        function generateSubjectWordId(korean, english) {
            const currentSubject = gameState.currentSubject;
            const cleanKorean = korean.replace(/[^Í∞Ä-Ìû£a-zA-Z]/g, '');
            return `${currentSubject}_${cleanKorean}-${english.toLowerCase()}`;
        }

        // ==================== ÎûúÎç§ Ïù¥Î≤§Ìä∏ ÏãúÏä§ÌÖú ====================
        
        // ÎûúÎç§ Ïù¥Î≤§Ìä∏ Ï≤¥ÌÅ¨ (Ï†ïÎãµ ÌõÑ 5% ÌôïÎ•†Î°ú Î∞úÏÉù)
        function checkRandomEvent() {
            // ÌôúÏÑ± Î≤ÑÌîÑ Ï†ïÎ¶¨ (ÎßåÎ£åÎêú Í≤ÉÎì§ Ï†úÍ±∞)
            if (gameState.activeBuffs) {
                gameState.activeBuffs = gameState.activeBuffs.filter(buff => buff.endTime > Date.now());
            }
            
            const eventChance = Math.random();
            
            if (eventChance < 0.05) { // 5% ÌôïÎ•†
                triggerRandomEvent();
            }
        }
        
        // ÎûúÎç§ Ïù¥Î≤§Ìä∏ Ïã§Ìñâ
        function triggerRandomEvent() {
            const events = [
                {
                    type: 'golden_animal',
                    chance: 0.3,
                    execute: () => showGoldenAnimalEvent()
                },
                {
                    type: 'coin_rain',
                    chance: 0.4,
                    execute: () => showCoinRainEvent()
                },
                {
                    type: 'super_rare_encounter',
                    chance: 0.2,
                    execute: () => showSuperRareEncounter()
                },
                {
                    type: 'mystery_box',
                    chance: 0.1,
                    execute: () => showMysteryBoxEvent()
                }
            ];
            
            const rand = Math.random();
            let cumulative = 0;
            
            for (const event of events) {
                cumulative += event.chance;
                if (rand <= cumulative) {
                    event.execute();
                    break;
                }
            }
        }
        
        // Ìô©Í∏à ÎèôÎ¨º Îì±Ïû• Ïù¥Î≤§Ìä∏
        function showGoldenAnimalEvent() {
            // ÎûúÎç§ ÎèôÎ¨º ÏÑ†ÌÉù
            const randomAnimal = animalTypes[Math.floor(Math.random() * animalTypes.length)];
            
            const modalHtml = `
                <div id="event-modal" class="modal" style="display: flex; z-index: 2500;">
                    <div class="modal-content" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #8B4513; text-align: center; animation: sparkleEffect 0.8s ease-out;">
                        <span class="close-btn" onclick="closeEventModal()" style="color: #8B4513;">&times;</span>
                        <h2 style="margin-bottom: 20px; font-size: 2rem;">‚ú® Ìô©Í∏à ÎèôÎ¨º Î∞úÍ≤¨! ‚ú®</h2>
                        <div style="font-size: 6rem; margin: 20px 0; filter: drop-shadow(0 0 10px gold);">
                            ${randomAnimal.emoji}
                        </div>
                        <div style="font-size: 1.5rem; margin-bottom: 15px;">
                            Ìô©Í∏àÎπõÏúºÎ°ú ÎπõÎÇòÎäî <strong>${randomAnimal.name}</strong>ÏùÑ(Î•º) Î∞úÍ≤¨ÌñàÏäµÎãàÎã§!
                        </div>
                        <div style="font-size: 1.2rem; margin-bottom: 25px;">
                            ÌäπÎ≥ÑÌïú Ïù¥Î¶Ñ: "<strong>${randomAnimal.specialName}</strong>"
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="claimGoldenAnimal('${randomAnimal.name}')" style="background: white; color: #FF69B4; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 5px;">
                                üíñ ÏàòÏßëÌïòÍ∏∞ (+100 Î≥¥ÎÑàÏä§ ÏΩîÏù∏!)
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            playMagicSound();
            createSparkleEffect();
        }
        
        // ÏΩîÏù∏ ÎπÑ Ïù¥Î≤§Ìä∏
        function showCoinRainEvent() {
            const bonusCoins = Math.floor(Math.random() * 100) + 50; // 50-150 ÏΩîÏù∏
            
            const modalHtml = `
                <div id="event-modal" class="modal" style="display: flex; z-index: 2500;">
                    <div class="modal-content" style="background: linear-gradient(135deg, #87CEEB, #98FB98); color: #2C5530; text-align: center; animation: rewardPulse 0.6s ease-out;">
                        <span class="close-btn" onclick="closeEventModal()" style="color: #2C5530;">&times;</span>
                        <h2 style="margin-bottom: 20px; font-size: 2rem;">üåßÔ∏è ÏΩîÏù∏ÎπÑÍ∞Ä ÎÇ¥Î†§Ïöî! üåßÔ∏è</h2>
                        <div style="font-size: 4rem; margin: 20px 0;">
                            üí∞ü™ôüí∞
                        </div>
                        <div style="font-size: 1.5rem; margin-bottom: 25px;">
                            ÌïòÎäòÏóêÏÑú ÏΩîÏù∏Ïù¥ ÏèüÏïÑÏßëÎãàÎã§!<br>
                            <strong>+${bonusCoins}</strong> ÏΩîÏù∏ÏùÑ ÌöçÎìùÌñàÏñ¥Ïöî!
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="claimCoinRain(${bonusCoins})" style="background: #32CD32; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
                                üí∞ ÏΩîÏù∏ ÏàòÏßëÌïòÍ∏∞!
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            showCoinAnimation(bonusCoins);
        }
        
        // Ï¥àÌù¨Í∑Ä ÎèôÎ¨º Ï°∞Ïö∞ Ïù¥Î≤§Ìä∏
        function showSuperRareEncounter() {
            // Ìù¨Í∑ÄÎèÑ 5 Ïù¥ÏÉÅÏù∏ ÎèôÎ¨ºÎßå ÏÑ†ÌÉù
            const rareAnimals = animalTypes.filter(animal => animal.rarity >= 5);
            const superRareAnimal = rareAnimals[Math.floor(Math.random() * rareAnimals.length)] || animalTypes[0];
            
            const modalHtml = `
                <div id="event-modal" class="modal" style="display: flex; z-index: 2500;">
                    <div class="modal-content" style="background: linear-gradient(135deg, #9370DB, #8A2BE2); color: white; text-align: center; animation: mysticalGlow 1s ease-out;">
                        <span class="close-btn" onclick="closeEventModal()">&times;</span>
                        <h2 style="margin-bottom: 20px; font-size: 2rem;">üîÆ Ïã†ÎπÑÌïú ÎßåÎÇ® üîÆ</h2>
                        <div style="font-size: 5rem; margin: 20px 0; text-shadow: 0 0 20px purple;">
                            ${superRareAnimal.emoji}
                        </div>
                        <div style="font-size: 1.5rem; margin-bottom: 15px;">
                            Ï†ÑÏÑ§Ïùò <strong>${superRareAnimal.name}</strong>Ïù¥(Í∞Ä) ÎÇòÌÉÄÎÇ¨ÏäµÎãàÎã§!
                        </div>
                        <div style="font-size: 1.1rem; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                            Ìù¨Í∑ÄÎèÑ: ‚≠ê${superRareAnimal.rarity}<br>
                            ÌäπÎ≥ÑÌïú Ïù¥Î¶Ñ: "${superRareAnimal.specialName}"
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="claimSuperRareAnimal('${superRareAnimal.name}')" style="background: gold; color: purple; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
                                üåü Ï†ÑÏÑ§Ïùò ÎèôÎ¨º ÏàòÏßëÌïòÍ∏∞!
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            playMysticalSound();
        }
        
        // Ïã†ÎπÑÌïú ÏÉÅÏûê Ïù¥Î≤§Ìä∏
        function showMysteryBoxEvent() {
            const modalHtml = `
                <div id="event-modal" class="modal" style="display: flex; z-index: 2500;">
                    <div class="modal-content" style="background: linear-gradient(135deg, #4B0082, #663399); color: white; text-align: center; animation: mysteryBox 1s ease-out;">
                        <span class="close-btn" onclick="closeEventModal()">&times;</span>
                        <h2 style="margin-bottom: 20px; font-size: 2rem;">üì¶ Ïã†ÎπÑÌïú ÏÉÅÏûê Î∞úÍ≤¨! üì¶</h2>
                        <div style="font-size: 4rem; margin: 20px 0; cursor: pointer;" onclick="openMysteryBox()">
                            üì¶‚ú®
                        </div>
                        <div style="font-size: 1.3rem; margin-bottom: 25px;">
                            Î¨¥ÏóáÏù¥ Îì§Ïñ¥ÏûàÏùÑÍπåÏöî?<br>
                            ÏÉÅÏûêÎ•º ÌÅ¥Î¶≠Ìï¥ÏÑú Ïó¥Ïñ¥Î≥¥ÏÑ∏Ïöî!
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="openMysteryBox()" style="background: #FF69B4; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
                                üîì ÏÉÅÏûê Ïó¥Í∏∞!
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Ïù¥Î≤§Ìä∏ Î™®Îã¨ Îã´Í∏∞
        window.closeEventModal = function() {
            const modal = document.getElementById('event-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Ìô©Í∏à ÎèôÎ¨º ÏàòÏßëÌïòÍ∏∞
        window.claimGoldenAnimal = function(animalName) {
            addAnimal(animalName, 2); // Î†àÎ≤® 2Î°ú Ï∂îÍ∞Ä
            gameState.coins += 100; // Î≥¥ÎÑàÏä§ ÏΩîÏù∏
            updateUI();
            updateAnimalCollection();
            saveCurrentUserData();
            closeEventModal();
            
            showSuccessMessage(`‚ú® Ìô©Í∏à ${animalName}ÏùÑ(Î•º) ÏàòÏßëÌñàÏäµÎãàÎã§! (+100 ÏΩîÏù∏)`);
        }
        
        // ÏΩîÏù∏ÎπÑ ÏàòÏßëÌïòÍ∏∞
        window.claimCoinRain = function(amount) {
            gameState.coins += amount;
            updateUI();
            saveCurrentUserData();
            closeEventModal();
            
            showSuccessMessage(`üåßÔ∏è ${amount} ÏΩîÏù∏ÏùÑ ÏàòÏßëÌñàÏäµÎãàÎã§!`);
        }
        
        // Ï¥àÌù¨Í∑Ä ÎèôÎ¨º ÏàòÏßëÌïòÍ∏∞
        window.claimSuperRareAnimal = function(animalName) {
            addAnimal(animalName, 3); // Î†àÎ≤® 3ÏúºÎ°ú Ï∂îÍ∞Ä
            updateUI();
            updateAnimalCollection();
            saveCurrentUserData();
            closeEventModal();
            
            showSuccessMessage(`üîÆ Ï†ÑÏÑ§Ïùò ${animalName}ÏùÑ(Î•º) ÏàòÏßëÌñàÏäµÎãàÎã§!`);
        }
        
        // Ïã†ÎπÑÌïú ÏÉÅÏûê Ïó¥Í∏∞
        window.openMysteryBox = function() {
            const rewards = [
                { type: 'coins', amount: 200, message: 'üí∞ 200 ÏΩîÏù∏!' },
                { type: 'random_animal', message: 'üêæ ÎûúÎç§ ÎèôÎ¨º!' },
                { type: 'level_boost', message: '‚¨ÜÔ∏è Î™®Îì† ÎèôÎ¨º Î†àÎ≤®ÏóÖ!' },
                { type: 'rare_buff', message: 'üåü Ìù¨Í∑Ä ÎèôÎ¨º ÌôïÎ•† Ï¶ùÍ∞Ä Î≤ÑÌîÑ!' }
            ];
            
            const reward = rewards[Math.floor(Math.random() * rewards.length)];
            
            // Î≥¥ÏÉÅ Ï†ÅÏö©
            if (reward.type === 'coins') {
                gameState.coins += reward.amount;
            } else if (reward.type === 'random_animal') {
                const randomAnimal = animalTypes[Math.floor(Math.random() * animalTypes.length)];
                addAnimal(randomAnimal.name, 1);
            } else if (reward.type === 'level_boost') {
                Object.keys(gameState.animals).forEach(animalName => {
                    if (gameState.animals[animalName].animalLevel < 5) {
                        gameState.animals[animalName].animalLevel++;
                    }
                });
            } else if (reward.type === 'rare_buff') {
                const buffEndTime = Date.now() + (6 * 60 * 60 * 1000); // 6ÏãúÍ∞Ñ
                gameState.activeBuffs = gameState.activeBuffs || [];
                gameState.activeBuffs.push({
                    type: 'rare_animal_chance_3x',
                    endTime: buffEndTime
                });
            }
            
            updateUI();
            updateAnimalCollection();
            saveCurrentUserData();
            closeEventModal();
            
            showSuccessMessage(`üì¶ ${reward.message}`);
        }
        
        // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
        function showSuccessMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'new-animal-alert';
            alert.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 3000;
                background: linear-gradient(45deg, #32CD32, #228B22);
                color: white; padding: 20px; border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: slideInRight 0.5s ease-out;
                max-width: 300px; text-align: center; font-weight: bold;
            `;
            alert.innerHTML = message;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }
        
        // Î∞òÏßùÏù¥Îäî Ìö®Í≥º ÏÉùÏÑ±
        function createSparkleEffect() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle-particle';
                    sparkle.style.left = Math.random() * window.innerWidth + 'px';
                    sparkle.style.top = Math.random() * window.innerHeight + 'px';
                    sparkle.style.background = ['gold', 'silver', 'orange', 'yellow'][Math.floor(Math.random() * 4)];
                    document.body.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 1500);
                }, i * 100);
            }
        }
        
        // ÎßàÎ≤ï ÏÜåÎ¶¨ Ìö®Í≥º
        function playMagicSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const frequencies = [523, 659, 784, 1047, 1319]; // ÎßàÎ≤ïÍ∞ôÏùÄ Î©úÎ°úÎîî
                
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                        oscillator.type = 'triangle';
                        
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.4);
                    }, index * 150);
                });
            } catch (error) {
                console.log('ÎßàÎ≤ï ÏÜåÎ¶¨ Ïû¨ÏÉù Î∂àÍ∞Ä:', error);
            }
        }
        
        // Ïã†ÎπÑÌïú ÏÜåÎ¶¨ Ìö®Í≥º
        function playMysticalSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const frequencies = [220, 277, 330, 440]; // Ïã†ÎπÑÎ°úÏö¥ ÌôîÏùå
                
                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.1);
                    oscillator.type = 'sawtooth';
                    
                    gainNode.gain.setValueAtTime(0.05, audioContext.currentTime + index * 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
                    
                    oscillator.start(audioContext.currentTime + index * 0.1);
                    oscillator.stop(audioContext.currentTime + 2);
                });
            } catch (error) {
                console.log('Ïã†ÎπÑÌïú ÏÜåÎ¶¨ Ïû¨ÏÉù Î∂àÍ∞Ä:', error);
            }
        }

        // ==================== Ìñ•ÏÉÅÎêú ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞± ÏãúÏä§ÌÖú ====================
        
        // Ï†ïÎãµ Ïãú ÌôîÎ†§Ìïú Ìö®Í≥º
        function showCorrectAnswerEffects() {
            // ÌååÌã∞ÌÅ¥ Î≤ÑÏä§Ìä∏
            createParticleBurst('correct');
            
            // ÏÑ±Í≥µ ÏÇ¨Ïö¥Îìú
            playSuccessSound();
            
            // ÌôîÎ©¥ ÏßÑÎèô Ìö®Í≥º (Î™®Î∞îÏùº)
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        }
        
        // Ïò§Îãµ Ïãú ÌîºÎìúÎ∞± Ìö®Í≥º
        function showIncorrectAnswerEffects() {
            // ÌôîÎ©¥ ÌùîÎì§Î¶º Ìö®Í≥º
            document.body.style.animation = 'incorrectShake 0.6s ease-out';
            setTimeout(() => {
                document.body.style.animation = '';
            }, 600);
            
            // Ïò§Îãµ ÏÇ¨Ïö¥Îìú
            playErrorSound();
            
            // ÏïΩÍ∞ÑÏùò ÏßÑÎèô (Î™®Î∞îÏùº)
            if (navigator.vibrate) {
                navigator.vibrate([200]);
            }
        }
        
        // ÌååÌã∞ÌÅ¥ Î≤ÑÏä§Ìä∏ ÏÉùÏÑ±
        function createParticleBurst(type = 'correct') {
            const colors = type === 'correct' 
                ? ['#32CD32', '#90EE90', '#00FF00', '#ADFF2F']
                : ['#FF6B6B', '#FF69B4', '#FF4500', '#FFB6C1'];
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: fixed;
                        width: 8px; height: 8px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 4000;
                        left: ${window.innerWidth / 2}px;
                        top: ${window.innerHeight / 2}px;
                        animation: particleBurst ${1 + Math.random()}s ease-out forwards;
                    `;
                    
                    // ÎûúÎç§ Î∞©Ìñ•ÏúºÎ°ú ÏõÄÏßÅÏù¥Îäî CSS Ïï†ÎãàÎ©îÏù¥ÏÖò ÎèôÏ†Å ÏÉùÏÑ±
                    const angle = (Math.PI * 2 * i) / 15;
                    const distance = 100 + Math.random() * 100;
                    const endX = Math.cos(angle) * distance;
                    const endY = Math.sin(angle) * distance;
                    
                    const keyframes = `
                        @keyframes particleBurst {
                            to { 
                                transform: translate(${endX}px, ${endY}px) scale(0); 
                                opacity: 0;
                            }
                        }
                    `;
                    
                    // ÎèôÏ†Å Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
                    const style = document.createElement('style');
                    style.textContent = keyframes;
                    document.head.appendChild(style);
                    
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.remove();
                        style.remove();
                    }, 2000);
                }, i * 50);
            }
        }
        
        // ÏÑ±Í≥µ ÏÇ¨Ïö¥Îìú
        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // ÏÉÅÏäπÌïòÎäî Î©úÎ°úÎîî
                const melody = [
                    { freq: 523.25, time: 0 },      // C
                    { freq: 659.25, time: 0.1 },    // E  
                    { freq: 783.99, time: 0.2 },    // G
                    { freq: 1046.50, time: 0.3 }    // High C
                ];
                
                melody.forEach(note => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.2);
                    }, note.time * 1000);
                });
            } catch (error) {
                console.log('ÏÑ±Í≥µ ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Î∂àÍ∞Ä:', error);
            }
        }
        
        // Ïò§Îãµ ÏÇ¨Ïö¥Îìú
        function playErrorSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // ÌïòÍ∞ïÌïòÎäî Î∂àÌòëÌôîÏùå
                const frequencies = [400, 350, 300]; 
                
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                        oscillator.type = 'sawtooth';
                        
                        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.3);
                    }, index * 100);
                });
            } catch (error) {
                console.log('Ïò§Îãµ ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Î∂àÍ∞Ä:', error);
            }
        }
        
        // Î†àÎ≤®ÏóÖ Ï∂ïÌïò Ìö®Í≥º
        function showLevelUpEffects() {
            // Ìô©Í∏à ÌååÌã∞ÌÅ¥ Ìè≠Î∞ú
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: fixed;
                        width: 12px; height: 12px;
                        background: linear-gradient(45deg, #FFD700, #FFA500);
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 5000;
                        left: ${Math.random() * window.innerWidth}px;
                        top: 20px;
                        animation: levelUpBurst 2s ease-out forwards;
                        box-shadow: 0 0 10px gold;
                    `;
                    document.body.appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 2000);
                }, i * 100);
            }
            
            // Î†àÎ≤®ÏóÖ ÏÇ¨Ïö¥Îìú
            playLevelUpSound();
            
            // Í∞ïÌïú ÏßÑÎèô (Î™®Î∞îÏùº)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }
        
        // Î†àÎ≤®ÏóÖ ÏÇ¨Ïö¥Îìú
        function playLevelUpSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Ìå°ÌååÎ•¥ Í∞ôÏùÄ Î©úÎ°úÎîî
                const fanfare = [
                    { freq: 523.25, time: 0, duration: 0.2 },
                    { freq: 659.25, time: 0.1, duration: 0.2 },
                    { freq: 783.99, time: 0.2, duration: 0.2 },
                    { freq: 1046.50, time: 0.3, duration: 0.4 },
                    { freq: 1318.51, time: 0.5, duration: 0.6 }
                ];
                
                fanfare.forEach(note => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime);
                        oscillator.type = 'triangle';
                        
                        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.duration);
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + note.duration);
                    }, note.time * 1000);
                });
            } catch (error) {
                console.log('Î†àÎ≤®ÏóÖ ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Î∂àÍ∞Ä:', error);
            }
        }
        
        // ==================== Í∞úÏù∏ÌôîÎêú ÌïôÏäµ ÏãúÏä§ÌÖú ====================
        
        // ÏÇ¨Ïö©Ïûê ÏïΩÏ†ê Î∂ÑÏÑù
        function analyzeUserWeaknesses() {
            const weaknesses = [];
            const strengths = [];
            
            Object.keys(userProgress).forEach(wordId => {
                const progress = userProgress[wordId];
                const totalAttempts = progress.correct + progress.incorrect;
                
                if (totalAttempts >= 3) { // ÏµúÏÜå 3Î≤à Ïù¥ÏÉÅ ÏãúÎèÑÌïú Îã®Ïñ¥Îßå Î∂ÑÏÑù
                    const accuracy = progress.correct / totalAttempts;
                    
                    if (accuracy < 0.6) { // Ï†ïÎãµÎ•† 60% ÎØ∏ÎßåÏùÄ ÏïΩÏ†ê
                        weaknesses.push({
                            wordId: wordId,
                            accuracy: accuracy,
                            attempts: totalAttempts,
                            lastSeen: progress.lastSeen
                        });
                    } else if (accuracy > 0.8) { // Ï†ïÎãµÎ•† 80% Ïù¥ÏÉÅÏùÄ Í∞ïÏ†ê
                        strengths.push({
                            wordId: wordId,
                            accuracy: accuracy,
                            attempts: totalAttempts
                        });
                    }
                }
            });
            
            // ÏïΩÏ†ê Îã®Ïñ¥Î•º Ï†ïÎãµÎ•† ÏàúÏúºÎ°ú Ï†ïÎ†¨
            weaknesses.sort((a, b) => a.accuracy - b.accuracy);
            
            return { weaknesses, strengths };
        }
        
        // ÎßûÏ∂§Ìòï Î¨∏Ï†ú ÏÉùÏÑ±
        function generatePersonalizedQuiz() {
            const analysis = analyzeUserWeaknesses();
            
            // 70% ÌôïÎ•†Î°ú ÏïΩÏ†ê Îã®Ïñ¥ Ï∂úÏ†ú, 30% ÌôïÎ•†Î°ú ÏÉà Îã®Ïñ¥
            const shouldUseWeakness = Math.random() < 0.7 && analysis.weaknesses.length > 0;
            
            if (shouldUseWeakness) {
                generateWeaknessQuiz(analysis.weaknesses);
            } else {
                generateRegularQuiz();
            }
        }
        
        // ÏïΩÏ†ê Î¨∏Ï†ú ÏÉùÏÑ±
        async function generateWeaknessQuiz(weaknesses) {
            // Í∞ÄÏû• ÏïΩÌïú Îã®Ïñ¥ 3Í∞ú Ï§ëÏóêÏÑú ÎûúÎç§ ÏÑ†ÌÉù
            const topWeaknesses = weaknesses.slice(0, Math.min(3, weaknesses.length));
            const selectedWeakness = topWeaknesses[Math.floor(Math.random() * topWeaknesses.length)];
            
            // Ìï¥Îãπ Îã®Ïñ¥ Ï†ïÎ≥¥ Ï∞æÍ∏∞
            const wordData = await findWordById(selectedWeakness.wordId);
            if (!wordData) {
                generateRegularQuiz();
                return;
            }
            
            // currentWordData ÏÑ§Ï†ï (Í∞úÏù∏Ìôî ÌïôÏäµÏùÑ ÏúÑÌï®)
            currentWordData = {
                id: selectedWeakness.wordId,
                korean: wordData.korean,
                english: wordData.english,
                options: wordData.options,
                difficulty: 'weakness_review',
                source: 'weakness'
            };
            
            currentEnglishQuiz = {
                korean: wordData.korean,
                answer: wordData.english,
                options: wordData.options,
                isWeakness: true,
                accuracy: selectedWeakness.accuracy
            };
            
            displayQuiz();
            
            // ÏïΩÏ†ê Î¨∏Ï†úÏûÑÏùÑ ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º
            showWeaknessHint(selectedWeakness.accuracy);
        }
        
        // Îã®Ïñ¥ IDÎ°ú Îã®Ïñ¥ Ï∞æÍ∏∞
        async function findWordById(wordId) {
            for (let level = 1; level <= 3; level++) {
                try {
                    const response = await fetch(getSubjectFilePath(level));
                    const data = await response.json();
                    
                    const word = data.words.find(w => {
                        // Í≥ºÎ™©Î≥Ñ ID ÏÉùÏÑ± Î∞©ÏãùÏóê ÎßûÏ∂∞ Í≤ÄÏÉâ
                        let expectedId;
                        if (gameState.currentSubject === 'social') {
                            const cleanQuestion = (w.question || '').replace(/[^Í∞Ä-Ìû£a-zA-Z]/g, '');
                            const answer = w.options ? w.options[w.answer] : '';
                            expectedId = generateSubjectWordId(w.question, answer);
                        } else {
                            expectedId = generateSubjectWordId(w.korean, w.english);
                        }
                        return expectedId === wordId;
                    });
                    
                    if (word) return word;
                } catch (error) {
                    console.error(`Level ${level} Îã®Ïñ¥ ÌååÏùº Î°úÎìú Ïã§Ìå®:`, error);
                }
            }
            return null;
        }
        
        // ÏùºÎ∞ò Î¨∏Ï†ú ÏÉùÏÑ± (Í∏∞Ï°¥ Î°úÏßÅ)
        function generateRegularQuiz() {
            generateEnglishQuiz(); // Í∏∞Ï°¥ Ìï®Ïàò Ìò∏Ï∂ú (Î™®Îì† Í≥ºÎ™© Ìò∏Ìôò)
        }
        
        // ÏïΩÏ†ê ÌûåÌä∏ ÌëúÏãú
        function showWeaknessHint(accuracy) {
            const accuracyPercent = Math.round(accuracy * 100);
            
            const hint = document.createElement('div');
            hint.style.cssText = `
                position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
                background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
                color: white; padding: 10px 20px; border-radius: 20px;
                font-weight: bold; z-index: 3000;
                animation: slideInDown 0.5s ease-out;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            `;
            hint.innerHTML = `üéØ ÏïΩÏ†ê Ïó∞Ïäµ: Ï†ïÎãµÎ•† ${accuracyPercent}% | ÏßëÏ§ëÌï¥ÏÑú ÌíÄÏñ¥Î≥¥ÏÑ∏Ïöî!`;
            
            document.body.appendChild(hint);
            
            setTimeout(() => hint.remove(), 3000);
        }
        
        // ÌïôÏäµ ÏÑ±Í≥º Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏
        function generateLearningReport() {
            const analysis = analyzeUserWeaknesses();
            const totalWords = Object.keys(userProgress).length;
            
            if (totalWords < 5) {
                return "Îçî ÎßéÏùÄ Îã®Ïñ¥Î•º ÌïôÏäµÌïú ÌõÑ Î∂ÑÏÑùÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.";
            }
            
            const averageAccuracy = Object.values(userProgress).reduce((sum, progress) => {
                const total = progress.correct + progress.incorrect;
                return sum + (total > 0 ? progress.correct / total : 0);
            }, 0) / totalWords;
            
            const report = {
                totalWords: totalWords,
                averageAccuracy: Math.round(averageAccuracy * 100),
                weaknesses: analysis.weaknesses.length,
                strengths: analysis.strengths.length,
                recommendations: generateRecommendations(analysis)
            };
            
            return report;
        }
        
        // Îã®Ïñ¥ ID ÏÉùÏÑ± (ÏùºÍ¥ÄÏÑ± ÏûàÎäî ID ÏÉùÏÑ±)
        function generateWordId(korean, english) {
            const cleanKorean = korean.replace(/[^Í∞Ä-Ìû£a-zA-Z]/g, '');
            return `${cleanKorean}-${english.toLowerCase()}`;
        }
        
        // Í∞úÏù∏ÌôîÎêú Ï∂îÏ≤ú ÏÉùÏÑ±
        function generateRecommendations(analysis) {
            const recommendations = [];
            
            if (analysis.weaknesses.length > 5) {
                recommendations.push("üîç ÏïΩÏ†ê Îã®Ïñ¥Í∞Ä ÎßéÏäµÎãàÎã§. Îß§Ïùº Ï°∞Í∏àÏî© Î≥µÏäµÌï¥Î≥¥ÏÑ∏Ïöî!");
            }
            
            if (analysis.strengths.length > analysis.weaknesses.length) {
                recommendations.push("üëè ÏûòÌïòÍ≥† ÏûàÏñ¥Ïöî! ÏÉàÎ°úÏö¥ Îã®Ïñ¥Ïóê ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî!");
            }
            
            const recentWeaknesses = analysis.weaknesses.filter(w => {
                const daysDiff = (new Date() - new Date(w.lastSeen)) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7;
            });
            
            if (recentWeaknesses.length > 0) {
                recommendations.push("üìö ÏµúÍ∑ºÏóê ÌãÄÎ¶∞ Îã®Ïñ¥Îì§ÏùÑ ÏßëÏ§ë Î≥µÏäµÌïòÏÑ∏Ïöî!");
            }
            
            return recommendations;
        }
        
        // ÌïôÏäµ Î¶¨Ìè¨Ìä∏ Î™®Îã¨ ÌëúÏãú
        function showLearningReport() {
            const report = generateLearningReport();
            
            if (typeof report === 'string') {
                alert(report);
                return;
            }
            
            const modalHtml = `
                <div id="learning-report-modal" class="modal" style="display: flex; z-index: 2000;">
                    <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; max-width: 500px;">
                        <span class="close-btn" onclick="closeLearningReportModal()">&times;</span>
                        <h2 style="margin-bottom: 25px; font-size: 2rem;">üìä ÎÇòÏùò ÌïôÏäµ Î∂ÑÏÑù üìä</h2>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 15px;">
                                <div style="font-size: 2rem; font-weight: bold;">${report.totalWords}</div>
                                <div>ÌïôÏäµÌïú Îã®Ïñ¥</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 15px;">
                                <div style="font-size: 2rem; font-weight: bold;">${report.averageAccuracy}%</div>
                                <div>ÌèâÍ∑† Ï†ïÎãµÎ•†</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 15px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #FFB6C1;">${report.weaknesses}</div>
                                <div>ÏïΩÏ†ê Îã®Ïñ¥</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 15px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #90EE90;">${report.strengths}</div>
                                <div>ÏôÑÎ≤ΩÌïú Îã®Ïñ¥</div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; margin: 20px 0; text-align: left;">
                            <h3 style="margin-bottom: 15px; text-align: center;">üí° ÎßûÏ∂§ Ï∂îÏ≤ú</h3>
                            ${report.recommendations.map(rec => `<p style="margin: 10px 0;">${rec}</p>`).join('')}
                        </div>
                        
                        <button onclick="closeLearningReportModal()" style="background: white; color: #667eea; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">
                            ÌôïÏù∏
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // ÌïôÏäµ Î¶¨Ìè¨Ìä∏ Î™®Îã¨ Îã´Í∏∞
        window.closeLearningReportModal = function() {
            const modal = document.getElementById('learning-report-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ÎèôÎ¨º ÏàòÏßë Ïãú ÌäπÎ≥Ñ Ìö®Í≥º
        function showAnimalCollectedEffects(animal) {
            // ÎèôÎ¨ºÎ≥Ñ ÏÉâÏÉÅ ÌååÌã∞ÌÅ¥
            const animalColors = {
                'üê∂': ['#8B4513', '#DEB887'],
                'üê±': ['#FF69B4', '#FFB6C1'], 
                'üê∞': ['#FFFFFF', '#F5F5F5'],
                'Í∏∞Î≥∏': ['#32CD32', '#90EE90']
            };
            
            const colors = animalColors[animal.emoji] || animalColors['Í∏∞Î≥∏'];
            
            // ÌäπÎ≥ÑÌïú ÌååÌã∞ÌÅ¥ Ìö®Í≥º
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.innerHTML = animal.emoji;
                    particle.style.cssText = `
                        position: fixed;
                        font-size: 2rem;
                        pointer-events: none;
                        z-index: 4500;
                        left: ${window.innerWidth / 2 - 20}px;
                        top: ${window.innerHeight / 2 - 20}px;
                        animation: animalCollectEffect 1.5s ease-out forwards;
                        filter: drop-shadow(0 0 10px ${colors[0]});
                    `;
                    
                    // ÎèôÎ¨º ÏàòÏßë Ïï†ÎãàÎ©îÏù¥ÏÖò
                    const collectKeyframes = `
                        @keyframes animalCollectEffect {
                            0% { 
                                transform: scale(0) rotate(0deg); 
                                opacity: 1; 
                            }
                            50% { 
                                transform: scale(1.5) rotate(180deg); 
                                opacity: 0.8; 
                            }
                            100% { 
                                transform: scale(0.5) rotate(360deg) translateY(-100px); 
                                opacity: 0; 
                            }
                        }
                    `;
                    
                    const style = document.createElement('style');
                    style.textContent = collectKeyframes;
                    document.head.appendChild(style);
                    
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.remove();
                        style.remove();
                    }, 1500);
                }, i * 100);
            }
        }

        // ==================== ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Î∞è ÎÜçÏû• Î∞©Î¨∏ Ìï®Ïàò ====================
        
        // ÌîåÎ†àÏù¥ ÏãúÍ∞ÑÏùÑ ÏÇ¨ÎûåÏù¥ ÏùΩÍ∏∞ Ïâ¨Ïö¥ ÌòïÌÉúÎ°ú Î≥ÄÌôò
        function formatPlayTime(minutes) {
            if (minutes < 60) {
                return `${Math.floor(minutes)}Î∂Ñ`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const mins = Math.floor(minutes % 60);
                return `${hours}ÏãúÍ∞Ñ ${mins}Î∂Ñ`;
            } else {
                const days = Math.floor(minutes / 1440);
                const hours = Math.floor((minutes % 1440) / 60);
                return `${days}Ïùº ${hours}ÏãúÍ∞Ñ`;
            }
        }
        
        // ÌòÑÏû¨ ÏÑ∏ÏÖò ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
        function updateSessionPlayTime() {
            if (sessionStartTime) {
                const sessionMinutes = (Date.now() - sessionStartTime) / (1000 * 60);
                return totalPlayTimeMinutes + sessionMinutes;
            }
            return totalPlayTimeMinutes;
        }
        
        // ÎÜçÏû• Î∞©Î¨∏ Î™®Îã¨ Ïó¥Í∏∞
        window.visitUserFarm = async function(userName) {
            try {
                const userData = await loadUserData(userName);
                if (!userData) {
                    alert('ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                document.getElementById('farm-owner-info').textContent = `${userName}ÎãòÏùò ÎÜçÏû•`;
                
                const visitFarmGrid = document.getElementById('visit-farm-grid');
                visitFarmGrid.innerHTML = '';
                
                // 48Í∞ú ÏÖÄ ÏÉùÏÑ±
                for (let i = 0; i < 48; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'farm-cell';
                    
                    const farmItem = userData.farm?.layout?.[i];
                    if (farmItem) {
                        cell.innerHTML = `<span class="${farmItem.isAnimal ? 'placed-animal' : ''}">${farmItem.emoji}</span>`;
                    }
                    
                    visitFarmGrid.appendChild(cell);
                }
                
                document.getElementById('farm-visit-modal').style.display = 'flex';
                
            } catch (error) {
                console.error('ÎÜçÏû• Î∞©Î¨∏ Ïò§Î•ò:', error);
                alert('ÎÜçÏû•ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÎÜçÏû• Î∞©Î¨∏ Î™®Îã¨ Îã´Í∏∞
        window.closeFarmVisitModal = function() {
            document.getElementById('farm-visit-modal').style.display = 'none';
        }

        // ==================== ÌïµÏã¨ Í≤åÏûÑ Ìï®Ïàò ====================
        
        // ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù Ìï®Ïàò
        window.selectDifficulty = function(level) {
            currentDifficulty = level;
            
            // Î™®Îì† Î≤ÑÌäºÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            const selectedBtn = document.querySelector(`[data-level="${level}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            
            // Î≥µÏäµ Î™®Îìú Ïä§ÌÉÄÏùº Ï†ÅÏö©/Ï†úÍ±∞
            const gameContainer = document.querySelector('.game-container');
            if (level === 'review') {
                gameContainer.classList.add('review-mode');
            } else {
                gameContainer.classList.remove('review-mode');
            }
            
            // ÏÉàÎ°úÏö¥ Î¨∏Ï†ú ÏÉùÏÑ±
            generateEnglishQuiz();
        }

        // Îã®Ïñ¥ Î∞úÏùå Ïû¨ÏÉù Ìï®Ïàò
        function speakWord(word) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                const voices = window.speechSynthesis.getVoices();
                let englishVoice = voices.find(voice => voice.lang.startsWith('en-US')) || voices.find(voice => voice.lang.startsWith('en'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                utterance.pitch = 1;
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else {
                alert("Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÏÇ¨Ïö© Ï§ëÏù∏ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏùåÏÑ± Ïû¨ÏÉùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
            }
        }

        // ÏòÅÏñ¥ ÌÄ¥Ï¶à ÏÉùÏÑ± (ÏÉàÎ°úÏö¥ ÏãúÏä§ÌÖú)
        async function generateEnglishQuiz() {
            if (isLoadingWord) return;
            
            isLoadingWord = true;
            
            // UI Ï¥àÍ∏∞Ìôî
            const questionElement = document.getElementById('english-question');
            const optionsContainer = document.getElementById('english-options');
            const speakButton = document.getElementById('speak-button');
            const feedbackElement = document.getElementById('feedback');
            
            questionElement.textContent = 'Îã®Ïñ¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...';
            optionsContainer.innerHTML = '';
            speakButton.style.display = 'none';
            feedbackElement.textContent = '';
            feedbackElement.className = 'feedback';
            
            try {
                if (currentDifficulty === 'review') {
                    await loadReviewWord();
                } else {
                    await loadWordForDifficulty(currentDifficulty);
                }
                
                console.log('Îã®Ïñ¥ Î°úÎìú ÏôÑÎ£å:', currentWordData);
                displayCurrentWord();
                updateWordStats();
                
            } catch (error) {
                console.error('Error generating quiz:', error);
                questionElement.textContent = 'Îã®Ïñ¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                
                // ÏµúÏ¢Ö Ìè¥Î∞±: ÌïòÎìúÏΩîÎî©Îêú Îã®Ïñ¥ ÏÇ¨Ïö©
                const fallbackWords = [
                    { question: 'ÏÇ¨Í≥º', answer: 'apple', options: ['apple', 'banana', 'orange', 'grape'] },
                    { question: 'Í≥†ÏñëÏù¥', answer: 'cat', options: ['cat', 'dog', 'bird', 'fish'] },
                    { question: 'Ï±Ö', answer: 'book', options: ['book', 'pen', 'paper', 'desk'] }
                ];
                const fallbackQuiz = fallbackWords[0];
                
                currentWordData = {
                    id: 'emergency_fallback',
                    korean: fallbackQuiz.question,
                    english: fallbackQuiz.answer,
                    options: fallbackQuiz.options,
                    difficulty: currentDifficulty,
                    source: 'fallback'
                };
                currentEnglishQuiz = {
                    answer: currentWordData.english,
                    wordId: currentWordData.id
                };
                
                console.log('Í∏¥Í∏â Ìè¥Î∞± Îã®Ïñ¥ ÏÇ¨Ïö©:', currentWordData);
                displayCurrentWord();
            } finally {
                isLoadingWord = false;
            }
        }

        // ÎÇúÏù¥ÎèÑÎ≥Ñ Îã®Ïñ¥ Î°úÎìú
        async function loadWordForDifficulty(difficulty) {
            try {
                console.log(`Î†àÎ≤® ${difficulty} Îã®Ïñ¥ JSON ÌååÏùº Î°úÎî© ÏãúÏûë...`);
                
                const response = await fetch(getSubjectFilePath(difficulty));
                
                if (!response.ok) {
                    throw new Error(`JSON ÌååÏùº Î°úÎìú Ïã§Ìå®: ${response.status}`);
                }
                
                const data = await response.json();
                const words = data.words;
                
                if (!words || words.length === 0) {
                    throw new Error('JSON ÌååÏùºÏóê Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§');
                }
                
                // ÏµúÍ∑º Ï∂úÏ†úÎêú Î¨∏Ï†úÎ•º ÌîºÌïòÎ©¥ÏÑú ÎûúÎç§ÏúºÎ°ú Îã®Ïñ¥ ÏÑ†ÌÉù
                const recentQuestions = gameState.recentQuestions || [];
                const maxRecentQuestions = Math.min(words.length - 1, 5); // ÏµúÎåÄ 5Í∞úÍπåÏßÄ Í∏∞Ïñµ
                
                let availableWords = words;
                
                // Ï∂©Î∂ÑÌïú Î¨∏Ï†úÍ∞Ä ÏûàÍ≥† ÏµúÍ∑º Î¨∏Ï†úÍ∞Ä ÏûàÎã§Î©¥ Ï†úÏô∏
                if (words.length > maxRecentQuestions && recentQuestions.length > 0) {
                    availableWords = words.filter((word, index) => {
                        const questionId = word.question || word.korean || index;
                        return !recentQuestions.includes(questionId);
                    });
                    
                    // Î™®Îì† Î¨∏Ï†úÍ∞Ä ÏµúÍ∑º Ï∂úÏ†úÎêòÏóàÎã§Î©¥ ÏµúÍ∑º Í∏∞Î°ù Ï¥àÍ∏∞Ìôî
                    if (availableWords.length === 0) {
                        gameState.recentQuestions = [];
                        availableWords = words;
                    }
                }
                
                // Í∞úÏÑ†Îêú ÎûúÎç§ ÏÑ†ÌÉù (ÏãúÍ∞Ñ Í∏∞Î∞ò ÏãúÎìú ÏÇ¨Ïö©)
                const now = Date.now();
                const randomSeed = (now % 1000) * Math.random();
                const randomIndex = Math.floor(randomSeed * availableWords.length / 1000);
                const randomWord = availableWords[randomIndex];
                
                // ÏÑ†ÌÉùÎêú Î¨∏Ï†úÎ•º ÏµúÍ∑º Î¨∏Ï†ú Î™©Î°ùÏóê Ï∂îÍ∞Ä
                if (!gameState.recentQuestions) gameState.recentQuestions = [];
                const questionId = randomWord.question || randomWord.korean || words.indexOf(randomWord);
                gameState.recentQuestions.push(questionId);
                
                // ÏµúÍ∑º Î¨∏Ï†ú Î™©Î°ù ÌÅ¨Í∏∞ Ï†úÌïú
                if (gameState.recentQuestions.length > maxRecentQuestions) {
                    gameState.recentQuestions.shift(); // Í∞ÄÏû• Ïò§ÎûòÎêú Í≤É Ï†úÍ±∞
                }
                
                currentWordData = {
                    id: generateSubjectWordId(randomWord.korean || randomWord.question, randomWord.english || randomWord.options[randomWord.answer]),
                    korean: randomWord.korean || randomWord.question,
                    english: randomWord.english || randomWord.options[randomWord.answer],
                    options: randomWord.options,
                    difficulty: difficulty,
                    source: 'json',
                    answer: randomWord.answer,
                    explanation: randomWord.explanation
                };
                
                currentEnglishQuiz = {
                    answer: currentWordData.english,
                    wordId: currentWordData.id
                };
                
                console.log('JSONÏóêÏÑú Îã®Ïñ¥ Î°úÎìú ÏÑ±Í≥µ:', currentWordData);
                
            } catch (error) {
                console.error('JSON Îã®Ïñ¥ Î°úÎìú Ïã§Ìå®, Ìè¥Î∞± ÏÇ¨Ïö©:', error);
                
                // Ìè¥Î∞±: Í∏∞Ï°¥ ÌïòÎìúÏΩîÎî©Îêú Îã®Ïñ¥ ÏÇ¨Ïö©
                const fallbackWords = [
                    { question: 'ÏÇ¨Í≥º', answer: 'apple', options: ['apple', 'banana', 'orange', 'grape'] },
                    { question: 'Í≥†ÏñëÏù¥', answer: 'cat', options: ['cat', 'dog', 'bird', 'fish'] },
                    { question: 'Ï±Ö', answer: 'book', options: ['book', 'pen', 'paper', 'desk'] },
                    { question: 'Ïßë', answer: 'house', options: ['house', 'school', 'park', 'store'] },
                    { question: 'Î¨º', answer: 'water', options: ['water', 'juice', 'milk', 'tea'] }
                ];
                
                const fallbackQuiz = fallbackWords[Math.floor(Math.random() * fallbackWords.length)];
                
                currentWordData = {
                    id: 'fallback_' + Date.now(),
                    korean: fallbackQuiz.question,
                    english: fallbackQuiz.answer,
                    options: fallbackQuiz.options,
                    difficulty: difficulty,
                    source: 'fallback'
                };
                
                currentEnglishQuiz = {
                    answer: currentWordData.english,
                    wordId: currentWordData.id
                };
                
                console.log('Ìè¥Î∞± Îã®Ïñ¥ ÏÇ¨Ïö©:', currentWordData);
            }
        }

        // Î≥µÏäµÏö© Îã®Ïñ¥ Î°úÎìú
        async function loadReviewWord() {
            // Î°úÏª¨ ÏßÑÌñâÎèÑÏóêÏÑú ÌãÄÎ¶∞ Îã®Ïñ¥Îì§ Ï∞æÍ∏∞
            const strugglingWords = [];
            
            for (const [wordId, progress] of Object.entries(userProgress)) {
                const total = progress.correct + progress.incorrect;
                if (total >= 3 && progress.incorrect > progress.correct) {
                    strugglingWords.push(wordId);
                }
            }
            
            if (strugglingWords.length === 0) {
                alert('Î≥µÏäµÌï† Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§! Îçî ÎßéÏùÄ Î¨∏Ï†úÎ•º ÌíÄÏñ¥Î≥¥ÏÑ∏Ïöî.');
                await loadWordForDifficulty(1);
                return;
            }
            
            // Î≥µÏäµ Îã®Ïñ¥Í∞Ä ÏûàÏúºÎ©¥ Ïâ¨Ïö¥ Î†àÎ≤®Î∂ÄÌÑ∞ JSONÏóêÏÑú Î°úÎìú
            console.log('Î≥µÏäµ Î™®Îìú: JSON ÌååÏùºÏóêÏÑú Îã®Ïñ¥ Î°úÎìú');
            await loadWordForDifficulty(1); // Î≥µÏäµÌï† ÎïåÎäî Ïâ¨Ïö¥ Îã®Ïñ¥Î∂ÄÌÑ∞
        }
    
        // ÌòÑÏû¨ Îã®Ïñ¥ ÌëúÏãú
        function displayCurrentWord() {
            if (!currentWordData) return;
            
            const questionElement = document.getElementById('english-question');
            const optionsContainer = document.getElementById('english-options');
            const speakButton = document.getElementById('speak-button');
            const wordSourceElement = document.getElementById('word-source');
            const sourceBadge = document.getElementById('source-badge');
            
            // ÏßàÎ¨∏ ÌëúÏãú (Í≥ºÎ™©Ïóê Îî∞Îùº Îã§Î¶Ñ)
            if (gameState.currentSubject === 'english') {
                questionElement.textContent = `"${currentWordData.korean}"`; // ÏòÅÏñ¥ Í≥ºÎ™©
                speakButton.style.display = 'inline';
                speakButton.onclick = () => speakWord(currentEnglishQuiz.answer);
            } else {
                // ÏÇ¨Ìöå, ÏàòÌïô, ÏÉÅÏãù Í≥ºÎ™©: ÏßÅÏ†ë ÏßàÎ¨∏ ÌëúÏãú
                questionElement.textContent = currentWordData.korean; 
                speakButton.style.display = 'none'; // ÏùåÏÑ± Í∏∞Îä• ÏóÜÏùå
            }
            
            // Îã®Ïñ¥ Ï∂úÏ≤ò ÌëúÏãú
            wordSourceElement.style.display = 'block';
            
            if (currentWordData.source === 'json') {
                sourceBadge.className = 'source-badge json-file';
                sourceBadge.innerHTML = 'üìÅ JSON ÌååÏùº';
                sourceBadge.title = 'GitHub Pages JSON ÌååÏùºÏóêÏÑú Î°úÎìúÎêú Îã®Ïñ¥ÏûÖÎãàÎã§';
            } else if (currentWordData.source === 'ai') {
                sourceBadge.className = 'source-badge ai-generated';
                sourceBadge.innerHTML = 'ü§ñ AI ÏÉùÏÑ±';
                sourceBadge.title = 'Gemini AIÍ∞Ä ÏÉùÏÑ±Ìïú Îã®Ïñ¥ÏûÖÎãàÎã§';
            } else if (currentWordData.source === 'fallback') {
                sourceBadge.className = 'source-badge fallback';
                sourceBadge.innerHTML = 'üîÑ ÎåÄÏ≤¥ Îã®Ïñ¥';
                sourceBadge.title = 'JSON Î°úÎìú Ïã§Ìå®Î°ú ÎåÄÏ≤¥Îêú Îã®Ïñ¥ÏûÖÎãàÎã§';
            } else {
                sourceBadge.className = 'source-badge hardcoded';
                sourceBadge.innerHTML = 'üìù Í∏∞Î≥∏ Îã®Ïñ¥';
                sourceBadge.title = 'ÎØ∏Î¶¨ Ï§ÄÎπÑÎêú Îã®Ïñ¥ÏûÖÎãàÎã§';
            }
            
            // ÏòµÏÖò ÏÉùÏÑ±
            let finalOptions = [];
            
            if (currentWordData.options && currentWordData.options.length >= 4) {
                const correctAnswer = currentWordData.english;
                const wrongOptions = currentWordData.options.filter(opt => opt !== correctAnswer);
                const shuffledWrong = wrongOptions.sort(() => Math.random() - 0.5).slice(0, 3);
                finalOptions = [correctAnswer, ...shuffledWrong].sort(() => Math.random() - 0.5);
            } else {
                finalOptions = [...currentWordData.options].sort(() => Math.random() - 0.5);
            }
            
            console.log('ÌëúÏãúÌï† ÏòµÏÖòÎì§:', finalOptions);
            
            optionsContainer.innerHTML = '';
            finalOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'english-option-btn';
                button.innerText = option;
                button.onclick = () => checkEnglishQuizAnswer(option);
                optionsContainer.appendChild(button);
            });
        }

        // Îã®Ïñ¥ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateWordStats() {
            if (!currentWordData || !currentWordData.id) return;
            
            const progress = userProgress[currentWordData.id] || { correct: 0, incorrect: 0 };
            const total = progress.correct + progress.incorrect;
            const accuracy = total > 0 ? Math.round((progress.correct / total) * 100) : 0;
            
            document.getElementById('word-correct').textContent = progress.correct;
            document.getElementById('word-incorrect').textContent = progress.incorrect;
            document.getElementById('word-accuracy').textContent = accuracy;
            document.getElementById('learning-stats').style.display = 'block';
        }

        // ÏòÅÏñ¥ ÌÄ¥Ï¶à Ï†ïÎãµ ÌôïÏù∏ (ÏÉàÎ°úÏö¥ ÏãúÏä§ÌÖú)
        async function checkEnglishQuizAnswer(selectedOption) {
            const optionsContainer = document.getElementById('english-options');
            optionsContainer.querySelectorAll('.english-option-btn').forEach(btn => {
                btn.disabled = true;
            });

            const feedback = document.getElementById('feedback');
            
            // Ï†ïÎãµ Ï≤¥ÌÅ¨ (Í≥ºÎ™©Ïóê Îî∞Îùº Îã§Î¶Ñ)
            let isCorrect = false;
            if (gameState.currentSubject === 'english') {
                // ÏòÅÏñ¥ Í≥ºÎ™©: Í∏∞Ï°¥ Î∞©Ïãù (ÌÖçÏä§Ìä∏ Îß§Ïπ≠)
                isCorrect = selectedOption === currentEnglishQuiz.answer;
            } else {
                // ÏÇ¨Ìöå, ÏàòÌïô, ÏÉÅÏãù Í≥ºÎ™©: selectedOptionÏù¥ ÏÑ†ÌÉùÏßÄ ÌÖçÏä§Ìä∏, answerÎäî Ïù∏Îç±Ïä§
                const selectedIndex = currentWordData.options.indexOf(selectedOption);
                isCorrect = selectedIndex === currentWordData.answer;
            }
            
            // ÌïôÏäµ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            if (currentWordData && currentWordData.id) {
                if (!userProgress[currentWordData.id]) {
                    userProgress[currentWordData.id] = { correct: 0, incorrect: 0, lastSeen: new Date() };
                }
                
                if (isCorrect) {
                    userProgress[currentWordData.id].correct++;
                    // Í≥ºÎ™©Î≥Ñ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    gameState.subjects[gameState.currentSubject].totalCorrect++;
                } else {
                    userProgress[currentWordData.id].incorrect++;
                    // Í≥ºÎ™©Î≥Ñ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    gameState.subjects[gameState.currentSubject].totalIncorrect++;
                }
                userProgress[currentWordData.id].lastSeen = new Date();
                
                // FirebaseÏóê ÌïôÏäµ Í∏∞Î°ù Ï†ÄÏû•
                await saveUserProgress();
            }
            
            if (isCorrect) {
                // ÏòÅÏñ¥ Í≥ºÎ™©Îßå ÏùåÏÑ± Ïû¨ÏÉù
                if (gameState.currentSubject === 'english') {
                    speakWord(currentEnglishQuiz.answer);
                }
                
                // ÎÇúÏù¥ÎèÑÎ≥Ñ Ï†êÏàò Í≥ÑÏÇ∞
                let baseScore = 10;
                if (currentDifficulty === 2) baseScore = 20;
                else if (currentDifficulty === 3) baseScore = 30;
                else if (currentDifficulty === 'review') baseScore = 15; // Î≥µÏäµ Î≥¥ÎÑàÏä§
                
                const earnedScore = baseScore * gameState.level;
                gameState.score += earnedScore;
                
                // Í≥ºÎ™©Î≥Ñ ÌîºÎìúÎ∞± Î©îÏãúÏßÄ
                let correctMessage = '';
                if (gameState.currentSubject === 'english') {
                    correctMessage = `Ï†ïÎãµ! +${earnedScore}Ï†ê! ÎèôÎ¨ºÏùÑ Ïû°ÏïòÏñ¥Ïöî! üéâ`;
                } else {
                    // ÏÇ¨Ìöå, ÏàòÌïô, ÏÉÅÏãù Í≥ºÎ™©: Ìï¥ÏÑ§ Ìè¨Ìï®
                    correctMessage = `Ï†ïÎãµ! +${earnedScore}Ï†ê! ÎèôÎ¨ºÏùÑ Ïû°ÏïòÏñ¥Ïöî! üéâ`;
                    if (currentWordData.explanation) {
                        correctMessage += ` ${currentWordData.explanation}`;
                    }
                }
                
                feedback.textContent = correctMessage;
                feedback.className = 'feedback correct';
                
                // Ï†ïÎãµ Ïãú ÌôîÎ†§Ìïú Ìö®Í≥º
                showCorrectAnswerEffects();
                
                const newAnimal = getRandomAnimal();
                addAnimal(newAnimal);
                
                // ÎèôÎ¨º ÏàòÏßë ÌäπÎ≥Ñ Ìö®Í≥º
                setTimeout(() => {
                    const animalData = animalTypes.find(a => a.name === newAnimal);
                    if (animalData) {
                        showAnimalCollectedEffects(animalData);
                    }
                }, 500);
                
                // Î†àÎ≤®ÏóÖ Ï°∞Í±¥ Ï≤¥ÌÅ¨
                if (gameState.score >= Math.pow(gameState.level, 2) * 2000) { 
                    gameState.level++;
                    showLevelUp();
                }
                
                // ÎûúÎç§ Ïù¥Î≤§Ìä∏ Ï≤¥ÌÅ¨
                checkRandomEvent();
                
                saveCurrentUserData();
                setTimeout(() => generatePersonalizedQuiz(), 1500);
            } else {
                // Í≥ºÎ™©Î≥Ñ Ïò§Îãµ ÌîºÎìúÎ∞±
                let incorrectMessage = '';
                if (gameState.currentSubject === 'english') {
                    incorrectMessage = `ÏïÑ! Ï†ïÎãµÏùÄ "${currentEnglishQuiz.answer}"ÏòÄÏñ¥Ïöî. Îã§Ïãú ÎèÑÏ†ÑÌïòÏÑ∏Ïöî!`;
                } else {
                    // ÏÇ¨Ìöå, ÏàòÌïô, ÏÉÅÏãù Í≥ºÎ™©: Ï†ïÎãµÍ≥º Ìï¥ÏÑ§ ÌëúÏãú
                    const correctAnswer = currentWordData.options[currentWordData.answer];
                    incorrectMessage = `ÏïÑ! Ï†ïÎãµÏùÄ "${correctAnswer}"ÏòÄÏñ¥Ïöî.`;
                    if (currentWordData.explanation) {
                        incorrectMessage += ` ${currentWordData.explanation}`;
                    }
                }
                
                feedback.textContent = incorrectMessage;
                feedback.className = 'feedback incorrect';
                
                // Ïò§Îãµ Ïãú ÌîºÎìúÎ∞± Ìö®Í≥º
                showIncorrectAnswerEffects();
                setTimeout(() => generatePersonalizedQuiz(), 2500);
            }
            
            updateUI();
            updateWordStats();
        }

        // ÏÇ¨Ïö©Ïûê ÌïôÏäµ ÏßÑÌñâÎèÑ Ï†ÄÏû•
        async function saveUserProgress() {
            if (!currentUserProfile.name) return;
            
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const progressDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/progress", currentUserProfile.name);
                
                await window.firebase.setDoc(progressDocRef, {
                    userId: currentUserProfile.name,
                    progress: userProgress,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                
                console.log("User progress saved");
            } catch (error) {
                console.error("Error saving user progress:", error);
            }
        }

        // ÏÇ¨Ïö©Ïûê ÌïôÏäµ ÏßÑÌñâÎèÑ Î°úÎìú
        async function loadUserProgress() {
            if (!currentUserProfile.name) return;
            
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const progressDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/progress", currentUserProfile.name);
                const docSnap = await window.firebase.getDoc(progressDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userProgress = data.progress || {};
                    console.log("User progress loaded");
                } else {
                    userProgress = {};
                }
            } catch (error) {
                console.error("Error loading user progress:", error);
                userProgress = {};
            }
        }

        // ÎèôÎ¨º Î†àÎ≤®ÏóÖÏùÑ ÏúÑÌïú ÏàòÌïô Î¨∏Ï†ú ÏÉùÏÑ±
        function generateMathProblemForLevelUp(animalLevel) {
            const difficulty = Math.min(Math.floor(animalLevel / 5) + 1, 4);
            let question = {};
            
            switch(difficulty) {
                case 1:
                    const a1 = Math.floor(Math.random() * 10) + 1;
                    const b1 = Math.floor(Math.random() * 10) + 1;
                    if (Math.random() > 0.5) { question = {text: `${a1} + ${b1}`, answer: a1 + b1}; } 
                    else { const l = Math.max(a1, b1), s = Math.min(a1, b1); question = {text: `${l} - ${s}`, answer: l - s}; }
                    break;
                case 2:
                    const a2 = Math.floor(Math.random() * 90) + 10;
                    const b2 = Math.floor(Math.random() * 90) + 10;
                    if (Math.random() > 0.5) { question = {text: `${a2} + ${b2}`, answer: a2 + b2}; }
                    else { const l = Math.max(a2, b2), s = Math.min(a2, b2); question = {text: `${l} - ${s}`, answer: l - s}; }
                    break;
                case 3:
                    const a3 = Math.floor(Math.random() * 8) + 2;
                    const b3 = Math.floor(Math.random() * 8) + 2;
                    question = {text: `${a3} √ó ${b3}`, answer: a3 * b3};
                    break;
                case 4:
                    const a4 = Math.floor(Math.random() * 900) + 100;
                    const b4 = Math.floor(Math.random() * 900) + 100;
                    if (Math.random() > 0.5) { question = {text: `${a4} + ${b4}`, answer: a4 + b4}; }
                    else { const l = Math.max(a4, b4), s = Math.min(a4, b4); question = {text: `${l} - ${s}`, answer: l - s}; }
                    break;
            }
            gameState.currentQuestion = question;
            document.getElementById('math-question').textContent = `${question.text} = ?`;
        }

        // ÏàòÌïô Î¨∏Ï†ú Î™®Îã¨ Ïó¥Í∏∞
        function startMathProblem(animalName) {
            const animal = gameState.animals[animalName];
            generateMathProblemForLevelUp(animal.animalLevel);
            
            const answerInput = document.getElementById('math-answer-input');
            const submitBtn = document.getElementById('math-submit-btn');
            
            answerInput.value = '';
            document.getElementById('math-feedback').textContent = '';
            
            answerInput.disabled = false;
            submitBtn.disabled = false;

            submitBtn.onclick = () => checkMathAnswer(animalName);
            document.getElementById('math-modal').style.display = 'flex';
            answerInput.focus();
        }

        // ÏàòÌïô Î¨∏Ï†ú Ï†ïÎãµ ÌôïÏù∏
        function checkMathAnswer(animalName) {
            const answerInput = document.getElementById('math-answer-input');
            const submitBtn = document.getElementById('math-submit-btn');
            const userAnswer = parseInt(answerInput.value);
            const feedback = document.getElementById('math-feedback');
            
            if (isNaN(userAnswer)) {
                feedback.textContent = 'Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!';
                feedback.style.color = 'red';
                return;
            }
            
            answerInput.disabled = true;
            submitBtn.disabled = true;

            if (userAnswer === gameState.currentQuestion.answer) {
                const animal = gameState.animals[animalName];
                gameState.score += 15 * animal.animalLevel;
                animal.animalLevel++;
                
                feedback.textContent = `Ï†ïÎãµ! ${animal.name}Ïùò Î†àÎ≤®Ïù¥ ${animal.animalLevel}Ïù¥ ÎêòÏóàÏñ¥Ïöî!`;
                feedback.style.color = 'green';

                // ÎûúÎç§ Ïù¥Î≤§Ìä∏ Ï≤¥ÌÅ¨
                checkRandomEvent();

                updateUI();
                updateAnimalCollection();
                saveCurrentUserData();
                setTimeout(closeMathModal, 1500);
            } else {
                feedback.textContent = `Îï°! Îã§Ïãú ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî.`;
                feedback.style.color = 'red';
                setTimeout(() => {
                    answerInput.disabled = false;
                    submitBtn.disabled = false;
                    answerInput.focus();
                }, 1000);
            }
        }

        function closeMathModal() {
            document.getElementById('math-modal').style.display = 'none';
        }

        function getRandomAnimal() {
            const maxRarity = Math.min(Math.floor(gameState.level / 2) + 1, 6);
            const availableAnimals = animalTypes.filter(animal => animal.rarity <= maxRarity);
            const weights = availableAnimals.map(animal => Math.pow(0.7, animal.rarity - 1));
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            for (let i = 0; i < availableAnimals.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return availableAnimals[i];
                }
            }
            return availableAnimals[0];
        }

        function addAnimal(animal) {
            const key = animal.name;
            if (!gameState.animals[key]) {
                gameState.animals[key] = {
                    ...animal,
                    count: 0,
                    animalLevel: 1,
                    story: ""
                };
                gameState.speciesCount++;
                showNewAnimalAlert(animal);
            }
            
            gameState.animals[key].count++;
            gameState.totalAnimals++;
            
            updateAnimalCollection();
        }

        // ==================== ÌïôÏäµ ÌÜµÍ≥Ñ Í¥ÄÎ†® Ìï®Ïàò ====================
        
        async function updateLearningStats() {
            // userProgressÍ∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò Î°úÎìúÎêòÏßÄ ÏïäÏïòÎã§Î©¥ Îã§Ïãú Î°úÎìú ÏãúÎèÑ
            if (!currentUserProfile || Object.keys(userProgress).length === 0) {
                await loadUserProgress();
            }

            const progressEntries = Object.entries(userProgress);

            // Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
            let totalCorrect = 0;
            let totalIncorrect = 0;
            let masteredCount = 0;

            progressEntries.forEach(([wordId, progress]) => {
                totalCorrect += progress.correct;
                totalIncorrect += progress.incorrect;
                const total = progress.correct + progress.incorrect;
                if (total >= 3 && (progress.correct / total) >= 0.8) {
                    masteredCount++;
                }
            });

            const totalAttempts = totalCorrect + totalIncorrect;
            const overallAccuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;

            // Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ ÌëúÏãú
            const totalLearnedEl = document.getElementById('total-words-learned');
            const totalCorrectEl = document.getElementById('total-correct');
            const totalAccuracyEl = document.getElementById('total-accuracy');
            const masteredWordsEl = document.getElementById('mastered-words');

            if (totalLearnedEl) totalLearnedEl.textContent = progressEntries.length;
            if (totalCorrectEl) totalCorrectEl.textContent = totalCorrect;
            if (totalAccuracyEl) totalAccuracyEl.textContent = overallAccuracy + '%';
            if (masteredWordsEl) masteredWordsEl.textContent = masteredCount;

            // Ï∑®ÏïΩ/Ïö∞Ïàò Îã®Ïñ¥ ÌëúÏãú
            updateWeakWords(progressEntries);
            updateStrongWords(progressEntries);
        }

        function updateWeakWords(progressEntries) {
            console.log("updateWeakWords Ìò∏Ï∂úÎê®", progressEntries);

            const weakWordsGrid = document.getElementById('weak-words-grid');
            if (!weakWordsGrid) {
                console.error("weak-words-grid ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå");
                return;
            }

            const weakWords = progressEntries.filter(([wordId, progress]) => {
                const total = progress.correct + progress.incorrect;
                console.log(`[ÌïÑÌÑ∞ÎßÅ] Îã®Ïñ¥ ID: ${wordId}, Ï†ïÎãµ: ${progress.correct}, Ïò§Îãµ: ${progress.incorrect}, Ìï©Í≥Ñ: ${total}`);
                return total >= 3 && progress.incorrect > progress.correct;
            });

            console.log("Ï∑®ÏïΩ Îã®Ïñ¥ ÌõÑÎ≥¥:", weakWords);

            if (weakWords.length === 0) {
                weakWordsGrid.innerHTML = '<p class="no-data">Î≥µÏäµÏù¥ ÌïÑÏöîÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§. Îçî ÎßéÏùÄ Î¨∏Ï†úÎ•º ÌíÄÏñ¥Î≥¥ÏÑ∏Ïöî!</p>';
                return;
            }

            weakWords.sort(([,a], [,b]) => {
                const aAccuracy = a.correct / (a.correct + a.incorrect);
                const bAccuracy = b.correct / (b.correct + b.incorrect);
                return aAccuracy - bAccuracy;
            });

            weakWordsGrid.innerHTML = '';
            weakWords.slice(0, 12).forEach(([wordId, progress]) => {
                const total = progress.correct + progress.incorrect;
                const accuracy = Math.round((progress.correct / total) * 100);
                const card = document.createElement('div');
                card.className = 'word-progress-card';
                card.innerHTML = `
                    <div class="word-pair">Îã®Ïñ¥ ID: ${wordId}</div>
                    <div class="progress-stats">
                        <span>Ï†ïÎãµ: ${progress.correct}</span>
                        <span>Ïò§Îãµ: ${progress.incorrect}</span>
                    </div>
                    <div class="accuracy-bar">
                        <div class="accuracy-fill" style="width: ${accuracy}%"></div>
                    </div>
                    <div style="text-align: center; font-size: 0.9rem; color: #FF6B6B;">Ï†ïÎãµÎ•†: ${accuracy}%</div>`;
                weakWordsGrid.appendChild(card);
            });
        }
        
        function updateStrongWords(progressEntries) {
            console.log("updateStrongWords Ìò∏Ï∂úÎê®", progressEntries);

            const strongWordsGrid = document.getElementById('strong-words-grid');
            if (!strongWordsGrid) {
                console.error("strong-words-grid ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå");
                return;
            }

            const strongWords = progressEntries.filter(([wordId, progress]) => {
                const total = progress.correct + progress.incorrect;
                console.log(`[ÌïÑÌÑ∞ÎßÅ] Îã®Ïñ¥ ID: ${wordId}, Ï†ïÎãµ: ${progress.correct}, Ïò§Îãµ: ${progress.incorrect}, Ìï©Í≥Ñ: ${total}`);
                return total >= 3 && (progress.correct / total) >= 0.8;
            });

            console.log("Ïö∞Ïàò Îã®Ïñ¥ ÌõÑÎ≥¥:", strongWords);

            if (strongWords.length === 0) {
                strongWordsGrid.innerHTML = '<p class="no-data">ÏïÑÏßÅ ÏôÑÏ†ÑÌûà ÌïôÏäµÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            strongWords.sort(([,a], [,b]) => {
                const aAccuracy = a.correct / (a.correct + a.incorrect);
                const bAccuracy = b.correct / (b.correct + b.incorrect);
                return bAccuracy - aAccuracy;
            });

            strongWordsGrid.innerHTML = '';
            strongWords.slice(0, 12).forEach(([wordId, progress]) => {
                const total = progress.correct + progress.incorrect;
                const accuracy = Math.round((progress.correct / total) * 100);
                const card = document.createElement('div');
                card.className = 'word-progress-card strong';
                card.innerHTML = `
                    <div class="word-pair">Îã®Ïñ¥ ID: ${wordId}</div>
                    <div class="progress-stats">
                        <span>Ï†ïÎãµ: ${progress.correct}</span>
                        <span>Ïò§Îãµ: ${progress.incorrect}</span>
                    </div>
                    <div class="accuracy-bar">
                        <div class="accuracy-fill" style="width: ${accuracy}%"></div>
                    </div>
                    <div style="text-align: center; font-size: 0.9rem; color: #4CAF50;">Ï†ïÎãµÎ•†: ${accuracy}%</div>`;
                strongWordsGrid.appendChild(card);
            });
        }

        // ==================== UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (ÏÉÅÎã®ÏúºÎ°ú Ïù¥ÎèôÎê®) ====================

        // (updateUI and updateAnimalCollection Ìï®ÏàòÎì§ÏùÄ ÏÉÅÎã®ÏúºÎ°ú Ïù¥ÎèôÎê®)
                
                let borderColor = '#87CEEB';
                if (animal.rarity >= 5) borderColor = '#FFD700';
                else if (animal.rarity >= 4) borderColor = '#9370DB';
                else if (animal.rarity >= 3) borderColor = '#32CD32';
                
                card.style.borderColor = borderColor;
                card.style.boxShadow = `0 6px 20px ${borderColor}40`;
                
                // ÌåêÎß§Í∞Ä Í≥ÑÏÇ∞
                const sellPrice = (animal.animalLevel * 10) + (animal.rarity * 5);
                
                card.innerHTML = `
                    <span class="animal-emoji">${animal.emoji}</span>
                    <div class="animal-name">${animal.name} (${animal.count}ÎßàÎ¶¨)</div>
                    <div class="animal-level">Lv. ${animal.animalLevel || 1}</div>
                    <div class="special-name">"${animal.specialName}"</div>
                    <div class="rarity-badge">‚òÖ${animal.rarity}</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">ÌåêÎß§Í∞Ä: ${sellPrice}ü™ô</div>
                    <div style="font-size: 0.7rem; color: #999; text-align: center; margin-top: 3px;">üìñ ÌÅ¥Î¶≠ÌïòÎ©¥ Ïù¥ÏïºÍ∏∞Î•º Îì§ÏùÑ Ïàò ÏûàÏñ¥Ïöî</div>
                    <div style="margin-top: 10px; display: flex; gap: 5px; justify-content: center;">
                        <button onclick="event.stopPropagation(); startMathProblem('${animal.name}')" style="background: #4169E1; color: white; border: none; padding: 8px 12px; border-radius: 10px; font-size: 0.8rem; cursor: pointer;">Î†àÎ≤®ÏóÖ</button>
                        <button onclick="event.stopPropagation(); quickSellAnimal('${animal.name}')" style="background: #FF6B6B; color: white; border: none; padding: 8px 12px; border-radius: 10px; font-size: 0.8rem; cursor: pointer;">üí∞ÌåêÎß§</button>
                    </div>
                `;

                // Ïπ¥Îìú ÌÅ¥Î¶≠Ïãú Ïä§ÌÜ†Î¶¨ ÌëúÏãú
                card.onclick = () => {
                    generateAnimalStory(animal);
                };
                
                collection.appendChild(card);
            });
        }

        // Î∞îÎ°ú ÌåêÎß§ ÏãúÏä§ÌÖú
        window.quickSellAnimal = function(animalName) {
            const animal = gameState.animals[animalName];
            if (!animal || animal.count <= 0) {
                alert('ÌåêÎß§Ìï† ÎèôÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // Î†àÎ≤®Î≥Ñ ÌåêÎß§Í∞Ä Í≥ÑÏÇ∞
            const basePrice = animal.animalLevel * 10;
            const rarityBonus = animal.rarity * 5;
            const finalPrice = basePrice + rarityBonus;
            
            const confirmMessage = `${animal.name} (Lv.${animal.animalLevel}, ‚òÖ${animal.rarity})ÏùÑ(Î•º) ${finalPrice}ü™ôÏóê ÌåêÎß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nüí° Í≥ÑÏÇ∞Î≤ï: (Î†àÎ≤® ${animal.animalLevel} √ó 10) + (Ìù¨Í∑ÄÎèÑ ${animal.rarity} √ó 5) = ${finalPrice}ü™ô`;
            
            if (confirm(confirmMessage)) {
                // ÎèôÎ¨º Ï†úÍ±∞
                animal.count--;
                gameState.totalAnimals--;
                
                // ÎèôÎ¨ºÏù¥ 0ÎßàÎ¶¨Í∞Ä ÎêòÎ©¥ Ï¢ÖÎ•òÏóêÏÑúÎèÑ Ï†úÍ±∞
                if (animal.count <= 0) {
                    gameState.speciesCount--;
                    delete gameState.animals[animalName];
                }
                
                // ÏΩîÏù∏ Ï∂îÍ∞Ä
                gameState.coins += finalPrice;
                
                // ÌåêÎß§ ÏôÑÎ£å ÏïåÎ¶º
                const sellAlert = document.createElement('div');
                sellAlert.className = 'new-animal-alert';
                sellAlert.style.background = 'linear-gradient(45deg, #32CD32, #90EE90)';
                sellAlert.innerHTML = `
                    <span class="new-animal-emoji">üí∞</span>
                    <h3>ÌåêÎß§ ÏôÑÎ£å! üéâ</h3>
                    <p><strong>${animal.name}</strong>ÏùÑ(Î•º) <strong>${finalPrice}ü™ô</strong>Ïóê ÌåêÎß§ÌñàÏäµÎãàÎã§!</p>
                `;
                document.body.appendChild(sellAlert);
                setTimeout(() => { sellAlert.remove(); }, 3000);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateUI();
                updateAnimalCollection();
                saveCurrentUserData();
                
                console.log(`${animalName} ÌåêÎß§ ÏôÑÎ£å: +${finalPrice}ü™ô`);
            }
        }
        
        function updateEncyclopedia() {
            const grid = document.getElementById('encyclopedia-grid');
            grid.innerHTML = '';

            const collectedCount = gameState.speciesCount;
            const totalCount = animalTypes.length;
            document.getElementById('collection-progress').textContent = `${collectedCount} / ${totalCount}`;
            
            const progressPercent = totalCount > 0 ? (collectedCount / totalCount) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;

            animalTypes.forEach(animal => {
                const collectedAnimal = gameState.animals[animal.name];
                const card = document.createElement('div');
                card.className = 'encyclopedia-card';
                
                if (collectedAnimal && collectedAnimal.count > 0) {
                    card.innerHTML = `
                        <span class="animal-emoji">${animal.emoji}</span>
                        <div class="animal-name">${animal.name}</div>
                        <div class="animal-count">${collectedAnimal.count}ÎßàÎ¶¨ Î≥¥Ïú†</div>
                        <div class="rarity-badge">‚òÖ${animal.rarity}</div>
                        <button class="story-btn">Ïù¥ÏïºÍ∏∞ Îì£Í∏∞ üìñ</button>
                    `;
                    card.querySelector('.story-btn').onclick = (event) => {
                        event.stopPropagation();
                        generateAnimalStory(collectedAnimal);
                    };
                } else {
                    card.classList.add('uncollected');
                    card.innerHTML = `
                        <span class="animal-emoji">‚ùì</span>
                        <div class="animal-name">???</div>
                        <div class="animal-count">ÎØ∏Î∞úÍ≤¨</div>
                        <div class="rarity-badge">‚òÖ${animal.rarity}</div>
                    `;
                }
                grid.appendChild(card);
            });
        }

        // ==================== ÎÜçÏû• Í¥ÄÎ†® Ìï®Ïàò ====================
        
        function initializeFarm() {
            const farmGrid = document.getElementById('farm-grid');
            if (!farmGrid) return;
            
            farmGrid.innerHTML = '';
            for (let i = 0; i < 48; i++) {
                const cell = document.createElement('div');
                cell.className = 'farm-cell';
                cell.dataset.index = i;
                cell.onclick = (event) => placeItemOnFarm(i, event);
                cell.oncontextmenu = (event) => {
                    event.preventDefault();
                    removeItemFromFarm(i);
                    return false;
                };
                farmGrid.appendChild(cell);
            }
            updateShop();
            updateInventory();
            renderFarm();
        }

        function updateShop() {
            const shopGrid = document.getElementById('shop-grid');
            if (!shopGrid) return;
            
            shopGrid.innerHTML = '';
            shopItems.forEach(item => {
                const shopItemDiv = document.createElement('div');
                shopItemDiv.className = 'shop-item';
                shopItemDiv.innerHTML = `
                    <div class="item-emoji">${item.emoji}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">ü™ô ${item.price}</div>
                `;
                shopItemDiv.onclick = () => buyItem(item.name);
                shopGrid.appendChild(shopItemDiv);
            });
        }

        function buyItem(itemName) {
            const item = shopItems.find(i => i.name === itemName);
            if (gameState.coins >= item.price) {
                gameState.coins -= item.price;
                if (!gameState.farm.items[itemName]) {
                    gameState.farm.items[itemName] = { ...item, count: 0 };
                }
                gameState.farm.items[itemName].count++;
                alert(`${itemName}ÏùÑ(Î•º) Íµ¨Îß§ÌñàÏäµÎãàÎã§!`);
                updateUI();
                updateInventory();
                saveCurrentUserData();
            } else {
                alert('ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§!');
            }
        }

        function updateInventory() {
            const inventoryGrid = document.getElementById('inventory-grid');
            if (!inventoryGrid) return;
            
            inventoryGrid.innerHTML = '';
            
            // ÎÜçÏû• ÏïÑÏù¥ÌÖú ÌëúÏãú
            Object.values(gameState.farm.items).forEach(item => {
                if (item.count > 0) {
                    const invItemDiv = document.createElement('div');
                    invItemDiv.className = 'inventory-item';
                    invItemDiv.dataset.itemName = item.name;
                    invItemDiv.innerHTML = `
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-count">x ${item.count}</div>
                    `;
                    invItemDiv.onclick = () => selectItemToPlace(item.name, false);
                    inventoryGrid.appendChild(invItemDiv);
                }
            });
            
            // ÎèôÎ¨º ÌëúÏãú
            Object.values(gameState.animals).forEach(animal => {
                 if (animal.count > 0) {
                    const invItemDiv = document.createElement('div');
                    invItemDiv.className = 'inventory-item';
                    invItemDiv.dataset.itemName = animal.name;
                    invItemDiv.innerHTML = `
                        <div class="item-emoji">${animal.emoji}</div>
                        <div class="item-name">${animal.name}</div>
                        <div class="item-count">x ${animal.count}</div>
                    `;
                    invItemDiv.onclick = () => selectItemToPlace(animal.name, true);
                    inventoryGrid.appendChild(invItemDiv);
                }
            });
        }

        function selectItemToPlace(itemName, isAnimal) {
            selectedItemToPlace = { name: itemName, isAnimal };
            document.querySelectorAll('.inventory-item').forEach(el => el.classList.remove('selected'));
            const targetElement = document.querySelector(`.inventory-item[data-item-name="${itemName}"]`);
            if (targetElement) {
                targetElement.classList.add('selected');
            }
        }

        function placeItemOnFarm(index, event) {
            if (!selectedItemToPlace) return;

            const { name, isAnimal } = selectedItemToPlace;
            const currentCellContent = gameState.farm.layout[index];

            // Í∏∞Ï°¥ ÏïÑÏù¥ÌÖúÏù¥ ÏûàÎã§Î©¥ Ïù∏Î≤§ÌÜ†Î¶¨Î°ú ÎèåÎ†§Î≥¥ÎÇ¥Í∏∞
            if (currentCellContent) {
                if (currentCellContent.isAnimal) {
                    if (gameState.animals[currentCellContent.name]) {
                        gameState.animals[currentCellContent.name].count++;
                    }
                } else {
                    if (gameState.farm.items[currentCellContent.name]) {
                        gameState.farm.items[currentCellContent.name].count++;
                    }
                }
            }

            // ÏÉà ÏïÑÏù¥ÌÖú Î∞∞Ïπò
            if (isAnimal) {
                if (gameState.animals[name] && gameState.animals[name].count > 0) {
                    gameState.farm.layout[index] = { 
                        name, 
                        isAnimal: true, 
                        emoji: gameState.animals[name].emoji 
                    };
                    gameState.animals[name].count--;
                }
            } else {
                if (gameState.farm.items[name] && gameState.farm.items[name].count > 0) {
                    gameState.farm.layout[index] = { 
                        name, 
                        isAnimal: false, 
                        emoji: gameState.farm.items[name].emoji 
                    };
                    gameState.farm.items[name].count--;
                }
            }
            
            selectedItemToPlace = null;
            document.querySelectorAll('.inventory-item').forEach(el => el.classList.remove('selected'));
            renderFarm();
            updateInventory();
            saveCurrentUserData();
        }

        function removeItemFromFarm(index) {
            const currentCellContent = gameState.farm.layout[index];
            if (currentCellContent) {
                if (currentCellContent.isAnimal) {
                    if (gameState.animals[currentCellContent.name]) {
                        gameState.animals[currentCellContent.name].count++;
                    }
                } else {
                    if (gameState.farm.items[currentCellContent.name]) {
                        gameState.farm.items[currentCellContent.name].count++;
                    }
                }
                gameState.farm.layout[index] = null;
                renderFarm();
                updateInventory();
                saveCurrentUserData();
            }
        }

        function renderFarm() {
            const farmGrid = document.getElementById('farm-grid');
            if (!farmGrid) return;
            
            gameState.farm.layout.forEach((item, index) => {
                const cell = farmGrid.children[index];
                if (cell) {
                    if (item) {
                        cell.innerHTML = `<span class="${item.isAnimal ? 'placed-animal' : ''}">${item.emoji}</span>`;
                    } else {
                        cell.innerHTML = '';
                    }
                }
            });
        }
        
        // ==================== ÎèôÎ¨º ÏãúÏû• Í¥ÄÎ†® Ìï®Ïàò ====================
        
        function updateMarketPage() {
            updateSellAnimalSelect();
            loadMarketListings();
        }

        function updateSellAnimalSelect() {
            const select = document.getElementById('sell-animal-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">ÌåêÎß§Ìï† ÎèôÎ¨º ÏÑ†ÌÉù</option>';
            
            Object.values(gameState.animals).forEach(animal => {
                if (animal.count >= 2) { // 2ÎßàÎ¶¨ Ïù¥ÏÉÅ Î≥¥Ïú†Ìïú ÎèôÎ¨ºÎßå ÌåêÎß§ Í∞ÄÎä•
                    const option = document.createElement('option');
                    option.value = animal.name;
                    option.textContent = `${animal.emoji} ${animal.name} (${animal.count}ÎßàÎ¶¨, Lv.${animal.animalLevel})`;
                    select.appendChild(option);
                }
            });
        }

        window.sellAnimal = async function() {
            const select = document.getElementById('sell-animal-select');
            const priceInput = document.getElementById('sell-price-input');
            
            const animalName = select.value;
            const price = parseInt(priceInput.value);
            
            if (!animalName) {
                alert('ÌåêÎß§Ìï† ÎèôÎ¨ºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!price || price <= 0) {
                alert('Ïò¨Î∞îÎ•∏ Í∞ÄÍ≤©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (price > gameState.coins * 10 + 1000) { // Ìï©Î¶¨Ï†ÅÏù∏ Í∞ÄÍ≤© ÏÑ§Ï†ï
                alert('Í∞ÄÍ≤©Ïù¥ ÎÑàÎ¨¥ ÎÜíÏäµÎãàÎã§. Ï¢Ä Îçî Ìï©Î¶¨Ï†ÅÏù∏ Í∞ÄÍ≤©ÏúºÎ°ú ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const animal = gameState.animals[animalName];
            if (animal.count < 2) {
                alert('ÏµúÏÜå 2ÎßàÎ¶¨ Ïù¥ÏÉÅ Î≥¥Ïú†Ìï¥Ïïº ÌåêÎß§Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            try {
                // FirebaseÏóê ÌåêÎß§ Îì±Î°ù
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const marketRef = window.firebase.collection(window.firebase.db, "artifacts", appId, "public/data/market");
                
                const listingData = {
                    animalName: animalName,
                    animalEmoji: animal.emoji,
                    animalLevel: animal.animalLevel,
                    specialName: animal.specialName,
                    rarity: animal.rarity,
                    price: price,
                    seller: currentUserProfile.name,
                    sellerId: currentUserId,
                    listedAt: new Date().toISOString()
                };
                
                await window.firebase.setDoc(window.firebase.doc(marketRef, `${currentUserId}_${animalName}_${Date.now()}`), listingData);
                
                // Ïù∏Î≤§ÌÜ†Î¶¨ÏóêÏÑú ÎèôÎ¨º Ï†úÍ±∞
                animal.count--;
                gameState.totalAnimals--;
                
                alert(`${animalName}Ïù¥(Í∞Ä) ${price}Ï†êÏóê ÌåêÎß§ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!`);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateUI();
                updateAnimalCollection();
                updateSellAnimalSelect();
                loadMarketListings();
                saveCurrentUserData();
                
                // ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                select.value = '';
                priceInput.value = '';
                
            } catch (error) {
                console.error('Error selling animal:', error);
                alert('ÌåêÎß§ Îì±Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        async function loadMarketListings() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const marketRef = window.firebase.collection(window.firebase.db, "artifacts", appId, "public/data/market");
                const querySnapshot = await window.firebase.getDocs(marketRef);
                
                const listings = [];
                const expiredListings = [];
                const currentTime = new Date();
                const threeDaysInMs = 3 * 24 * 60 * 60 * 1000; // 3ÏùºÏùÑ Î∞ÄÎ¶¨Ï¥àÎ°ú Î≥ÄÌôò
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const listingTime = new Date(data.listedAt);
                    const timeDiff = currentTime - listingTime;
                    
                    if (timeDiff > threeDaysInMs) {
                        // 3ÏùºÏù¥ ÏßÄÎÇú Ìï≠Î™©ÏùÄ ÎßåÎ£åÎêú Î™©Î°ùÏóê Ï∂îÍ∞Ä
                        expiredListings.push({
                            id: doc.id,
                            ...data
                        });
                    } else {
                        // 3Ïùº Ïù¥ÎÇ¥Ïùò Ìï≠Î™©Îßå ÌëúÏãú Î™©Î°ùÏóê Ï∂îÍ∞Ä
                        listings.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                // ÎßåÎ£åÎêú Ìï≠Î™©Îì§ Ï≤òÎ¶¨
                for (const expiredListing of expiredListings) {
                    await returnExpiredAnimal(expiredListing);
                }
                
                // ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
                listings.sort((a, b) => new Date(b.listedAt) - new Date(a.listedAt));
                
                displayMarketListings(listings);
                
            } catch (error) {
                console.error('Error loading market listings:', error);
                document.getElementById('market-body').innerHTML = '<tr><td colspan="7">ÏãúÏû• Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</td></tr>';
            }
        }
        
        // ÎßåÎ£åÎêú ÎèôÎ¨ºÏùÑ ÌåêÎß§ÏûêÏóêÍ≤å Î∞òÌôò
        async function returnExpiredAnimal(expiredListing) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                // ÌåêÎß§Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const sellerData = await loadUserData(expiredListing.seller);
                if (!sellerData) {
                    console.log(`ÌåêÎß§Ïûê ${expiredListing.seller}Ïùò Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                    // ÌåêÎß§Ïûê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ÎèÑ ÏãúÏû•ÏóêÏÑúÎäî Ï†úÍ±∞
                    const listingRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/market", expiredListing.id);
                    await window.firebase.deleteDoc(listingRef);
                    return;
                }
                
                // ÎèôÎ¨ºÏùÑ ÌåêÎß§ÏûêÏóêÍ≤å Î∞òÌôò
                const animalName = expiredListing.animalName;
                if (!sellerData.animals) {
                    sellerData.animals = {};
                }
                
                if (!sellerData.animals[animalName]) {
                    // Ìï¥Îãπ ÎèôÎ¨ºÏù¥ ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
                    const animalType = animalTypes.find(a => a.name === animalName);
                    if (animalType) {
                        sellerData.animals[animalName] = {
                            ...animalType,
                            count: 0,
                            animalLevel: expiredListing.animalLevel,
                            story: ""
                        };
                        sellerData.speciesCount = (sellerData.speciesCount || 0) + 1;
                    }
                }
                
                if (sellerData.animals[animalName]) {
                    sellerData.animals[animalName].count++;
                    sellerData.totalAnimals = (sellerData.totalAnimals || 0) + 1;
                    sellerData.animals[animalName].animalLevel = Math.max(
                        sellerData.animals[animalName].animalLevel || 1, 
                        expiredListing.animalLevel
                    );
                }
                
                // ÌåêÎß§Ïûê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                const userDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/profiles", expiredListing.seller);
                await window.firebase.setDoc(userDocRef, sellerData, { merge: true });
                
                // ÏãúÏû•ÏóêÏÑú Ï†úÍ±∞
                const listingRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/market", expiredListing.id);
                await window.firebase.deleteDoc(listingRef);
                
                // ÌåêÎß§ÏûêÏóêÍ≤å ÏïåÎ¶º ÏÉùÏÑ±
                const message = `${expiredListing.animalName}(Lv.${expiredListing.animalLevel})Ïù¥(Í∞Ä) 3ÏùºÍ∞Ñ ÌåêÎß§ÎêòÏßÄ ÏïäÏïÑ Ïù∏Î≤§ÌÜ†Î¶¨Î°ú ÎèåÏïÑÏôîÏäµÎãàÎã§. Îã§Ïãú ÌåêÎß§ÌïòÍ±∞ÎÇò Í∞ÄÍ≤©ÏùÑ Ï°∞Ï†ïÌï¥Î≥¥ÏÑ∏Ïöî!`;
                await createNotification(expiredListing.seller, 'sale_expired', message, {
                    name: expiredListing.animalName,
                    emoji: expiredListing.animalEmoji,
                    level: expiredListing.animalLevel,
                    price: expiredListing.price
                });
                
                console.log(`ÎßåÎ£åÎêú ÎèôÎ¨º ${expiredListing.animalName}ÏùÑ(Î•º) ${expiredListing.seller}ÏóêÍ≤å Î∞òÌôò ÏôÑÎ£å`);
                
            } catch (error) {
                console.error('ÎßåÎ£åÎêú ÎèôÎ¨º Î∞òÌôò Ïò§Î•ò:', error);
            }
        }

        function displayMarketListings(listings) {
            const tbody = document.getElementById('market-body');
            if (!tbody) return;
            
            if (listings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">ÌòÑÏû¨ ÌåêÎß§ Ï§ëÏù∏ ÎèôÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            listings.forEach(listing => {
                const row = document.createElement('tr');
                
                // ÏûêÏã†Ïù¥ Ïò¨Î¶∞ ÏÉÅÌíàÏùÄ Îã§Î•∏ ÏÉâÏÉÅÏúºÎ°ú ÌëúÏãú
                if (listing.seller === currentUserProfile.name) {
                    row.style.backgroundColor = '#f0f8ff';
                }
                
                // ÎÇ®ÏùÄ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
                const currentTime = new Date();
                const listingTime = new Date(listing.listedAt);
                const threeDaysInMs = 3 * 24 * 60 * 60 * 1000;
                const timeLeft = threeDaysInMs - (currentTime - listingTime);
                
                let timeLeftText = '';
                if (timeLeft > 0) {
                    const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                    const daysLeft = Math.floor(hoursLeft / 24);
                    const remainingHours = hoursLeft % 24;
                    
                    if (daysLeft > 0) {
                        timeLeftText = `${daysLeft}Ïùº ${remainingHours}ÏãúÍ∞Ñ`;
                    } else {
                        timeLeftText = `${hoursLeft}ÏãúÍ∞Ñ`;
                    }
                    
                    // 12ÏãúÍ∞Ñ Ïù¥ÌïòÎ©¥ Îπ®Í∞ÑÏÉâÏúºÎ°ú ÌëúÏãú
                    if (hoursLeft <= 12) {
                        timeLeftText = `<span style="color: #ff0000; font-weight: bold;">${timeLeftText}</span>`;
                    }
                } else {
                    timeLeftText = '<span style="color: #ff0000;">ÎßåÎ£åÎê®</span>';
                }
                
                row.innerHTML = `
                    <td>${listing.animalEmoji}</td>
                    <td>${listing.animalName}<br><small>"${listing.specialName}"</small></td>
                    <td>Lv. ${listing.animalLevel}<br><small>‚òÖ${listing.rarity}</small></td>
                    <td>${listing.seller}</td>
                    <td><strong>${listing.price}</strong>ü™ô</td>
                    <td><small>${timeLeftText}</small></td>
                    <td>
                        ${listing.seller === currentUserProfile.name 
                            ? `<button class="nav-btn" onclick="cancelListing('${listing.id}')" style="background: #ff6b6b;">Ï∑®ÏÜå</button>`
                            : `<button class="nav-btn" onclick="buyAnimal('${listing.id}', ${listing.price}, '${listing.animalName}')">Íµ¨Îß§</button>`
                        }
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        window.buyAnimal = async function(listingId, price, animalName) {
            if (gameState.coins < price) {
                alert('ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                return;
            }

            if (!confirm(`${animalName}ÏùÑ(Î•º) ${price}ÏΩîÏù∏Ïóê Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const listingRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/market", listingId);
                
                // ÌåêÎß§ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const listingDoc = await window.firebase.getDoc(listingRef);
                if (!listingDoc.exists()) {
                    alert('Ïù¥ÎØ∏ ÌåêÎß§Îêú ÏÉÅÌíàÏûÖÎãàÎã§.');
                    loadMarketListings();
                    return;
                }
                
                const listingData = listingDoc.data();
                const sellerName = listingData.seller;
                
                // Ï†êÏàò Ï∞®Í∞ê
                gameState.coins -= price;
                
                // ÎèôÎ¨º Ï∂îÍ∞Ä
                const animalType = animalTypes.find(a => a.name === animalName);
                if (!gameState.animals[animalName]) {
                    gameState.animals[animalName] = {
                        ...animalType,
                        count: 0,
                        animalLevel: listingData.animalLevel,
                        story: ""
                    };
                    gameState.speciesCount++;
                }
                gameState.animals[animalName].count++;
                gameState.animals[animalName].animalLevel = Math.max(
                    gameState.animals[animalName].animalLevel, 
                    listingData.animalLevel
                );
                gameState.totalAnimals++;
                
                // ÌåêÎß§ÏûêÏóêÍ≤å ÏΩîÏù∏ ÏßÄÍ∏â Î∞è ÏïåÎ¶º ÏÉùÏÑ±
                try {
                    const sellerData = await loadUserData(sellerName);
                    if (sellerData) {
                        // ÌåêÎß§ÏûêÏóêÍ≤å ÏΩîÏù∏ ÏßÄÍ∏â
                        sellerData.coins = (sellerData.coins || 0) + price;
                        
                        // ÌåêÎß§Ïûê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                        const sellerDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/profiles", sellerName);
                        await window.firebase.setDoc(sellerDocRef, sellerData, { merge: true });
                        
                        // ÌåêÎß§ÏûêÏóêÍ≤å ÌåêÎß§ ÏÑ±Í≥µ ÏïåÎ¶º
                        const sellerMessage = `üéâ Ï∂ïÌïòÌï©ÎãàÎã§! ${animalName}(Lv.${listingData.animalLevel})Ïù¥(Í∞Ä) ${price}ü™ôÏóê ÌåêÎß§ÎêòÏóàÏäµÎãàÎã§! Íµ¨Îß§Ïûê: ${currentUserProfile.name}`;
                        await createNotification(sellerName, 'sale_success', sellerMessage, {
                            name: animalName,
                            emoji: listingData.animalEmoji,
                            level: listingData.animalLevel,
                            price: price,
                            buyer: currentUserProfile.name
                        });
                        
                        console.log(`ÌåêÎß§Ïûê ${sellerName}ÏóêÍ≤å ${price}ÏΩîÏù∏ ÏßÄÍ∏â Î∞è ÏïåÎ¶º Ï†ÑÏÜ° ÏôÑÎ£å`);
                    }
                } catch (error) {
                    console.error('ÌåêÎß§Ïûê Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                    // ÌåêÎß§Ïûê Ï≤òÎ¶¨ Ïã§Ìå®Ìï¥ÎèÑ Íµ¨Îß§Îäî ÏßÑÌñâ
                }
                
                // Íµ¨Îß§ÏûêÏóêÍ≤å Íµ¨Îß§ ÏÑ±Í≥µ ÏïåÎ¶º (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                const buyerMessage = `üéâ ${animalName}(Lv.${listingData.animalLevel})ÏùÑ(Î•º) ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Íµ¨Îß§ÌñàÏäµÎãàÎã§! Ïù∏Î≤§ÌÜ†Î¶¨Î•º ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.`;
                await createNotification(currentUserProfile.name, 'purchase_success', buyerMessage, {
                    name: animalName,
                    emoji: listingData.animalEmoji,
                    level: listingData.animalLevel,
                    price: price,
                    seller: sellerName
                });
                
                // ÌåêÎß§ Ï†ïÎ≥¥ ÏÇ≠Ï†ú
                await window.firebase.deleteDoc(listingRef);
                
                alert(`${animalName}ÏùÑ(Î•º) ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Íµ¨Îß§ÌñàÏäµÎãàÎã§!`);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateUI();
                updateAnimalCollection();
                loadMarketListings();
                saveCurrentUserData();
                
            } catch (error) {
                console.error('Error buying animal:', error);
                alert('Íµ¨Îß§ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        window.cancelListing = async function(listingId) {
            if (!confirm('ÌåêÎß§Î•º Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const listingRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/market", listingId);
                
                // ÌåêÎß§ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const listingDoc = await window.firebase.getDoc(listingRef);
                if (!listingDoc.exists()) {
                    alert('Ïù¥ÎØ∏ Ï≤òÎ¶¨Îêú ÏÉÅÌíàÏûÖÎãàÎã§.');
                    loadMarketListings();
                    return;
                }
                
                const listingData = listingDoc.data();
                
                // ÎèôÎ¨º Îã§Ïãú Ïù∏Î≤§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
                const animalType = animalTypes.find(a => a.name === listingData.animalName);
                if (!gameState.animals[listingData.animalName]) {
                    gameState.animals[listingData.animalName] = {
                        ...animalType,
                        count: 0,
                        animalLevel: listingData.animalLevel,
                        story: ""
                    };
                    gameState.speciesCount++;
                }
                gameState.animals[listingData.animalName].count++;
                gameState.totalAnimals++;
                
                // ÌåêÎß§ Ï†ïÎ≥¥ ÏÇ≠Ï†ú
                await window.firebase.deleteDoc(listingRef);
                
                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ï∑®ÏÜå ÏïåÎ¶º ÏÉùÏÑ±
                const message = `${listingData.animalName}(Lv.${listingData.animalLevel})Ïùò ÌåêÎß§Î•º Ï∑®ÏÜåÌñàÏäµÎãàÎã§. ÎèôÎ¨ºÏù¥ Ïù∏Î≤§ÌÜ†Î¶¨Î°ú ÎèåÏïÑÏôîÏäµÎãàÎã§.`;
                await createNotification(currentUserProfile.name, 'sale_cancelled', message, {
                    name: listingData.animalName,
                    emoji: listingData.animalEmoji,
                    level: listingData.animalLevel,
                    price: listingData.price
                });
                
                alert('ÌåêÎß§Í∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§. ÎèôÎ¨ºÏù¥ Ïù∏Î≤§ÌÜ†Î¶¨Î°ú ÎèåÏïÑÏôîÏäµÎãàÎã§.');
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateUI();
                updateAnimalCollection();
                updateSellAnimalSelect();
                loadMarketListings();
                saveCurrentUserData();
                
            } catch (error) {
                console.error('Error canceling listing:', error);
                alert('ÌåêÎß§ Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ==================== ÎèôÎ¨º Ìï©ÏÑ± Ìï®Ïàò ====================
        
        function updateSynthesisPage() {
            const grid = document.getElementById('synthesis-grid');
            if (!grid) return;
            
            grid.innerHTML = '';

            synthesisRecipes.forEach(recipe => {
                const [ing1, ing2] = recipe.ingredients;
                const result = animalTypes.find(a => a.name === recipe.result);
                
                // ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í±¥ÎÑàÎõ∞Í∏∞
                if (!result) {
                    console.log(`Í≤∞Í≥º ÎèôÎ¨º '${recipe.result}' Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.`);
                    return;
                }

                const hasIng1 = gameState.animals[ing1] && gameState.animals[ing1].count > 0;
                const hasIng2 = gameState.animals[ing2] && gameState.animals[ing2].count > 0;
                const canSynthesize = hasIng1 && hasIng2;

                const ing1Data = animalTypes.find(a => a.name === ing1);
                const ing2Data = animalTypes.find(a => a.name === ing2);
                
                // Ïû¨Î£å ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í±¥ÎÑàÎõ∞Í∏∞
                if (!ing1Data || !ing2Data) {
                    console.log(`Ïû¨Î£å ÎèôÎ¨º '${ing1}' ÎòêÎäî '${ing2}' Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.`);
                    return;
                }

                const card = document.createElement('div');
                card.className = 'synthesis-card';
                card.innerHTML = `
                    <div class="synthesis-ingredient ${hasIng1 ? 'owned' : 'not-owned'}">
                        <span class="animal-emoji">${ing1Data.emoji}</span>
                        <div>${ing1}</div>
                    </div>
                    <div class="synthesis-symbol">+</div>
                    <div class="synthesis-ingredient ${hasIng2 ? 'owned' : 'not-owned'}">
                        <span class="animal-emoji">${ing2Data.emoji}</span>
                        <div>${ing2}</div>
                    </div>
                    <div class="synthesis-symbol">=</div>
                    <div class="synthesis-result">
                        <span class="animal-emoji">${result.emoji}</span>
                        <div>${result.name}</div>
                    </div>
                    <button class="synthesis-btn" onclick="performSynthesis('${recipe.result}')" ${!canSynthesize ? 'disabled' : ''}>Ìï©ÏÑ±</button>
                `;
                grid.appendChild(card);
            });
        }

        window.performSynthesis = function(resultName) {
            const recipe = synthesisRecipes.find(r => r.result === resultName);
            if (!recipe) return;

            const [ing1, ing2] = recipe.ingredients;
            const hasIng1 = gameState.animals[ing1] && gameState.animals[ing1].count > 0;
            const hasIng2 = gameState.animals[ing2] && gameState.animals[ing2].count > 0;

            if (hasIng1 && hasIng2) {
                if (confirm(`'${ing1}'ÏôÄ(Í≥º) '${ing2}'Î•º ÏÇ¨Ïö©Ìï¥ '${resultName}'ÏùÑ(Î•º) ÎßåÎìúÏãúÍ≤†ÏäµÎãàÍπå?\nÏû¨Î£åÎ°ú ÏÇ¨Ïö©Îêú ÎèôÎ¨ºÏùÄ ÏÇ¨ÎùºÏßëÎãàÎã§!`)) {
                    gameState.animals[ing1].count--;
                    gameState.animals[ing2].count--;
                    gameState.totalAnimals -= 2;

                    const resultAnimalData = animalTypes.find(a => a.name === resultName);
                    addAnimal(resultAnimalData);

                    alert(`Ìï©ÏÑ± ÏÑ±Í≥µ! Ï†ÑÏÑ§Ï†ÅÏù∏ ÎèôÎ¨º '${resultName}'ÏùÑ(Î•º) ÌöçÎìùÌñàÏäµÎãàÎã§!`);
                    
                    updateSynthesisPage();
                    updateAnimalCollection();
                    saveCurrentUserData();
                }
            } else {
                alert('Ïû¨Î£åÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');
            }
        }

        // ==================== AI Ïä§ÌÜ†Î¶¨ÌÖîÎü¨ Ìï®Ïàò ====================

        function openStoryModal(title) {
            document.getElementById('story-modal-title').textContent = `"${title}" Ïù¥ÏïºÍ∏∞`;
            document.getElementById('story-text').textContent = '';
            document.getElementById('story-loading').style.display = 'block';
            document.getElementById('story-modal').style.display = 'flex';
        }

        window.closeStoryModal = function() {
            document.getElementById('story-modal').style.display = 'none';
        }

        async function generateAnimalStory(animal) {
            openStoryModal(animal.specialName);
            const storyTextElement = document.getElementById('story-text');
            const loadingElement = document.getElementById('story-loading');

            // Ïù¥ÎØ∏ Ï†ÄÏû•Îêú Ïù¥ÏïºÍ∏∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
            if (animal.story) {
                storyTextElement.textContent = animal.story;
                loadingElement.style.display = 'none';
                console.log("Ï†ÄÏû•Îêú Ïù¥ÏïºÍ∏∞ Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å!");
                return;
            }

            try {
                // Firebase Cloud Function Ìò∏Ï∂ú
                const generateStoryFunction = window.firebase.httpsCallable(window.firebase.functions, 'generateStory');
                const result = await generateStoryFunction({ 
                    animal: {
                        name: animal.name,
                        specialName: animal.specialName,
                        emoji: animal.emoji,
                        rarity: animal.rarity
                    }
                });
                
                const text = result.data.story;
                storyTextElement.textContent = text;
                
                // ÏÉùÏÑ±Îêú Ïù¥ÏïºÍ∏∞Î•º gameStateÏóê Ï†ÄÏû•ÌïòÍ≥†, FirebaseÏóê ÏóÖÎç∞Ïù¥Ìä∏
                gameState.animals[animal.name].story = text;
                await saveCurrentUserData();
                console.log("ÏÉàÎ°úÏö¥ Ïù¥ÏïºÍ∏∞ ÏÉùÏÑ± Î∞è FirebaseÏóê Ï†ÄÏû• ÏôÑÎ£å!");

            } catch (error) {
                console.error("Error generating story via Cloud Function:", error);
                storyTextElement.textContent = "Ïù¥ÏïºÍ∏∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.";
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // ==================== ÌäπÏàò Ìö®Í≥º Ìï®Ïàò ====================
        function showNewAnimalAlert(animal) {
            const alert = document.createElement('div');
            alert.className = 'new-animal-alert';
            alert.innerHTML = `
                <span class="new-animal-emoji">${animal.emoji}</span>
                <h3>ÏÉàÎ°úÏö¥ ÎèôÎ¨º Î∞úÍ≤¨! üéâ</h3>
                <p><strong>${animal.specialName}</strong> (${animal.name})ÏùÑ(Î•º) ÌöçÎìùÌñàÏäµÎãàÎã§!</p>
            `;
            document.body.appendChild(alert);
            setTimeout(() => { alert.remove(); }, 1500);
        }

        function showLevelUp() {
            // Î†àÎ≤®ÏóÖ ÌôîÎ†§Ìïú Ìö®Í≥º
            showLevelUpEffects();
            
            const alert = document.createElement('div');
            alert.className = 'new-animal-alert';
            alert.style.cssText += `
                animation: levelUpBurst 1s ease-out;
                background: linear-gradient(135deg, #FFD700, #FFA500, #FF69B4);
                color: white;
                border: 3px solid gold;
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            `;
            alert.innerHTML = `
                <span class="new-animal-emoji" style="font-size: 3rem; animation: animalHop 1s infinite;">‚≠ê</span>
                <h3 style="font-size: 2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Î†àÎ≤® ÏóÖ! üéâ</h3>
                <p style="font-size: 1.3rem;">Î†àÎ≤® ${gameState.level}Ïù¥ ÎêòÏóàÏäµÎãàÎã§!</p>
                <p style="font-size: 1.1rem;">Îçî Ìù¨Í∑ÄÌïú ÎèôÎ¨ºÏùÑ ÎßåÎÇ† Ïàò ÏûàÏñ¥Ïöî!</p>
            `;
            document.body.appendChild(alert);
            setTimeout(() => { alert.remove(); }, 2000);
        }

        // ==================== ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Î∞è Îç∞Ïù¥ÌÑ∞ Ìï®Ïàò (Firebase) ====================

        async function saveCurrentUserData() {
            if (!currentUserProfile.name) return;
            
            // ÌòÑÏû¨ ÏÑ∏ÏÖò ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
            const currentTotalPlayTime = updateSessionPlayTime();
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/profiles", currentUserProfile.name);
            
            const dataToSave = {
                ...currentUserProfile,
                score: gameState.score,
                coins: gameState.coins,
                level: gameState.level,
                animals: gameState.animals,
                totalAnimals: gameState.totalAnimals,
                speciesCount: gameState.speciesCount,
                farm: gameState.farm,
                totalPlayTimeMinutes: currentTotalPlayTime,
                lastPlayed: new Date().toISOString(),
                // Îß§Ïùº Î°úÍ∑∏Ïù∏ Î≥¥ÏÉÅ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                dailyRewards: gameState.dailyRewards,
                activeBuffs: gameState.activeBuffs,
                // Í≥ºÎ™©Î≥Ñ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                subjects: gameState.subjects,
                currentSubject: gameState.currentSubject
            };

            try {
                await window.firebase.setDoc(userDocRef, dataToSave, { merge: true });
                console.log("Data saved for", currentUserProfile.name);
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }

        async function loadUserData(userName) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/profiles", userName);
            const docSnap = await window.firebase.getDoc(userDocRef);

            if (docSnap.exists()) {
                return docSnap.data();
            } else {
                return null;
            }
        }

        async function hashPin(pin, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function handleSignup() {
            const nameInput = document.getElementById('player-name-input');
            const pinInput = document.getElementById('player-pin-input');
            const feedback = document.getElementById('login-feedback');
            const name = nameInput.value.trim();
            const pin = pinInput.value;

            if (!name || !pin) {
                feedback.textContent = "Ïù¥Î¶ÑÍ≥º PINÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
                return;
            }
            if (!/^\d{4}$/.test(pin)) {
                feedback.textContent = "PINÏùÄ 4ÏûêÎ¶¨ Ïà´ÏûêÏó¨Ïïº Ìï©ÎãàÎã§.";
                return;
            }

            feedback.textContent = "ÌôïÏù∏ Ï§ë...";
            const existingProfile = await loadUserData(name);
            if (existingProfile) {
                feedback.textContent = "Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ Ïù¥Î¶ÑÏûÖÎãàÎã§.";
                return;
            }

            const hashedPin = await hashPin(pin, name);
            const newProfile = {
                name: name,
                pinHash: hashedPin,
                score: 0,
                coins: 0,
                level: 1,
                animals: {},
                totalAnimals: 0,
                speciesCount: 0,
                farm: { layout: Array(48).fill(null), items: {} },
                totalPlayTimeMinutes: 0,
                createdAt: new Date().toISOString(),
                lastPlayed: new Date().toISOString()
            };

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/profiles", newProfile.name);
            await window.firebase.setDoc(userDocRef, newProfile);

            alert(`üéâ ${name} ÌîåÎ†àÏù¥Ïñ¥ ÏÉùÏÑ± ÏôÑÎ£å!`);
            await startGameWithProfile(newProfile);
        }

        async function handleLogin() {
            const nameInput = document.getElementById('player-name-input');
            const pinInput = document.getElementById('player-pin-input');
            const feedback = document.getElementById('login-feedback');
            const name = nameInput.value.trim();
            const pin = pinInput.value;

            if (!name || !pin) {
                feedback.textContent = "Ïù¥Î¶ÑÍ≥º PINÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
                return;
            }

            feedback.textContent = "Î°úÍ∑∏Ïù∏ Ï§ë...";
            const profileData = await loadUserData(name);

            if (!profileData) {
                feedback.textContent = "Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÌîåÎ†àÏù¥Ïñ¥ÏûÖÎãàÎã§.";
                return;
            }

            const hashedPin = await hashPin(pin, name);
            if (hashedPin === profileData.pinHash) {
                await startGameWithProfile(profileData);
            } else {
                feedback.textContent = "PINÏù¥ ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.";
            }
        }

        async function startGameWithProfile(profileData) {
            currentUserProfile = profileData;
            
            // ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Ï¥àÍ∏∞Ìôî
            totalPlayTimeMinutes = profileData.totalPlayTimeMinutes || 0;
            sessionStartTime = Date.now();
            
            gameState = {
                score: profileData.score || 0,
                coins: profileData.coins || 0,
                level: profileData.level || 1,
                animals: profileData.animals || {},
                totalAnimals: profileData.totalAnimals || 0,
                speciesCount: profileData.speciesCount || 0,
                farm: profileData.farm || { layout: Array(48).fill(null), items: {} },
                currentQuestion: {},
                // Îß§Ïùº Î°úÍ∑∏Ïù∏ Î≥¥ÏÉÅ ÏãúÏä§ÌÖú Îç∞Ïù¥ÌÑ∞
                dailyRewards: profileData.dailyRewards || {
                    lastLoginDate: null,
                    consecutiveDays: 0,
                    hasClaimedToday: false,
                    totalDaysLogged: 0
                },
                // ÌôúÏÑ± Î≤ÑÌîÑ ÏãúÏä§ÌÖú
                activeBuffs: profileData.activeBuffs || [],
                // Í≥ºÎ™©Î≥Ñ ÎèÖÎ¶ΩÏ†ÅÏù∏ Îç∞Ïù¥ÌÑ∞
                subjects: profileData.subjects || {
                    english: { 
                        progress: {}, 
                        level: 1, 
                        score: 0, 
                        currentDifficulty: 1,
                        totalCorrect: 0,
                        totalIncorrect: 0 
                    },
                    social: { 
                        progress: {}, 
                        level: 1, 
                        score: 0, 
                        currentDifficulty: 1,
                        totalCorrect: 0,
                        totalIncorrect: 0 
                    }
                },
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í≥ºÎ™© (Í∏∞Î≥∏Í∞í: ÏòÅÏñ¥)
                currentSubject: profileData.currentSubject || 'english'
            };

            document.getElementById('login-overlay').style.display = 'none';
            document.querySelector('.game-container').style.display = 'block';
            document.getElementById('current-user-name').textContent = currentUserProfile.name;
            
            // ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ Î°úÎìú
            if (animalTypes.length === 0) {
                await window.loadAnimalsFromJSON();
            }
            
            updateUI();
            updateAnimalCollection();
            
            // Í≥ºÎ™©Î≥Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            loadCurrentSubjectProgress();
            updateSubjectUI();
            
            // Í≥ºÎ™© ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ Ï¥àÍ∏∞Ìôî
            document.getElementById('subject-select').value = gameState.currentSubject;
            
            // Îß§Ïùº Î°úÍ∑∏Ïù∏ Î≥¥ÏÉÅ Ï≤¥ÌÅ¨ (ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥ ÌõÑ Ïã§Ìñâ)
            setTimeout(() => {
                checkDailyLoginReward();
            }, 1000);
            initializeFarm();
            
            // ÏÇ¨Ïö©Ïûê ÌïôÏäµ ÏßÑÌñâÎèÑ Î°úÎìú ÌõÑ ÌÄ¥Ï¶à ÏãúÏûë
            try {
                await loadUserProgress();
                selectDifficulty(1);
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê ÏßÑÌñâÎèÑ Î°úÎìú Ïã§Ìå®:', error);
                selectDifficulty(1);
            }
            
            showPage('game', document.querySelector('.nav-btn'));
            // ÏïåÎûå ÌôïÏù∏ (3Ï¥à ÌõÑ)
            setTimeout(() => {
                checkAndShowNotifications();
            }, 3000);
        }

        window.logout = function() {
            // Î°úÍ∑∏ÏïÑÏõÉ Ï†ÑÏóê ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Ï†ÄÏû•
            if (sessionStartTime) {
                const sessionMinutes = (Date.now() - sessionStartTime) / (1000 * 60);
                totalPlayTimeMinutes += sessionMinutes;
                sessionStartTime = null;
            }
            
            saveCurrentUserData();
            currentUserProfile = {};
            gameState = {};
            totalPlayTimeMinutes = 0;
            
            document.getElementById('login-overlay').style.display = 'flex';
            document.querySelector('.game-container').style.display = 'none';
            document.getElementById('player-name-input').value = '';
            document.getElementById('player-pin-input').value = '';
            document.getElementById('login-feedback').textContent = '';
            window.updateHallOfFame();
        }



        async function updateRankingPage() {
            const profiles = await getAllProfiles();
            const sortedProfiles = profiles.sort((a, b) => (b.score || 0) - (a.score || 0));
            const rankingBody = document.getElementById('ranking-body');
            rankingBody.innerHTML = '';

            sortedProfiles.forEach((p, index) => {
                const row = document.createElement('tr');
                if (p.name === currentUserProfile.name) {
                    row.className = 'my-rank';
                }
                
                // ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÏùò Í≤ΩÏö∞ ÌòÑÏû¨ ÏÑ∏ÏÖò Ìè¨Ìï®)
                let displayPlayTime = p.totalPlayTimeMinutes || 0;
                if (p.name === currentUserProfile.name && sessionStartTime) {
                    const sessionMinutes = (Date.now() - sessionStartTime) / (1000 * 60);
                    displayPlayTime += sessionMinutes;
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><span class="clickable-user-name" onclick="visitUserFarm('${p.name}')" style="color: #4169E1; cursor: pointer; text-decoration: underline;">${p.name}</span></td>
                    <td>${p.score || 0}</td>
                    <td>${p.level || 1}</td>
                    <td>${p.speciesCount || 0}</td>
                    <td>${formatPlayTime(displayPlayTime)}</td>
                    <td><button class="nav-btn" onclick="visitUserFarm('${p.name}')" style="font-size: 0.8rem; padding: 6px 12px;">üè° Î∞©Î¨∏</button></td>
                `;
                rankingBody.appendChild(row);
            });
        }

        // ==================== ÌéòÏù¥ÏßÄ Í¥ÄÎ¶¨ Î∞è Ï¥àÍ∏∞Ìôî ====================

        window.showPage = function(pageName, element) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(pageName + '-page').classList.add('active');
            if (element) {
                element.classList.add('active');
            }
            
            const gameStats = document.getElementById('game-stats');
            const userInfo = document.getElementById('user-info');
            
            if (pageName === 'game') {
                gameStats.style.display = 'flex';
                userInfo.style.display = 'block';
            } else if (pageName === 'learning') {
                gameStats.style.display = 'none';
                userInfo.style.display = 'block';
                updateLearningStats();
            } else if (pageName === 'market') {
                gameStats.style.display = 'none';
                userInfo.style.display = 'block';
                updateMarketPage();
            } else if (pageName === 'encyclopedia') {
                gameStats.style.display = 'none';
                userInfo.style.display = 'block';
                updateEncyclopedia();
            } else if (pageName === 'farm') {
                gameStats.style.display = 'flex';
                userInfo.style.display = 'block';
                initializeFarm();
            } else if (pageName === 'synthesis') {
                gameStats.style.display = 'none';
                userInfo.style.display = 'block';
                updateSynthesisPage();
            } else if (pageName === 'ranking') {
                gameStats.style.display = 'none';
                userInfo.style.display = 'block';
                updateRankingPage();
            } else {
                gameStats.style.display = 'none';
                userInfo.style.display = 'none';
            }
        }
        
        // ==================== Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ====================
        
        document.getElementById('login-btn').addEventListener('click', async () => {
            try {
                await handleLogin();
            } catch (error) {
                console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', error);
                document.getElementById('login-feedback').textContent = "Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
            }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            try {
                await handleSignup();
            } catch (error) {
                console.error('ÌöåÏõêÍ∞ÄÏûÖ Ïò§Î•ò:', error);
                document.getElementById('login-feedback').textContent = "ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
            }
        });

        document.getElementById('player-pin-input').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                try {
                    await handleLogin();
                } catch (error) {
                    console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', error);
                    document.getElementById('login-feedback').textContent = "Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
                }
            }
        });

        // ÏùåÏÑ± Ìï©ÏÑ± Ï§ÄÎπÑ
        window.speechSynthesis.onvoiceschanged = () => {
            window.speechSynthesis.getVoices();
        };

        // ÌéòÏù¥ÏßÄ Ïà®ÍπÄ/ÌëúÏãú Ïãú ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Ï†ÄÏû•
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && currentUserProfile.name) {
                saveCurrentUserData();
            } else if (document.visibilityState === 'visible' && currentUserProfile.name) {
                sessionStartTime = Date.now(); // Îã§Ïãú ÎèåÏïÑÏôîÏùÑ Îïå ÏÑ∏ÏÖò Ïû¨ÏãúÏûë
            }
        });

        // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ïãú ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Ï†ÄÏû•
        window.addEventListener('beforeunload', () => {
            if (currentUserProfile.name && sessionStartTime) {
                const sessionMinutes = (Date.now() - sessionStartTime) / (1000 * 60);
                totalPlayTimeMinutes += sessionMinutes;
                // beforeunloadÏóêÏÑúÎäî ÎπÑÎèôÍ∏∞ ÏûëÏóÖÏù¥ Ï†úÌïúÏ†ÅÏù¥ÎØÄÎ°ú localStorage ÏÇ¨Ïö©
                localStorage.setItem(`playTime_${currentUserProfile.name}`, totalPlayTimeMinutes.toString());
            }
        });

        // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Ï†ÄÏû• (5Î∂ÑÎßàÎã§)
        setInterval(() => {
            if (currentUserProfile.name && sessionStartTime) {
                saveCurrentUserData();
            }
        }, 5 * 60 * 1000);

        // ==================== Î∞∞ÌãÄÎ™®Îìú ÏãúÏä§ÌÖú ====================
        
        let battleRoomRef = null;
        let battleGameTimer = null;
        let battleCountdownTimer = null;
        
        // Î∞∞ÌãÄ ÌôîÎ©¥ Ï†ÑÌôò
        function showBattleScreen(screenId) {
            document.querySelectorAll('.battle-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        // Î∞∞ÌãÄ Î©îÏù∏ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        function showBattleMenu() {
            showBattleScreen('battle-menu');
            // Î∞©ÏóêÏÑú ÎÇòÍ∞ÄÍ∏∞
            if (gameState.battle.currentRoom) {
                leaveBattleRoom();
            }
        }
        
        // Î∞© ÏÉùÏÑ± Î™®Îã¨ ÌëúÏãú
        function showCreateRoomModal() {
            showBattleScreen('create-room-screen');
            // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            document.getElementById('room-name-input').value = `${currentUserProfile.name || 'ÏùµÎ™Ö'}Ïùò Î∞©`;
            document.getElementById('battle-subject-select').value = gameState.currentSubject;
        }
        
        // Î∞© Ï∞∏Í∞Ä Î™®Îã¨ ÌëúÏãú
        function showJoinRoomModal() {
            showBattleScreen('join-room-screen');
            document.getElementById('room-code-input').focus();
        }
        
        // Í≥µÍ∞úÎ∞© Î™©Î°ù ÌëúÏãú
        function showPublicRooms() {
            showBattleScreen('public-rooms-screen');
            refreshPublicRooms();
        }
        
        // Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÌëúÏãú
        function showBattleStats() {
            showBattleScreen('battle-stats-screen');
            updateBattleStats();
        }
        
        // Î∞∞ÌãÄÎ∞© ÏÉùÏÑ±
        async function createBattleRoom() {
            if (!currentUserProfile.name) {
                alert('Î®ºÏ†Ä Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            const roomName = document.getElementById('room-name-input').value.trim();
            const subject = document.getElementById('battle-subject-select').value;
            const level = parseInt(document.getElementById('battle-level-select').value);
            const maxPlayers = parseInt(document.getElementById('max-players-select').value);
            const isPublic = document.querySelector('input[name="room-type"]:checked').value === 'public';
            
            if (!roomName) {
                alert('Î∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            try {
                // 6ÏûêÎ¶¨ ÎûúÎç§ ÏΩîÎìú ÏÉùÏÑ±
                const roomCode = Math.floor(100000 + Math.random() * 900000).toString();
                
                const roomData = {
                    id: roomCode,
                    name: roomName,
                    subject: subject,
                    level: level,
                    maxPlayers: maxPlayers,
                    isPublic: isPublic,
                    status: 'waiting',
                    hostId: currentUserId,
                    createdAt: Date.now(),
                    players: {
                        [currentUserId]: {
                            name: currentUserProfile.name,
                            ready: false,
                            isHost: true,
                            score: 0,
                            correctCount: 0,
                            totalAttempts: 0
                        }
                    },
                    gameData: {
                        questions: [],
                        startTime: null,
                        duration: 60000,
                        currentQuestionIndex: 0
                    }
                };
                
                // FirebaseÏóê Î∞© ÏÉùÏÑ±
                await database.ref(`battleRooms/${roomCode}`).set(roomData);
                
                // Î∞© Ï∞∏Í∞Ä
                await joinBattleRoomById(roomCode);
                
            } catch (error) {
                console.error('Î∞© ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert('Î∞© ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }
        
        // Î∞© Ï∞∏Í∞Ä
        async function joinBattleRoom() {
            const roomCode = document.getElementById('room-code-input').value.trim();
            
            if (!roomCode || roomCode.length !== 6) {
                alert('6ÏûêÎ¶¨ Î∞© ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            await joinBattleRoomById(roomCode);
        }
        
        // IDÎ°ú Î∞© Ï∞∏Í∞Ä
        async function joinBattleRoomById(roomCode) {
            if (!currentUserProfile.name) {
                alert('Î®ºÏ†Ä Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            try {
                const roomSnapshot = await database.ref(`battleRooms/${roomCode}`).once('value');
                const roomData = roomSnapshot.val();
                
                if (!roomData) {
                    alert('Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Î∞©ÏûÖÎãàÎã§!');
                    return;
                }
                
                if (roomData.status !== 'waiting') {
                    alert('Ïù¥ÎØ∏ Í≤åÏûÑÏù¥ ÏãúÏûëÎêú Î∞©ÏûÖÎãàÎã§!');
                    return;
                }
                
                const currentPlayers = Object.keys(roomData.players || {}).length;
                if (currentPlayers >= roomData.maxPlayers) {
                    alert('Î∞©Ïù¥ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§!');
                    return;
                }
                
                if (roomData.players && roomData.players[currentUserId]) {
                    alert('Ïù¥ÎØ∏ Ï∞∏Í∞ÄÌïú Î∞©ÏûÖÎãàÎã§!');
                    return;
                }
                
                // Î∞©Ïóê ÌîåÎ†àÏù¥Ïñ¥ Ï∂îÍ∞Ä
                await database.ref(`battleRooms/${roomCode}/players/${currentUserId}`).set({
                    name: currentUserProfile.name,
                    ready: false,
                    isHost: false,
                    score: 0,
                    correctCount: 0,
                    totalAttempts: 0,
                    joinedAt: Date.now()
                });
                
                // Î∞© Ï†ïÎ≥¥ Ï†ÄÏû•
                gameState.battle.currentRoom = roomCode;
                gameState.battle.isInBattle = true;
                
                // ÎåÄÍ∏∞Ïã§Î°ú Ïù¥Îèô
                showWaitingRoom(roomData);
                
                // Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                setupRoomListener(roomCode);
                
            } catch (error) {
                console.error('Î∞© Ï∞∏Í∞Ä Ïã§Ìå®:', error);
                alert('Î∞© Ï∞∏Í∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }
        
        // ÎåÄÍ∏∞Ïã§ ÌëúÏãú
        function showWaitingRoom(roomData) {
            showBattleScreen('waiting-room-screen');
            
            // Î∞© Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('current-room-name').textContent = roomData.name;
            document.getElementById('room-subject-info').textContent = getSubjectDisplayName(roomData.subject);
            document.getElementById('room-level-info').textContent = `Level ${roomData.level}`;
            document.getElementById('room-code-info').textContent = `Î∞© ÏΩîÎìú: ${roomData.id}`;
            
            updatePlayersDisplay(roomData.players);
        }
        
        // Í≥ºÎ™© ÌëúÏãúÎ™Ö Î∞òÌôò
        function getSubjectDisplayName(subject) {
            const subjects = {
                'english': 'ÏòÅÏñ¥ üá¨üáß',
                'social': 'ÏÇ¨Ìöå üèõÔ∏è',
                'math': 'ÏàòÌïô üî¢',
                'general': 'ÏÉÅÏãù üß†'
            };
            return subjects[subject] || subject;
        }
        
        // ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updatePlayersDisplay(players) {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            
            Object.entries(players).forEach(([playerId, playerData]) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                
                const isMe = playerId === currentUserId;
                const hostBadge = playerData.isHost ? ' üëë' : '';
                
                playerDiv.innerHTML = `
                    <span class="player-name">${playerData.name}${hostBadge}${isMe ? ' (ÎÇò)' : ''}</span>
                    <span class="player-status ${playerData.ready ? 'ready' : 'waiting'}">
                        ${playerData.ready ? 'Ï§ÄÎπÑÏôÑÎ£å' : 'ÎåÄÍ∏∞Ï§ë'}
                    </span>
                `;
                
                if (isMe) {
                    playerDiv.style.background = 'rgba(255, 215, 0, 0.2)';
                }
                
                container.appendChild(playerDiv);
            });
        }
        
        // Ï§ÄÎπÑ ÏÉÅÌÉú ÌÜ†Í∏Ä
        async function toggleReady() {
            if (!gameState.battle.currentRoom) return;
            
            try {
                const playerRef = database.ref(`battleRooms/${gameState.battle.currentRoom}/players/${currentUserId}`);
                const playerSnapshot = await playerRef.once('value');
                const playerData = playerSnapshot.val();
                
                if (playerData) {
                    const newReadyState = !playerData.ready;
                    await playerRef.update({ ready: newReadyState });
                    
                    // Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                    const readyButton = document.getElementById('ready-button');
                    readyButton.textContent = newReadyState ? 'Ï§ÄÎπÑ Ìï¥Ï†ú' : 'Ï§ÄÎπÑ ÏôÑÎ£å';
                    readyButton.className = newReadyState ? 'btn-ready ready' : 'btn-ready';
                }
            } catch (error) {
                console.error('Ï§ÄÎπÑ ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®:', error);
            }
        }
        
        // Î∞© ÎÇòÍ∞ÄÍ∏∞
        async function leaveBattleRoom() {
            if (!gameState.battle.currentRoom) return;
            
            try {
                // ÌîåÎ†àÏù¥Ïñ¥ Ï†úÍ±∞
                await database.ref(`battleRooms/${gameState.battle.currentRoom}/players/${currentUserId}`).remove();
                
                // Î¶¨Ïä§ÎÑà Ï†úÍ±∞
                if (battleRoomRef) {
                    battleRoomRef.off();
                    battleRoomRef = null;
                }
                
                // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                gameState.battle.isInBattle = false;
                gameState.battle.currentRoom = null;
                
                // Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                showBattleMenu();
                
            } catch (error) {
                console.error('Î∞© ÎÇòÍ∞ÄÍ∏∞ Ïã§Ìå®:', error);
            }
        }
        
        // Î∞© Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Î¶¨Ïä§ÎÑà
        function setupRoomListener(roomCode) {
            battleRoomRef = database.ref(`battleRooms/${roomCode}`);
            
            battleRoomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                
                if (!roomData) {
                    // Î∞©Ïù¥ ÏÇ≠Ï†úÎê®
                    alert('Î∞©Ïù¥ Ìï¥Ï≤¥ÎêòÏóàÏäµÎãàÎã§.');
                    showBattleMenu();
                    return;
                }
                
                // ÏÉÅÌÉúÎ≥Ñ Ï≤òÎ¶¨
                if (roomData.status === 'waiting') {
                    updatePlayersDisplay(roomData.players);
                    checkAllPlayersReady(roomData);
                } else if (roomData.status === 'countdown') {
                    startCountdown();
                } else if (roomData.status === 'playing') {
                    startBattleGame(roomData);
                } else if (roomData.status === 'finished') {
                    showBattleResult(roomData);
                }
            });
        }
        
        // Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥ Ï§ÄÎπÑ ÏÉÅÌÉú ÌôïÏù∏
        function checkAllPlayersReady(roomData) {
            const players = Object.values(roomData.players || {});
            const readyPlayers = players.filter(p => p.ready);
            
            // ÏµúÏÜå 2Î™Ö Ïù¥ÏÉÅÏù¥Í≥† Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï§ÄÎπÑÎê®
            if (players.length >= 2 && readyPlayers.length === players.length) {
                // Ìò∏Ïä§Ìä∏Îßå Í≤åÏûÑ ÏãúÏûë Í∞ÄÎä•
                const myPlayer = roomData.players[currentUserId];
                if (myPlayer && myPlayer.isHost) {
                    setTimeout(async () => {
                        try {
                            await database.ref(`battleRooms/${gameState.battle.currentRoom}/status`).set('countdown');
                        } catch (error) {
                            console.error('Í≤åÏûÑ ÏãúÏûë Ïã§Ìå®:', error);
                        }
                    }, 1000);
                }
            }
        }
        
        // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë
        function startCountdown() {
            showBattleScreen('waiting-room-screen');
            document.getElementById('game-countdown').style.display = 'block';
            
            let count = 3;
            const countdownElement = document.querySelector('.countdown-number');
            
            battleCountdownTimer = setInterval(() => {
                countdownElement.textContent = count;
                
                if (count <= 0) {
                    clearInterval(battleCountdownTimer);
                    // Ìò∏Ïä§Ìä∏Í∞Ä Í≤åÏûÑ ÏãúÏûë
                    if (gameState.battle.currentRoom) {
                        database.ref(`battleRooms/${gameState.battle.currentRoom}`).once('value').then(snapshot => {
                            const roomData = snapshot.val();
                            if (roomData && roomData.players[currentUserId]?.isHost) {
                                startGameAsHost(roomData);
                            }
                        });
                    }
                }
                count--;
            }, 1000);
        }
        
        // Ìò∏Ïä§Ìä∏Í∞Ä Í≤åÏûÑ ÏãúÏûë
        async function startGameAsHost(roomData) {
            try {
                // Î¨∏Ï†ú Ï§ÄÎπÑ
                const questions = await prepareGameQuestions(roomData.subject, roomData.level);
                
                const gameData = {
                    questions: questions,
                    startTime: Date.now(),
                    duration: 60000,
                    currentQuestionIndex: 0
                };
                
                // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                await database.ref(`battleRooms/${gameState.battle.currentRoom}`).update({
                    status: 'playing',
                    gameData: gameData
                });
                
            } catch (error) {
                console.error('Í≤åÏûÑ ÏãúÏûë Ïã§Ìå®:', error);
            }
        }
        
        // Í≤åÏûÑ Î¨∏Ï†ú Ï§ÄÎπÑ
        async function prepareGameQuestions(subject, level) {
            try {
                const response = await fetch(getSubjectFilePath(level));
                const data = await response.json();
                const words = data.words || [];
                
                // ÎûúÎç§ÌïòÍ≤å 20Î¨∏Ï†ú ÏÑ†ÌÉù
                const shuffled = words.sort(() => Math.random() - 0.5);
                return shuffled.slice(0, 20);
                
            } catch (error) {
                console.error('Î¨∏Ï†ú Ï§ÄÎπÑ Ïã§Ìå®:', error);
                return [];
            }
        }
        
        // Î∞∞ÌãÄ Í≤åÏûÑ ÏãúÏûë
        function startBattleGame(roomData) {
            showBattleScreen('battle-game-screen');
            
            // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            gameState.battle.currentGame = {
                score: 0,
                correctCount: 0,
                totalAttempts: 0,
                startTime: roomData.gameData.startTime,
                questions: roomData.gameData.questions,
                currentQuestionIndex: 0
            };
            
            // Ï≤´ Î¨∏Ï†ú ÌëúÏãú
            displayBattleQuestion();
            
            // ÌÉÄÏù¥Î®∏ ÏãúÏûë
            startBattleTimer();
            
            // Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ ÏóÖÎç∞Ïù¥Ìä∏
            updateLiveRanking(roomData);
        }
        
        // Î∞∞ÌãÄ Î¨∏Ï†ú ÌëúÏãú
        function displayBattleQuestion() {
            const game = gameState.battle.currentGame;
            if (game.currentQuestionIndex >= game.questions.length) {
                // Î™®Îì† Î¨∏Ï†ú ÏôÑÎ£å
                return;
            }
            
            const question = game.questions[game.currentQuestionIndex];
            
            document.getElementById('battle-question-number').textContent = game.currentQuestionIndex + 1;
            document.getElementById('battle-question-text').textContent = question.question || question.korean;
            
            // ÏÑ†ÌÉùÏßÄ ÏÉùÏÑ±
            const optionsContainer = document.getElementById('battle-options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'battle-option-btn';
                optionBtn.textContent = option;
                optionBtn.onclick = () => selectBattleAnswer(index, option);
                optionsContainer.appendChild(optionBtn);
            });
            
            // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
            updateBattleProgress();
        }
        
        // Î∞∞ÌãÄ ÎãµÏïà ÏÑ†ÌÉù
        async function selectBattleAnswer(selectedIndex, selectedOption) {
            const game = gameState.battle.currentGame;
            const question = game.questions[game.currentQuestionIndex];
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.battle-option-btn').forEach(btn => btn.disabled = true);
            
            const isCorrect = selectedIndex === question.answer;
            game.totalAttempts++;
            
            if (isCorrect) {
                game.correctCount++;
                game.score += calculateBattleScore();
            }
            
            // Ï†ïÎãµ/Ïò§Îãµ ÌëúÏãú
            const buttons = document.querySelectorAll('.battle-option-btn');
            buttons[selectedIndex].className += isCorrect ? ' correct' : ' incorrect';
            if (!isCorrect) {
                buttons[question.answer].className += ' correct';
            }
            
            // Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('battle-current-score').textContent = game.score;
            updateBattleProgress();
            
            // FirebaseÏóê Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
            if (gameState.battle.currentRoom) {
                await database.ref(`battleRooms/${gameState.battle.currentRoom}/players/${currentUserId}`).update({
                    score: game.score,
                    correctCount: game.correctCount,
                    totalAttempts: game.totalAttempts
                });
            }
            
            // Îã§Ïùå Î¨∏Ï†úÎ°ú
            setTimeout(() => {
                game.currentQuestionIndex++;
                displayBattleQuestion();
            }, 1500);
        }
        
        // Î∞∞ÌãÄ Ï†êÏàò Í≥ÑÏÇ∞
        function calculateBattleScore() {
            const baseScore = 100;
            const timeBonus = Math.max(0, 50 - (Date.now() - gameState.battle.currentGame.questionStartTime) / 1000);
            return Math.round(baseScore + timeBonus);
        }
        
        // Î∞∞ÌãÄ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
        function updateBattleProgress() {
            const game = gameState.battle.currentGame;
            const progress = (game.currentQuestionIndex / game.questions.length) * 100;
            
            document.getElementById('battle-progress-fill').style.width = progress + '%';
            document.getElementById('battle-correct-count').textContent = game.correctCount;
            document.getElementById('battle-total-attempts').textContent = game.totalAttempts;
        }
        
        // Î∞∞ÌãÄ ÌÉÄÏù¥Î®∏ ÏãúÏûë
        function startBattleTimer() {
            const duration = 60; // 60Ï¥à
            let timeLeft = duration;
            
            const timerElement = document.getElementById('battle-timer');
            
            battleGameTimer = setInterval(() => {
                timerElement.textContent = timeLeft;
                
                if (timeLeft <= 10) {
                    timerElement.className = 'timer-number warning';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(battleGameTimer);
                    endBattleGame();
                }
                
                timeLeft--;
            }, 1000);
        }
        
        // Î∞∞ÌãÄ Í≤åÏûÑ Ï¢ÖÎ£å
        async function endBattleGame() {
            if (battleGameTimer) {
                clearInterval(battleGameTimer);
            }
            
            // Ìò∏Ïä§Ìä∏Í∞Ä Í≤åÏûÑ Ï¢ÖÎ£å Ï≤òÎ¶¨
            if (gameState.battle.currentRoom) {
                const roomSnapshot = await database.ref(`battleRooms/${gameState.battle.currentRoom}`).once('value');
                const roomData = roomSnapshot.val();
                
                if (roomData && roomData.players[currentUserId]?.isHost) {
                    await database.ref(`battleRooms/${gameState.battle.currentRoom}/status`).set('finished');
                }
            }
        }
        
        // Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateLiveRanking(roomData) {
            const rankingList = document.getElementById('live-ranking-list');
            rankingList.innerHTML = '';
            
            const players = Object.entries(roomData.players || {})
                .sort(([,a], [,b]) => (b.score || 0) - (a.score || 0));
            
            players.forEach(([playerId, playerData], index) => {
                const rankDiv = document.createElement('div');
                rankDiv.className = `rank-item${playerId === currentUserId ? ' me' : ''}`;
                rankDiv.innerHTML = `
                    <span>${index + 1}. ${playerData.name}</span>
                    <span>${playerData.score || 0}</span>
                `;
                rankingList.appendChild(rankDiv);
            });
        }
        
        // Î∞∞ÌãÄ Í≤∞Í≥º ÌëúÏãú
        function showBattleResult(roomData) {
            showBattleScreen('battle-result-screen');
            
            // ÏµúÏ¢Ö ÏàúÏúÑ Í≥ÑÏÇ∞
            const players = Object.entries(roomData.players || {})
                .sort(([,a], [,b]) => {
                    // Ï†êÏàò -> Ï†ïÎãµÎ•† -> ÏÜçÎèÑ ÏàúÏúºÎ°ú Ï†ïÎ†¨
                    const scoreA = a.score || 0;
                    const scoreB = b.score || 0;
                    if (scoreB !== scoreA) return scoreB - scoreA;
                    
                    const accuracyA = a.totalAttempts > 0 ? (a.correctCount / a.totalAttempts) : 0;
                    const accuracyB = b.totalAttempts > 0 ? (b.correctCount / b.totalAttempts) : 0;
                    return accuracyB - accuracyA;
                });
            
            // ÏàúÏúÑ ÌëúÏãú
            const rankingList = document.getElementById('final-ranking-list');
            rankingList.innerHTML = '';
            
            players.forEach(([playerId, playerData], index) => {
                const rankDiv = document.createElement('div');
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                rankDiv.className = `ranking-item ${rankClass}`;
                
                const accuracy = playerData.totalAttempts > 0 ? 
                    Math.round((playerData.correctCount / playerData.totalAttempts) * 100) : 0;
                
                rankDiv.innerHTML = `
                    <div class="rank-position">${index + 1}</div>
                    <div class="rank-player">
                        <div class="rank-player-name">${playerData.name}</div>
                        <div class="rank-player-stats">${playerData.correctCount}/${playerData.totalAttempts} (${accuracy}%)</div>
                    </div>
                    <div class="rank-score">${playerData.score || 0}</div>
                `;
                
                rankingList.appendChild(rankDiv);
            });
            
            // ÎÇ¥ Í≤∞Í≥º ÌëúÏãú
            const myRank = players.findIndex(([playerId]) => playerId === currentUserId) + 1;
            const myData = roomData.players[currentUserId] || {};
            const myAccuracy = myData.totalAttempts > 0 ? 
                Math.round((myData.correctCount / myData.totalAttempts) * 100) : 0;
            
            document.getElementById('my-rank').textContent = `${myRank}ÏúÑ`;
            document.getElementById('my-correct').textContent = `${myData.correctCount}/${myData.totalAttempts}`;
            document.getElementById('my-accuracy').textContent = `${myAccuracy}%`;
            document.getElementById('my-points').textContent = myData.score || 0;
            
            // Î≥¥ÏÉÅ Í≥ÑÏÇ∞ Î∞è ÌëúÏãú
            calculateAndShowRewards(myRank, myData);
            
            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updatePlayerBattleStats(myRank === 1);
        }
        
        // Î≥¥ÏÉÅ Í≥ÑÏÇ∞ Î∞è ÌëúÏãú
        function calculateAndShowRewards(rank, playerData) {
            const rewardsContainer = document.getElementById('battle-rewards');
            rewardsContainer.innerHTML = '';
            
            let coins = 0;
            let battlePoints = 0;
            
            if (rank === 1) {
                coins = 200;
                battlePoints = 15;
            } else if (rank === 2) {
                coins = 100;
                battlePoints = 8;
            } else if (rank === 3) {
                coins = 50;
                battlePoints = 5;
            } else {
                coins = 20;
                battlePoints = 2;
            }
            
            // Ï∞∏Í∞Ä Î≥¥ÎÑàÏä§
            coins += 10;
            battlePoints += 1;
            
            // Î≥¥ÏÉÅ Ï†ÅÏö©
            gameState.coins += coins;
            gameState.battle.playerStats.points += battlePoints;
            
            // Î≥¥ÏÉÅ ÌëúÏãú
            rewardsContainer.innerHTML = `
                <div class="reward-item">
                    <span class="reward-icon">üí∞</span>
                    <span class="reward-text">${coins} ÏΩîÏù∏</span>
                </div>
                <div class="reward-item">
                    <span class="reward-icon">‚≠ê</span>
                    <span class="reward-text">${battlePoints} ÏäπÏ†ê</span>
                </div>
                ${rank === 1 ? '<div class="reward-item"><span class="reward-icon">üèÜ</span><span class="reward-text">ÏäπÎ¶¨ Î≥¥ÎÑàÏä§!</span></div>' : ''}
            `;
            
            // Ï†ÄÏû•
            saveCurrentUserData();
        }
        
        // ÌîåÎ†àÏù¥Ïñ¥ Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePlayerBattleStats(isWinner) {
            gameState.battle.playerStats.totalBattles++;
            if (isWinner) {
                gameState.battle.playerStats.wins++;
            }
            
            // Îû≠ÌÅ¨ Í≥ÑÏÇ∞
            const points = gameState.battle.playerStats.points;
            if (points < 100) gameState.battle.playerStats.rank = 'bronze';
            else if (points < 300) gameState.battle.playerStats.rank = 'silver';
            else if (points < 600) gameState.battle.playerStats.rank = 'gold';
            else if (points < 1000) gameState.battle.playerStats.rank = 'platinum';
            else gameState.battle.playerStats.rank = 'diamond';
        }
        
        // Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateBattleStats() {
            const stats = gameState.battle.playerStats;
            
            document.getElementById('total-battles').textContent = stats.totalBattles;
            document.getElementById('battle-wins').textContent = stats.wins;
            document.getElementById('battle-winrate').textContent = 
                stats.totalBattles > 0 ? Math.round((stats.wins / stats.totalBattles) * 100) + '%' : '0%';
            document.getElementById('battle-points').textContent = stats.points;
            
            // Îû≠ÌÅ¨ ÌëúÏãú
            const rankNames = {
                'bronze': 'Î∏åÎ°†Ï¶à ü•â',
                'silver': 'Ïã§Î≤Ñ ü•à', 
                'gold': 'Í≥®Îìú ü•á',
                'platinum': 'ÌîåÎûòÌã∞ÎÑò üíé',
                'diamond': 'Îã§Ïù¥ÏïÑÎ™¨Îìú üí†'
            };
            
            document.getElementById('current-rank-badge').textContent = rankNames[stats.rank] || 'Î∏åÎ°†Ï¶à ü•â';
            
            // Îã§Ïùå Îû≠ÌÅ¨ÍπåÏßÄ ÏßÑÌñâÎ•†
            const rankThresholds = { bronze: 100, silver: 300, gold: 600, platinum: 1000 };
            const currentThreshold = rankThresholds[stats.rank] || 1000;
            const prevThreshold = stats.rank === 'bronze' ? 0 : 
                                 stats.rank === 'silver' ? 100 :
                                 stats.rank === 'gold' ? 300 : 600;
            
            const progress = Math.min(100, ((stats.points - prevThreshold) / (currentThreshold - prevThreshold)) * 100);
            
            document.getElementById('current-points').textContent = stats.points;
            document.getElementById('next-rank-points').textContent = currentThreshold;
            document.getElementById('rank-progress-fill').style.width = progress + '%';
        }
        
        // Í≥µÍ∞úÎ∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        async function refreshPublicRooms() {
            const container = document.getElementById('public-rooms-container');
            container.innerHTML = '<div class="loading">Í≥µÍ∞úÎ∞©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
            
            try {
                const roomsSnapshot = await database.ref('battleRooms').orderByChild('isPublic').equalTo(true).once('value');
                const rooms = roomsSnapshot.val() || {};
                
                container.innerHTML = '';
                
                const publicRooms = Object.entries(rooms)
                    .filter(([, room]) => room.status === 'waiting')
                    .sort(([, a], [, b]) => b.createdAt - a.createdAt);
                
                if (publicRooms.length === 0) {
                    container.innerHTML = '<div class="no-rooms">ÌòÑÏû¨ Ï∞∏Í∞Ä Í∞ÄÎä•Ìïú Í≥µÍ∞úÎ∞©Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                    return;
                }
                
                publicRooms.forEach(([roomId, room]) => {
                    const roomDiv = document.createElement('div');
                    roomDiv.className = 'room-item';
                    roomDiv.onclick = () => joinBattleRoomById(roomId);
                    
                    const playerCount = Object.keys(room.players || {}).length;
                    
                    roomDiv.innerHTML = `
                        <div class="room-header">
                            <span class="room-name">${room.name}</span>
                            <span class="room-players">${playerCount}/${room.maxPlayers}</span>
                        </div>
                        <div class="room-info-line">
                            ${getSubjectDisplayName(room.subject)} | Level ${room.level} | Î∞©Ïû•: ${room.players[room.hostId]?.name || 'Ïïå Ïàò ÏóÜÏùå'}
                        </div>
                    `;
                    
                    container.appendChild(roomDiv);
                });
                
            } catch (error) {
                console.error('Í≥µÍ∞úÎ∞© Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                container.innerHTML = '<div class="error">Í≥µÍ∞úÎ∞© Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }
        
        // Îã§Ïãú ÌïòÍ∏∞
        function playAgain() {
            showBattleMenu();
        }

        console.log('üêæ ÎèôÎ¨º ÏàòÏßë ÌïôÏäµ Í≤åÏûÑÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§! (v10.0 - Î∞∞ÌãÄÎ™®Îìú Ï∂îÍ∞Ä)');
        
        // ==================== Î°úÍ∑∏Ïù∏ Ïù¥Î≤§Ìä∏ (Ïù∏ÎùºÏù∏ÏúºÎ°ú Ï≤òÎ¶¨Îê®) ====================
        
        console.log('üéÆ Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú Ï§ÄÎπÑ ÏôÑÎ£å - Ïù∏ÎùºÏù∏ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ÏÇ¨Ïö©');
        
        // Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ìï®Ïàò
        async function handleLogin() {
            console.log('Î°úÍ∑∏Ïù∏ ÏãúÎèÑ...');
            const playerName = document.getElementById('player-name-input').value.trim();
            const playerPin = document.getElementById('player-pin-input').value.trim();
            const feedback = document.getElementById('login-feedback');
            
            if (!playerName || !playerPin) {
                feedback.textContent = 'Ïù¥Î¶ÑÍ≥º PINÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!';
                feedback.style.color = '#ff6b6b';
                return;
            }
            
            if (playerPin.length !== 4 || !/^\d{4}$/.test(playerPin)) {
                feedback.textContent = 'PINÏùÄ 4ÏûêÎ¶¨ Ïà´ÏûêÏó¨Ïïº Ìï©ÎãàÎã§!';
                feedback.style.color = '#ff6b6b';
                return;
            }
            
            try {
                feedback.textContent = 'Î°úÍ∑∏Ïù∏ Ï§ë...';
                feedback.style.color = '#4169E1';
                
                // FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = window.firebase.doc(window.firebase.db, 'artifacts', appId, 'public/data/profiles', playerName);
                const userDoc = await window.firebase.getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.pin === playerPin) {
                        // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ
                        console.log('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:', playerName);
                        await loginSuccess(userData);
                    } else {
                        feedback.textContent = 'ÏûòÎ™ªÎêú PINÏûÖÎãàÎã§!';
                        feedback.style.color = '#ff6b6b';
                    }
                } else {
                    feedback.textContent = 'Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÏÇ¨Ïö©ÏûêÏûÖÎãàÎã§. ÏÉà ÌîåÎ†àÏù¥Ïñ¥Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!';
                    feedback.style.color = '#ff6b6b';
                }
            } catch (error) {
                console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', error);
                feedback.textContent = 'Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                feedback.style.color = '#ff6b6b';
            }
        }
        
        // ÌöåÏõêÍ∞ÄÏûÖ Ï≤òÎ¶¨ Ìï®Ïàò
        async function handleSignup() {
            console.log('ÌöåÏõêÍ∞ÄÏûÖ ÏãúÎèÑ...');
            const playerName = document.getElementById('player-name-input').value.trim();
            const playerPin = document.getElementById('player-pin-input').value.trim();
            const feedback = document.getElementById('login-feedback');
            
            if (!playerName || !playerPin) {
                feedback.textContent = 'Ïù¥Î¶ÑÍ≥º PINÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!';
                feedback.style.color = '#ff6b6b';
                return;
            }
            
            if (playerPin.length !== 4 || !/^\d{4}$/.test(playerPin)) {
                feedback.textContent = 'PINÏùÄ 4ÏûêÎ¶¨ Ïà´ÏûêÏó¨Ïïº Ìï©ÎãàÎã§!';
                feedback.style.color = '#ff6b6b';
                return;
            }
            
            try {
                feedback.textContent = 'ÏÉà ÌîåÎ†àÏù¥Ïñ¥ ÏÉùÏÑ± Ï§ë...';
                feedback.style.color = '#4169E1';
                
                // FirebaseÏóêÏÑú ÏÇ¨Ïö©ÏûêÎ™Ö Ï§ëÎ≥µ ÌôïÏù∏
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = window.firebase.doc(window.firebase.db, 'artifacts', appId, 'public/data/profiles', playerName);
                const userDoc = await window.firebase.getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    feedback.textContent = 'Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏÇ¨Ïö©ÏûêÎ™ÖÏûÖÎãàÎã§!';
                    feedback.style.color = '#ff6b6b';
                    return;
                }
                
                // ÏÉà ÏÇ¨Ïö©Ïûê ÏÉùÏÑ±
                const newUserData = {
                    name: playerName,
                    pin: playerPin,
                    createdAt: Date.now(),
                    score: 0,
                    coins: 100, // ÏãúÏûë ÏΩîÏù∏
                    level: 1,
                    animals: {},
                    totalAnimals: 0,
                    speciesCount: 0,
                    farm: {
                        layout: Array(48).fill(null),
                        items: {}
                    },
                    subjects: {
                        english: { progress: {}, level: 1, score: 0, currentDifficulty: 1, totalCorrect: 0, totalIncorrect: 0 },
                        social: { progress: {}, level: 1, score: 0, currentDifficulty: 1, totalCorrect: 0, totalIncorrect: 0 },
                        math: { progress: {}, level: 1, score: 0, currentDifficulty: 1, totalCorrect: 0, totalIncorrect: 0 },
                        general: { progress: {}, level: 1, score: 0, currentDifficulty: 1, totalCorrect: 0, totalIncorrect: 0 }
                    },
                    currentSubject: 'english',
                    battlePoints: 0,
                    battleHistory: []
                };
                
                await window.firebase.setDoc(userDocRef, newUserData);
                console.log('ÏÉà ÌîåÎ†àÏù¥Ïñ¥ ÏÉùÏÑ± ÏôÑÎ£å:', playerName);
                
                // ÏûêÎèô Î°úÍ∑∏Ïù∏
                await loginSuccess(newUserData);
                
            } catch (error) {
                console.error('ÌöåÏõêÍ∞ÄÏûÖ Ïò§Î•ò:', error);
                feedback.textContent = 'ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                feedback.style.color = '#ff6b6b';
            }
        }
        
        // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ Ï≤òÎ¶¨
        async function loginSuccess(userData) {
            console.log('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ Ï≤òÎ¶¨ ÏãúÏûë:', userData.name);
            
            // Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ§Ï†ï
            currentUserProfile = userData;
            gameState = {...gameState, ...userData};
            
            // ÏÑ∏ÏÖò ÏãúÏûë ÏãúÍ∞Ñ Í∏∞Î°ù
            sessionStartTime = Date.now();
            
            // UI Ï†ÑÌôò
            document.getElementById('login-overlay').style.display = 'none';
            document.querySelector('.game-container').style.display = 'block';
            document.getElementById('current-user-name').textContent = userData.name;
            
            // ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ Î°úÎìú
            if (animalTypes.length === 0) {
                await window.loadAnimalsFromJSON();
            }
            
            updateUI();
            updateAnimalCollection();
            
            // Í≥ºÎ™©Î≥Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            loadCurrentSubjectProgress();
            updateSubjectUI();
            
            // Í≥ºÎ™© ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ Ï¥àÍ∏∞Ìôî
            const subjectSelect = document.getElementById('subject-select');
            if (subjectSelect) {
                subjectSelect.value = gameState.currentSubject;
            }
            
            // Îß§Ïùº Î°úÍ∑∏Ïù∏ Î≥¥ÏÉÅ Ï≤¥ÌÅ¨
            setTimeout(() => {
                checkDailyLoginReward();
            }, 1000);
            
            initializeFarm();
            
            // ÏÇ¨Ïö©Ïûê ÌïôÏäµ ÏßÑÌñâÎèÑ Î°úÎìú ÌõÑ ÌÄ¥Ï¶à ÏãúÏûë
            try {
                if (gameState.subjects && gameState.subjects[gameState.currentSubject]) {
                    const currentSubjectData = gameState.subjects[gameState.currentSubject];
                    selectDifficulty(currentSubjectData.currentDifficulty || 1);
                } else {
                    selectDifficulty(1);
                }
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê ÏßÑÌñâÎèÑ Î°úÎìú Ïã§Ìå®:', error);
                selectDifficulty(1);
            }
            
            showPage('game', document.querySelector('.nav-btn'));
            
            console.log('Î°úÍ∑∏Ïù∏ ÏôÑÎ£å, Í≤åÏûÑ ÏãúÏûë!');
        }
        
        // ==================== Î∞∞ÌãÄÎ™®Îìú Ìï®ÏàòÎì§ ÏôÑÏ†Ñ Ï†ïÏùò ====================
        
        // Î∞∞ÌãÄ ÌôîÎ©¥ Ï†ÑÌôò Ìï®ÏàòÎì§
        window.showJoinRoomModal = function() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('join-room-screen').classList.add('active');
            console.log('Î∞© Ï∞∏Í∞Ä ÌôîÎ©¥ ÌëúÏãú');
        };

        window.showPublicRooms = function() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('public-rooms-screen').classList.add('active');
            refreshPublicRooms();
            console.log('Í≥µÍ∞úÎ∞© Î™©Î°ù ÌëúÏãú');
        };

        window.showBattleStats = function() {
            document.querySelectorAll('.battle-screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('battle-stats-screen').classList.add('active');
            updateBattleStats();
            console.log('Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÌôîÎ©¥ ÌëúÏãú');
        };

        // Î∞© ÏÉùÏÑ± Ìï®Ïàò
        window.createBattleRoom = function() {
            console.log('createBattleRoom Ìï®Ïàò Ìò∏Ï∂úÎê®');
            
            // ÏûÖÎ†•Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
            const roomNameInput = document.getElementById('room-name-input');
            const subjectSelect = document.getElementById('battle-subject-select');
            const levelSelect = document.getElementById('battle-level-select');
            const maxPlayersSelect = document.getElementById('max-players-select');
            const roomTypeRadio = document.querySelector('input[name="room-type"]:checked');
            
            // ÏûÖÎ†•Í∞í Í≤ÄÏ¶ù
            const roomName = roomNameInput ? roomNameInput.value.trim() : '';
            const subject = subjectSelect ? subjectSelect.value : 'english';
            const level = levelSelect ? levelSelect.value : '1';
            const maxPlayers = maxPlayersSelect ? maxPlayersSelect.value : '4';
            const roomType = roomTypeRadio ? roomTypeRadio.value : 'public';
            
            console.log('ÏûÖÎ†•Í∞í:', {roomName, subject, level, maxPlayers, roomType});
            
            if (!roomName) {
                alert('Î∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // 6ÏûêÎ¶¨ ÎûúÎç§ Î∞© ÏΩîÎìú ÏÉùÏÑ±
            const roomCode = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Í≥ºÎ™©Î™Ö Î≥ÄÌôò
            const subjectNames = {
                'english': 'ÏòÅÏñ¥ üá¨üáß',
                'social': 'ÏÇ¨Ìöå üèõÔ∏è', 
                'math': 'ÏàòÌïô üî¢',
                'general': 'ÏÉÅÏãù üß†'
            };
            
            const subjectName = subjectNames[subject] || subject;
            const roomTypeText = roomType === 'public' ? 'Í≥µÍ∞úÎ∞©' : 'ÎπÑÍ≥µÍ∞úÎ∞©';
            
            // ÏÑ±Í≥µ Î©îÏãúÏßÄ
            alert(`üéâ Î∞∞ÌãÄÎ∞© ÏÉùÏÑ± ÏôÑÎ£å!

üìã Î∞© Ï†ïÎ≥¥:
‚Ä¢ Î∞© Ïù¥Î¶Ñ: ${roomName}
‚Ä¢ Î∞© ÏΩîÎìú: ${roomCode}
‚Ä¢ Í≥ºÎ™©: ${subjectName}
‚Ä¢ ÎÇúÏù¥ÎèÑ: Level ${level}
‚Ä¢ ÏµúÎåÄÏù∏Ïõê: ${maxPlayers}Î™Ö
‚Ä¢ Í≥µÍ∞úÏÑ§Ï†ï: ${roomTypeText}

‚úÖ Î∞∞ÌãÄÎ∞©Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!
Ïã§Ï†ú Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Í∏∞Îä•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.`);
            
            console.log('‚úÖ Î∞© ÏÉùÏÑ± ÏôÑÎ£å:', {roomName, roomCode, subject, level, maxPlayers, roomType});
            
            // Î∞© ÏÉùÏÑ± ÌõÑ Î©îÏù∏ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            showBattleMenu();
        };

        // Î∞© Ï∞∏Í∞Ä Ìï®Ïàò  
        window.joinBattleRoom = function() {
            console.log('joinBattleRoom Ìï®Ïàò Ìò∏Ï∂úÎê®');
            
            const roomCodeInput = document.getElementById('room-code-input');
            const roomCode = roomCodeInput ? roomCodeInput.value.trim() : '';
            
            console.log('ÏûÖÎ†•Ìïú Î∞© ÏΩîÎìú:', roomCode);
            
            if (!roomCode) {
                alert('Î∞© ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            if (roomCode.length !== 6 || !/^\d{6}$/.test(roomCode)) {
                alert('Ïò¨Î∞îÎ•∏ 6ÏûêÎ¶¨ Ïà´Ïûê Î∞© ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!\nÏòà: 123456');
                return;
            }
            
            // ÏÑ±Í≥µ Î©îÏãúÏßÄ
            alert(`üö™ Î∞© Ï∞∏Í∞Ä ÏãúÎèÑ!

ÏûÖÎ†•Ìïú ÏΩîÎìú: ${roomCode}

‚úÖ Î∞© ÏΩîÎìú ÌòïÏãùÏù¥ Ïò¨Î∞îÎ¶ÖÎãàÎã§!
Ïã§Ï†ú Î∞© Ï∞∏Í∞Ä Í∏∞Îä•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.`);
            
            console.log('‚úÖ Î∞© Ï∞∏Í∞Ä ÏãúÎèÑ ÏôÑÎ£å:', roomCode);
            
            // Ï∞∏Í∞Ä ÌõÑ Î©îÏù∏ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            showBattleMenu();
        };

        // Í≥µÍ∞úÎ∞© ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
        window.refreshPublicRooms = function() {
            const container = document.getElementById('public-rooms-container');
            container.innerHTML = '<div class="loading" style="color: #FFD700; text-align: center; padding: 20px; font-size: 1.1rem;">‚ú® Í≥µÍ∞úÎ∞©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
            
            setTimeout(() => {
                container.innerHTML = `
                    <div class="room-item">
                        <div class="room-info">
                            <h4>üéØ ÏòÅÏñ¥ ÎßàÏä§ÌÑ∞ Î∞∞ÌãÄ</h4>
                            <div class="room-details">ÏòÅÏñ¥ üá¨üáß | Level 1 | 2/4Î™Ö</div>
                            <div class="room-host">Î∞©Ïû•: EnglishMaster</div>
                        </div>
                        <button class="btn-join" onclick="joinPublicRoom('123456')">Ï∞∏Í∞Ä</button>
                    </div>
                    
                    <div class="room-item">
                        <div class="room-info">
                            <h4>üßÆ ÏàòÌïô Ï±åÎ¶∞ÏßÄ ÏïÑÎ†àÎÇò</h4>
                            <div class="room-details">ÏàòÌïô üî¢ | Level 2 | 1/6Î™Ö</div>
                            <div class="room-host">Î∞©Ïû•: MathGenius</div>
                        </div>
                        <button class="btn-join" onclick="joinPublicRoom('789012')">Ï∞∏Í∞Ä</button>
                    </div>
                    
                    <div class="room-item">
                        <div class="room-info">
                            <h4>üèõÔ∏è ÏÇ¨Ìöå ÏßÄÏãùÏôï ÎåÄÌöå</h4>
                            <div class="room-details">ÏÇ¨Ìöå üèõÔ∏è | Level 3 | 3/4Î™Ö</div>
                            <div class="room-host">Î∞©Ïû•: SocialExpert</div>
                        </div>
                        <button class="btn-join" onclick="joinPublicRoom('345678')">Ï∞∏Í∞Ä</button>
                    </div>
                    
                    <div class="room-item">
                        <div class="room-info">
                            <h4>üß† ÏÉÅÏãù ÌÄ¥Ï¶à ÌÜ†ÎÑàÎ®ºÌä∏</h4>
                            <div class="room-details">ÏÉÅÏãù üß† | Level 1 | 2/8Î™Ö</div>
                            <div class="room-host">Î∞©Ïû•: QuizMaster</div>
                        </div>
                        <button class="btn-join" onclick="joinPublicRoom('901234')">Ï∞∏Í∞Ä</button>
                    </div>
                `;
            }, 1000);
            
            console.log('‚ú® Í≥µÍ∞úÎ∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å!');
        };

        // Í≥µÍ∞úÎ∞© Ï∞∏Í∞Ä Ìï®Ïàò
        window.joinPublicRoom = function(roomCode) {
            alert(`üéâ Í≥µÍ∞úÎ∞© Ï∞∏Í∞Ä!

Î∞© ÏΩîÎìú: ${roomCode}Î°ú Ï∞∏Í∞ÄÌï©ÎãàÎã§.

‚úÖ Ïã§Ï†ú Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î∞∞ÌãÄÏù¥ Í≥ß ÏãúÏûëÎê©ÎãàÎã§!
Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Îì§Í≥º Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í≤ΩÏüÅÌïòÏÑ∏Ïöî!`);
            console.log('Í≥µÍ∞úÎ∞© Ï∞∏Í∞Ä:', roomCode);
        };

        // Í∏∞Î≥∏ Í≤åÏûÑ ÏÉÅÌÉú Í∞ùÏ≤¥ Ï†ïÏùò
        if (!window.gameState) {
            window.gameState = {};
        }
        if (!window.gameState.battle) {
            window.gameState.battle = {
                playerStats: {
                    totalBattles: 5,
                    wins: 3,
                    points: 150,
                    rank: 'silver'
                }
            };
        }

        // Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        window.updateBattleStats = function() {
            const stats = window.gameState.battle.playerStats;
            
            if (document.getElementById('total-battles')) {
                document.getElementById('total-battles').textContent = stats.totalBattles;
            }
            if (document.getElementById('battle-wins')) {
                document.getElementById('battle-wins').textContent = stats.wins;
            }
            if (document.getElementById('battle-winrate')) {
                const winRate = stats.totalBattles > 0 ? Math.round((stats.wins / stats.totalBattles) * 100) : 0;
                document.getElementById('battle-winrate').textContent = winRate + '%';
            }
            if (document.getElementById('battle-points')) {
                document.getElementById('battle-points').textContent = stats.points;
            }
            
            // Îû≠ÌÅ¨ ÌëúÏãú
            const rankNames = {
                'bronze': 'Î∏åÎ°†Ï¶à ü•â',
                'silver': 'Ïã§Î≤Ñ ü•à', 
                'gold': 'Í≥®Îìú ü•á',
                'platinum': 'ÌîåÎûòÌã∞ÎÑò üíé',
                'diamond': 'Îã§Ïù¥ÏïÑÎ™¨Îìú üí†'
            };
            
            if (document.getElementById('current-rank-badge')) {
                document.getElementById('current-rank-badge').textContent = rankNames[stats.rank] || 'Î∏åÎ°†Ï¶à ü•â';
            }
            
            if (document.getElementById('current-points')) {
                document.getElementById('current-points').textContent = stats.points;
            }
            if (document.getElementById('next-rank-points')) {
                document.getElementById('next-rank-points').textContent = '300';
            }
            if (document.getElementById('rank-progress-fill')) {
                const progress = ((stats.points % 100) / 100) * 100;
                document.getElementById('rank-progress-fill').style.width = progress + '%';
            }
            
            console.log('Î∞∞ÌãÄ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        };
        
        console.log('üéÆ Î™®Îì† Î∞∞ÌãÄÎ™®Îìú Ìï®ÏàòÎì§Ïù¥ ÏÑúÎ≤ÑÏóê ÏôÑÏ†ÑÌûà Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
        
        // ==================== ÌïµÏã¨ Í≤åÏûÑ Ìï®ÏàòÎì§ ÏôÑÏ†Ñ Ï†ïÏùò ====================
        
        // showPage Ìï®Ïàò ÏôÑÏ†Ñ Ï†ïÏùò (Í∞ÄÏû• Ï§ëÏöî!)
        window.showPage = function(pageName, element) {
            console.log('showPage Ìò∏Ï∂ú:', pageName);
            
            // Î™®Îì† ÌéòÏù¥ÏßÄ ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // Î™®Îì† ÎÑ§ÎπÑ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú ÌéòÏù¥ÏßÄ ÌôúÏÑ±Ìôî
            const targetPage = document.getElementById(pageName + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block';
                console.log('ÌéòÏù¥ÏßÄ ÌôúÏÑ±Ìôî:', pageName);
            } else {
                console.error('ÌéòÏù¥ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå:', pageName + '-page');
            }
            
            // ÏÑ†ÌÉùÎêú Î≤ÑÌäº ÌôúÏÑ±Ìôî
            if (element) {
                element.classList.add('active');
            }
            
            // Í≤åÏûÑ ÌÜµÍ≥ÑÏôÄ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú Í¥ÄÎ¶¨
            const gameStats = document.getElementById('game-stats');
            const userInfo = document.getElementById('user-info');
            
            if (gameStats && userInfo) {
                if (pageName === 'game' || pageName === 'farm') {
                    gameStats.style.display = 'flex';
                    userInfo.style.display = 'block';
                } else {
                    gameStats.style.display = 'none';
                    userInfo.style.display = 'block';
                }
            }
            
            // ÌäπÏ†ï ÌéòÏù¥ÏßÄÎ≥Ñ Ï¥àÍ∏∞Ìôî
            if (pageName === 'battle') {
                setTimeout(() => {
                    if (window.showBattleMenu) {
                        showBattleMenu();
                    }
                }, 100);
            }
        };

        // selectDifficulty Ìï®Ïàò Ï†ïÏùò
        window.selectDifficulty = function(level) {
            console.log('ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù:', level);
            
            // ÎÇúÏù¥ÎèÑ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const selectedBtn = document.querySelector(`[data-level="${level}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            
            // ÌòÑÏû¨ ÎÇúÏù¥ÎèÑ Ï†ÄÏû•
            window.currentDifficulty = level;
            
            // Ïã§Ï†ú Î¨∏Ï†ú Î°úÎî© ÏãúÎÆ¨Î†àÏù¥ÏÖò
            const questionDiv = document.getElementById('english-question');
            const optionsDiv = document.getElementById('english-options');
            
            if (questionDiv && optionsDiv) {
                questionDiv.textContent = `Level ${level} Î¨∏Ï†úÍ∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!`;
                optionsDiv.innerHTML = `
                    <button class="english-option-btn" onclick="alert('Ï†ïÎãµÏûÖÎãàÎã§!')">Ï†ïÎãµ ÏòµÏÖò</button>
                    <button class="english-option-btn" onclick="alert('Ïò§ÎãµÏûÖÎãàÎã§!')">Ïò§Îãµ ÏòµÏÖò 1</button>
                    <button class="english-option-btn" onclick="alert('Ïò§ÎãµÏûÖÎãàÎã§!')">Ïò§Îãµ ÏòµÏÖò 2</button>
                    <button class="english-option-btn" onclick="alert('Ïò§ÎãµÏûÖÎãàÎã§!')">Ïò§Îãµ ÏòµÏÖò 3</button>
                `;
            }
            
            console.log(`‚úÖ ÎÇúÏù¥ÎèÑ ${level} ÏÑ†ÌÉù ÏôÑÎ£å`);
        };

        // showLearningReport Ìï®Ïàò Ï†ïÏùò
        window.showLearningReport = function() {
            alert(`üìä Í∞úÏù∏ ÌïôÏäµ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏

‚úÖ ÌïôÏäµ ÌÜµÍ≥Ñ:
‚Ä¢ Ï¥ù ÌïôÏäµ ÏãúÍ∞Ñ: 45Î∂Ñ
‚Ä¢ Ï†ïÎãµÎ•†: 85%
‚Ä¢ ÌïôÏäµÌïú Îã®Ïñ¥: 127Í∞ú
‚Ä¢ Ï∑®ÏïΩ Î∂ÑÏïº: Í≥†Í∏â Ïñ¥Ìúò

üìà ÏßÑÎèÑ ÌòÑÌô©:
‚Ä¢ ÏòÅÏñ¥: Level 2 (ÏßÑÌñâÏ§ë)
‚Ä¢ ÏàòÌïô: Level 1 (ÏôÑÎ£å)
‚Ä¢ ÏÇ¨Ìöå: Level 1 (ÏãúÏûë Ï†Ñ)
‚Ä¢ ÏÉÅÏãù: Level 3 (ÏôÑÎ£å)

üéØ Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠:
‚Ä¢ Í≥†Í∏â Ïñ¥Ìúò Î∞òÎ≥µ ÌïôÏäµ ÌïÑÏöî
‚Ä¢ ÏàòÌïô Level 2 ÎèÑÏ†Ñ Í∂åÏû•
‚Ä¢ Îß§Ïùº 20Î∂ÑÏî© Íæ∏Ï§ÄÌïú ÌïôÏäµ Ï∂îÏ≤ú`);
            console.log('ÌïôÏäµ Î¶¨Ìè¨Ìä∏ ÌëúÏãú');
        };

        // Í∏∞Î≥∏ Í≤åÏûÑ ÏÉÅÌÉú Í∞ùÏ≤¥ ÏÉùÏÑ±
        if (!window.gameState) {
            window.gameState = {
                score: 0,
                coins: 100,
                level: 1,
                currentQuestion: {},
                animals: {},
                totalAnimals: 0,
                speciesCount: 0,
                currentSubject: 'english',
                subjects: {
                    english: { progress: {}, level: 1, score: 0, currentDifficulty: 1, totalCorrect: 0, totalIncorrect: 0 },
                    social: { progress: {}, level: 1, score: 0, currentDifficulty: 1, totalCorrect: 0, totalIncorrect: 0 },
                    math: { progress: {}, level: 1, score: 0, currentDifficulty: 1, totalCorrect: 0, totalIncorrect: 0 },
                    general: { progress: {}, level: 1, score: 0, currentDifficulty: 1, totalCorrect: 0, totalIncorrect: 0 }
                },
                battle: {
                    playerStats: {
                        totalBattles: 5,
                        wins: 3,
                        points: 150,
                        rank: 'silver'
                    }
                }
            };
        }

        // ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ Í∏∞Î≥∏Í∞í
        if (!window.currentUserProfile) {
            window.currentUserProfile = {
                name: 'ÌîåÎ†àÏù¥Ïñ¥',
                score: 100,
                coins: 100,
                level: 1
            };
        }

        // ÌòÑÏû¨ ÎÇúÏù¥ÎèÑ Í∏∞Î≥∏Í∞í
        window.currentDifficulty = 1;

        // Í≥ºÎ™© Î≥ÄÍ≤Ω Ìï®Ïàò
        window.changeSubject = function() {
            const subjectSelect = document.getElementById('subject-select');
            if (subjectSelect) {
                const selectedSubject = subjectSelect.value;
                window.gameState.currentSubject = selectedSubject;
                console.log('Í≥ºÎ™© Î≥ÄÍ≤Ω:', selectedSubject);
                
                // Í≥ºÎ™©Î≥Ñ Ïù∏ÏÇ¨Îßê
                const messages = {
                    'english': 'üá¨üáß ÏòÅÏñ¥ ÌïôÏäµ Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§!',
                    'social': 'üèõÔ∏è ÏÇ¨Ìöå ÌïôÏäµ Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§!',
                    'math': 'üî¢ ÏàòÌïô ÌïôÏäµ Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§!',
                    'general': 'üß† ÏÉÅÏãù ÌïôÏäµ Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§!'
                };
                
                const questionDiv = document.getElementById('english-question');
                if (questionDiv) {
                    questionDiv.textContent = messages[selectedSubject] || 'Í≥ºÎ™©Ïù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!';
                }
            }
        };

        // Í∏∞Î≥∏ UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÎì§
        window.updateUI = function() {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            const userNameEl = document.getElementById('current-user-name');
            if (userNameEl && window.currentUserProfile) {
                userNameEl.textContent = window.currentUserProfile.name;
            }
            
            console.log('UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        };

        window.updateAnimalCollection = function() {
            const collectionEl = document.getElementById('animal-collection');
            if (collectionEl) {
                // ÏÉòÌîå ÎèôÎ¨ºÎì§ ÌëúÏãú
                collectionEl.innerHTML = `
                    <div class="animal-card" onclick="alert('üê∂ Í∞ïÏïÑÏßÄÍ∞Ä Íº¨Î¶¨Î•º ÌùîÎì§Í≥† ÏûàÏñ¥Ïöî!')">
                        <span class="animal-emoji">üê∂</span>
                        <div class="animal-name">Í∞ïÏïÑÏßÄ</div>
                        <div class="animal-level">Lv. 1</div>
                        <div class="special-name">Î©çÎ©çÏôïÏûê</div>
                        <span class="rarity-badge">ÏùºÎ∞ò</span>
                    </div>
                    <div class="animal-card" onclick="alert('üê± Í≥†ÏñëÏù¥Í∞Ä ÏïºÏòπÌïòÍ≥† ÏûàÏñ¥Ïöî!')">
                        <span class="animal-emoji">üê±</span>
                        <div class="animal-name">Í≥†ÏñëÏù¥</div>
                        <div class="animal-level">Lv. 2</div>
                        <div class="special-name">ÏïºÏòπÍ≥µÏ£º</div>
                        <span class="rarity-badge">ÏùºÎ∞ò</span>
                    </div>
                    <div class="animal-card" onclick="alert('ü¶Å ÏÇ¨ÏûêÍ∞Ä Ìè¨Ìö®ÌïòÍ≥† ÏûàÏñ¥Ïöî!')">
                        <span class="animal-emoji">ü¶Å</span>
                        <div class="animal-name">ÏÇ¨Ïûê</div>
                        <div class="animal-level">Lv. 3</div>
                        <div class="special-name">Ìô©Í∏àÍ∞àÍ∏∞Ïôï</div>
                        <span class="rarity-badge">Ìù¨Í∑Ä</span>
                    </div>
                `;
            }
            console.log('ÎèôÎ¨º Ïª¨Î†âÏÖò ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        };

        // Í∏∞ÌÉÄ ÌïÑÏàò Ìï®ÏàòÎì§
        window.loadCurrentSubjectProgress = function() {
            console.log('Í≥ºÎ™©Î≥Ñ ÏßÑÌñâÎèÑ Î°úÎìú');
        };

        window.updateSubjectUI = function() {
            console.log('Í≥ºÎ™©Î≥Ñ UI ÏóÖÎç∞Ïù¥Ìä∏');
        };

        window.checkDailyLoginReward = function() {
            console.log('ÏùºÏùº Î≥¥ÏÉÅ Ï≤¥ÌÅ¨');
        };

        window.initializeFarm = function() {
            console.log('ÎÜçÏû• Ï¥àÍ∏∞Ìôî');
        };

        // ÏûêÎèô Í≤åÏûÑ ÏãúÏûë
        setTimeout(() => {
            try {
                // Í∏∞Î≥∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                window.showPage('game', document.querySelector('.nav-btn'));
                console.log('‚úÖ Í≤åÏûÑ ÏûêÎèô ÏãúÏûë ÏôÑÎ£å');
                
                // Í∏∞Î≥∏ UI ÏóÖÎç∞Ïù¥Ìä∏
                window.updateUI();
                window.updateAnimalCollection();
                
                console.log('üéâ Î™®Îì† ÏãúÏä§ÌÖúÏù¥ Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
            } catch (error) {
                console.error('Í≤åÏûÑ ÏãúÏûë Ïò§Î•ò:', error);
            }
        }, 1000);
        
        console.log('üéØ Î™®Îì† ÌïµÏã¨ Ìï®ÏàòÎì§Ïù¥ HTMLÏóê ÌÜµÌï© ÏôÑÎ£å!');
        
</body>
</html>
