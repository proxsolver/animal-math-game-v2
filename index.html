<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêæ ÎèôÎ¨º ÏàòÏßë ÌïôÏäµ Í≤åÏûÑ üêæ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #FFB6C1 100%); min-height: 100vh; color: #333; }
        .game-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .header h1 { color: #2C5530; font-size: 2.8rem; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .nav-buttons { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .nav-btn { background: linear-gradient(45deg, #4169E1, #1E90FF); color: white; border: none; padding: 12px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.8rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .nav-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .nav-btn.active { background: linear-gradient(45deg, #32CD32, #228B22); }
        .user-info { margin: 15px 0; }
        .current-user { background: linear-gradient(45deg, #FF69B4, #FFB6C1); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.2); word-break: break-all; }
        .game-stats { display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .stat-item { background: linear-gradient(45deg, #FFD700, #FFA500); padding: 10px 20px; border-radius: 20px; font-weight: bold; color: #8B4513; box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-width: 120px; text-align: center; }
        .page { display: none; }
        .page.active { display: block; }
        .game-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .english-quiz-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; }
        .english-quiz-section h2 { color: #2C5530; margin-bottom: 20px; font-size: 1.8rem; }
        .english-question-container { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .english-question { font-size: 2.5rem; color: #4169E1; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .speak-btn { font-size: 2.5rem; cursor: pointer; transition: transform 0.2s; }
        .speak-btn:hover { transform: scale(1.2); }
        .english-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .english-option-btn { background: linear-gradient(45deg, #89CFF0, #4682B4); color: white; border: none; padding: 20px; border-radius: 15px; font-size: 1.5rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .english-option-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .english-option-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .feedback { margin: 20px 0; padding: 20px; border-radius: 20px; font-weight: bold; text-align: center; font-size: 1.2rem; min-height: 60px; display: flex; align-items: center; justify-content: center; transition: all 0.5s ease; }
        .feedback.correct { background: linear-gradient(45deg, #90EE90, #32CD32); color: #006400; }
        .feedback.incorrect { background: linear-gradient(45deg, #FFB6C1, #FF69B4); color: #8B0000; }
        .collection-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .collection-section h2 { color: #2C5530; margin-bottom: 20px; text-align: center; font-size: 1.8rem; }
        .collection-hint { text-align: center; color: #666; margin-bottom: 20px; font-style: italic; }
        .animal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; max-height: 450px; overflow-y: auto; padding: 5px; }
        .animal-card { background: linear-gradient(45deg, #FFE4E1, #F0E68C); border-radius: 20px; padding: 15px; text-align: center; box-shadow: 0 6px 20px rgba(0,0,0,0.15); transition: all 0.3s ease; cursor: pointer; border: 3px solid transparent; }
        .animal-card:hover { transform: scale(1.08); box-shadow: 0 12px 35px rgba(0,0,0,0.25); }
        .animal-emoji { font-size: 3.5rem; display: block; margin-bottom: 10px; }
        .animal-name { font-weight: bold; color: #2C5530; margin-bottom: 5px; font-size: 1rem; word-break: keep-all; }
        .animal-level { font-weight: bold; font-size: 1.1rem; color: #8A2BE2; margin-bottom: 8px; }
        .special-name { color: #8B4513; font-style: italic; font-size: 0.9rem; margin-bottom: 8px; }
        .rarity-badge { background: linear-gradient(45deg, #FFD700, #FFA500); color: #8B4513; font-size: 0.8rem; font-weight: bold; padding: 4px 10px; border-radius: 12px; display: inline-block; }

        /* ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù Ïä§ÌÉÄÏùº */
        .difficulty-selector { margin-bottom: 20px; text-align: center; }
        .difficulty-selector h3 { color: #2C5530; margin-bottom: 15px; }
        .difficulty-buttons { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .difficulty-btn { background: linear-gradient(45deg, #e0e0e0, #f5f5f5); color: #333; border: 3px solid #ccc; padding: 15px 20px; border-radius: 15px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; min-width: 80px; text-align: center; }
        .difficulty-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .difficulty-btn.active { background: linear-gradient(45deg, #32CD32, #228B22); color: white; border-color: #228B22; }
        .difficulty-btn small { display: block; font-size: 0.8rem; margin-top: 5px; }

        /* Îã®Ïñ¥ Ï∂úÏ≤ò ÌëúÏãú Ïä§ÌÉÄÏùº */
        .word-source { text-align: center; margin: 10px 0; }
        .source-badge { display: inline-block; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; border: 2px solid; }
        .source-badge.json-file { background: linear-gradient(45deg, #2196F3, #64B5F6); color: white; border-color: #2196F3; }
        .source-badge.fallback { background: linear-gradient(45deg, #9E9E9E, #BDBDBD); color: white; border-color: #9E9E9E; }

        /* ÌïôÏäµ ÌÜµÍ≥Ñ Ïä§ÌÉÄÏùº */
        .learning-stats { background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 15px; margin-top: 20px; border: 2px solid #87CEEB; }
        .learning-stats h4 { color: #4169E1; margin-bottom: 10px; text-align: center; }
        .stats-row { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
        .stats-row span { background: #f0f8ff; padding: 8px 12px; border-radius: 10px; font-size: 0.9rem; }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { margin: auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; }
        #math-modal .modal-content { background: linear-gradient(135deg, #e0f7fa, #ffffff, #fffde7); }
        #math-question { font-size: 2.5rem; color: #4169E1; margin: 25px 0; font-weight: bold; }
        #math-answer-input { font-size: 1.8rem; padding: 15px 20px; border: 3px solid #87CEEB; border-radius: 20px; width: 250px; margin: 15px; text-align: center; }
        #math-answer-input:disabled { background-color: #eee; }
        #math-submit-btn { background: linear-gradient(45deg, #32CD32, #228B22); color: white; border: none; padding: 18px 35px; font-size: 1.3rem; border-radius: 20px; cursor: pointer; margin: 15px; font-weight: bold; }
        #math-submit-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        #math-feedback { min-height: 40px; margin-top: 15px; font-weight: bold; font-size: 1.1rem; }

        /* Î°úÍ∑∏Ïù∏ Î™®Îã¨ Ïä§ÌÉÄÏùº */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        #login-modal { background: white; padding: 40px; border-radius: 25px; width: 90%; max-width: 450px; text-align: center; }
        #login-modal h2 { margin-bottom: 20px; color: #2C5530; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; font-size: 1.2rem; border-radius: 15px; border: 2px solid #ccc; }
        .login-btn { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 15px; border: none; color: white; cursor: pointer; margin-top: 10px; font-weight: bold; }
        #login-btn { background: linear-gradient(45deg, #4169E1, #1E90FF); }
        #signup-btn { background: linear-gradient(45deg, #32CD32, #228B22); }
        #login-feedback { margin-top: 15px; color: red; font-weight: bold; min-height: 20px; }

        /* Î™ÖÏòàÏùò Ï†ÑÎãπ Ïä§ÌÉÄÏùº */
        #hall-of-fame { border-top: 2px dashed #ccc; margin-top: 25px; padding-top: 20px; }
        #hall-of-fame h3 { color: #8B4513; margin-bottom: 15px; }
        .fame-entry { margin-bottom: 10px; font-size: 1.1rem; }
        .fame-entry .trophy { margin-right: 8px; }
        .fame-entry .player-name { font-weight: bold; color: #4169E1; }

        /* ÌäπÏàò Ìö®Í≥º */
        .new-animal-alert { z-index: 1000; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(45deg, #FFD700, #FFA500); padding: 35px; border-radius: 25px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: popIn 0.6s ease; }
        .new-animal-alert .new-animal-emoji { font-size: 6rem; display: block; margin-bottom: 20px; }
        .new-animal-alert h3 { color: #8B4513; margin-bottom: 15px; font-size: 1.5rem; }
        .new-animal-alert p { color: #8B4513; font-weight: bold; margin-bottom: 10px; }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .game-container { padding: 15px; }
            .header h1 { font-size: 2.2rem; }
            .game-content { grid-template-columns: 1fr; }
            .game-stats { flex-direction: column; align-items: center; gap: 10px; }
            .nav-buttons { flex-direction: column; align-items: center; gap: 10px; }
            .english-question { font-size: 2rem; }
            .english-option-btn { font-size: 1.2rem; padding: 15px; }
            .animal-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        }
    </style>
</head>
<body>
    <!-- Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
    <div id="login-overlay">
        <div id="login-modal">
            <h2>üêæ ÎèôÎ¨º ÏàòÏßë ÌïôÏäµ Í≤åÏûÑ üêæ</h2>
            <input type="text" id="player-name-input" class="login-input" placeholder="ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ">
            <input type="password" id="player-pin-input" class="login-input" placeholder="4ÏûêÎ¶¨ Ïà´Ïûê PIN" maxlength="4" pattern="\d*">
            <button id="login-btn" class="login-btn">Î°úÍ∑∏Ïù∏</button>
            <button id="signup-btn" class="login-btn">ÏÉà ÌîåÎ†àÏù¥Ïñ¥ ÎßåÎì§Í∏∞</button>
            <p id="login-feedback"></p>
            <!-- Î™ÖÏòàÏùò Ï†ÑÎãπ -->
            <div id="hall-of-fame">
                <h3>üèÜ Î™ÖÏòàÏùò Ï†ÑÎãπ üèÜ</h3>
                <div id="fame-species" class="fame-entry">
                    <span class="trophy">ü•á</span> ÏµúÎã§ ÏàòÏßëÍ∞Ä: <span class="player-name">Í≥ÑÏÇ∞ Ï§ë...</span>
                </div>
                <div id="fame-level" class="fame-entry">
                    <span class="trophy">ü•á</span> ÏµúÍ≥† Î†àÎ≤® ÎèôÎ¨º: <span class="player-name">Í≥ÑÏÇ∞ Ï§ë...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="game-container" style="display: none;">
        <!-- Ìó§Îçî -->
        <div class="header">
            <h1>üêæ ÎèôÎ¨º ÏàòÏßë ÌïôÏäµ Í≤åÏûÑ üêæ</h1>
            
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage('game', this)">ÎèôÎ¨º Ïû°Í∏∞ üá¨üáß</button>
                <button class="nav-btn" onclick="showPage('encyclopedia', this)">ÎèôÎ¨º ÎèÑÍ∞ê üìö</button>
                <button class="nav-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ üö™</button>
            </div>

            <div class="user-info" id="user-info">
                <div class="current-user">ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥: <span id="current-user-name"></span></div>
            </div>

            <div class="game-stats" id="game-stats">
                <div class="stat-item">Î†àÎ≤® <span id="level">1</span></div>
                <div class="stat-item">Ï†êÏàò: <span id="score">0</span></div>
                <div class="stat-item">ÎèôÎ¨º Ï¢ÖÎ•ò: <span id="species-count">0</span>Ï¢Ö</div>
                <div class="stat-item">Ï¥ù ÎèôÎ¨º: <span id="total-animals">0</span>ÎßàÎ¶¨</div>
            </div>
        </div>

        <!-- Í≤åÏûÑ ÌéòÏù¥ÏßÄ -->
        <div id="game-page" class="page active">
            <div class="game-content">
                <div class="english-quiz-section">
                    <h2>üá¨üáß ÏòÅÏñ¥ ÌÄ¥Ï¶à: ÎèôÎ¨º Ïû°Í∏∞!</h2>
                    
                    <!-- ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù -->
                    <div class="difficulty-selector">
                        <h3>ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù:</h3>
                        <div class="difficulty-buttons">
                            <button class="difficulty-btn active" data-level="1" onclick="selectDifficulty(1)">
                                Ï¥àÍ∏â üìù<br><small>+10Ï†ê</small>
                            </button>
                            <button class="difficulty-btn" data-level="2" onclick="selectDifficulty(2)">
                                Ï§ëÍ∏â üìö<br><small>+20Ï†ê</small>
                            </button>
                            <button class="difficulty-btn" data-level="3" onclick="selectDifficulty(3)">
                                Í≥†Í∏â üéì<br><small>+30Ï†ê</small>
                            </button>
                        </div>
                    </div>

                    <div class="english-question-container">
                        <div class="english-question" id="english-question">ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌïòÍ≥† ÏãúÏûëÌïòÏÑ∏Ïöî!</div>
                        <span id="speak-button" class="speak-btn" title="Îã®Ïñ¥ Î∞úÏùå Îì£Í∏∞" style="display: none;">üîä</span>
                    </div>
                    
                    <!-- Îã®Ïñ¥ Ï∂úÏ≤ò ÌëúÏãú -->
                    <div class="word-source" id="word-source" style="display: none;">
                        <span class="source-badge json-file" id="source-badge">üìÅ JSON ÌååÏùº</span>
                    </div>
                    
                    <div class="english-options" id="english-options"></div>
                    <div class="feedback" id="feedback"></div>
                    
                    <!-- ÌïôÏäµ ÌÜµÍ≥Ñ -->
                    <div class="learning-stats" id="learning-stats" style="display: none;">
                        <h4>üìä ÌòÑÏû¨ Îã®Ïñ¥ ÌÜµÍ≥Ñ</h4>
                        <div class="stats-row">
                            <span>Ï†ïÎãµ: <strong id="word-correct">0</strong>Ìöå</span>
                            <span>Ïò§Îãµ: <strong id="word-incorrect">0</strong>Ìöå</span>
                            <span>Ï†ïÎãµÎ•†: <strong id="word-accuracy">0</strong>%</span>
                        </div>
                    </div>
                </div>

                <div class="collection-section">
                    <h2>üêæ ÎÇ¥ ÎèôÎ¨º Ïª¨Î†âÏÖò</h2>
                    <p class="collection-hint">üí° ÎèôÎ¨ºÏùÑ ÌÅ¥Î¶≠Ìï¥ÏÑú ÏàòÌïô Î¨∏Ï†úÎ°ú Î†àÎ≤®ÏóÖ ÏãúÏºúÏöî!</p>
                    <div class="animal-grid" id="animal-collection"></div>
                </div>
            </div>
        </div>
        
        <!-- ÎèôÎ¨º ÎèÑÍ∞ê ÌéòÏù¥ÏßÄ -->
        <div id="encyclopedia-page" class="page">
            <div class="encyclopedia-container">
                <h2>üìö ÎèôÎ¨º ÎèÑÍ∞ê</h2>
                <div class="encyclopedia-progress">
                    ÏàòÏßëÎ•†: <span id="collection-progress">0 / 105</span> Ï¢Ö
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar-fill"></div>
                    </div>
                </div>
                <div class="encyclopedia-grid" id="encyclopedia-grid"></div>
            </div>
        </div>
    </div>
    
    <!-- ÏàòÌïô Î¨∏Ï†ú Î™®Îã¨ -->
    <div id="math-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMathModal()">&times;</span>
            <h3>üßÆ ÎèôÎ¨º Î†àÎ≤®ÏóÖ!</h3>
            <div id="math-question">5 + 3 = ?</div>
            <input type="number" id="math-answer-input" placeholder="Ï†ïÎãµÏùÄ?">
            <br>
            <button id="math-submit-btn">ÌôïÏù∏</button>
            <div id="math-feedback"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let auth, db;
        
        // Firebase Ï§ÄÎπÑ Ìï®ÏàòÎ•º Î®ºÏ†Ä Ï†ïÏùò
        window.onFirebaseReady = async function(user) {
            console.log("onFirebaseReady Ìò∏Ï∂úÎê®, user:", user);
            
            if (!user) {
                console.log("ÏÇ¨Ïö©Ïûê ÏóÜÏùå, Ïò§ÌîÑÎùºÏù∏ Î™®Îìú");
                const feedbackEl = document.getElementById('login-feedback');
                if (feedbackEl) {
                    feedbackEl.textContent = "ÌÅ¥ÎùºÏö∞Îìú Ïó∞Í≤∞ Ïã§Ìå®! Ïò§ÌîÑÎùºÏù∏ Î™®ÎìúÎ°ú Ïã§ÌñâÌï©ÎãàÎã§.";
                }
                return;
            }
            
            window.currentUserId = user.uid;
            console.log("ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê ID ÏÑ§Ï†ï:", window.currentUserId);
            
            try {
                console.log("ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏãúÏûë...");
                await window.loadAnimalsFromJSON();
                console.log("Î™ÖÏòàÏùò Ï†ÑÎãπ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...");
                await window.updateHallOfFame();
                console.log("Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
            } catch (error) {
                console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
            }
            
            console.log("Î°úÍ∑∏Ïù∏ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú");
            const overlayEl = document.getElementById('login-overlay');
            if (overlayEl) {
                overlayEl.style.display = 'flex';
            }
        }
        
        // Firebase Ï¥àÍ∏∞Ìôî
        try {
            const firebaseConfig = {
              apiKey: "AIzaSyC2JV9KsIZ-M1crdnnxLfxyaRtGS1Brtcc",
              authDomain: "animal-math-game-6eec2.firebaseapp.com",
              projectId: "animal-math-game-6eec2",
              storageBucket: "animal-math-game-6eec2.firebasestorage.app",
              messagingSenderId: "104144283045",
              appId: "1:104144283045:web:f0a387d83292a0d508744c",
              measurementId: "G-M63W08193X"
            };
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            console.log("Firebase Ï¥àÍ∏∞Ìôî ÏÑ±Í≥µ");

            window.firebase = { auth, db, doc, getDoc, setDoc, collection, getDocs };

            onAuthStateChanged(auth, async (user) => {
                console.log("Auth ÏÉÅÌÉú Î≥ÄÍ≤Ω:", user ? "Î°úÍ∑∏Ïù∏Îê®" : "Î°úÍ∑∏ÏïÑÏõÉÎê®");
                if (user) {
                    console.log("Firebase Auth User:", user.uid);
                    window.onFirebaseReady(user);
                } else {
                     try {
                        console.log("ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ ÏãúÎèÑ...");
                        const result = await signInAnonymously(auth);
                        console.log("ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:", result.user.uid);
                    } catch (error) {
                        console.error("ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ Ïã§Ìå®:", error);
                        alert("Firebase Ïù∏Ï¶ù Ïã§Ìå®: " + error.message);
                        window.onFirebaseReady(null);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", error);
            alert("Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®: " + error.message);
            window.onFirebaseReady(null);
        }
    </script>
    
    <script>
        // ==================== Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ ====================
        
        let gameState = {
            score: 0,
            level: 1,
            currentQuestion: {},
            animals: {},
            totalAnimals: 0,
            speciesCount: 0
        };

        let currentUserId = null;
        let currentUserProfile = {};
        let currentEnglishQuiz = {};
        let currentDifficulty = 1;
        let currentWordData = null;
        let isLoadingWord = false;
        let userProgress = {};

        // ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•Ìï† Ï†ÑÏó≠ Î≥ÄÏàò
        let animalTypes = [];

        // ==================== ÎèôÎ¨º Î∞è Îã®Ïñ¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ====================
        
        window.loadAnimalsFromJSON = async function() {
            try {
                console.log('ÎèôÎ¨º JSON ÌååÏùº Î°úÎî© ÏãúÏûë...');
                const response = await fetch('./animals.json');
                
                if (!response.ok) {
                    throw new Error(`ÎèôÎ¨º JSON ÌååÏùº Î°úÎìú Ïã§Ìå®: ${response.status}`);
                }
                
                const data = await response.json();
                animalTypes = data.animals;
                console.log(`ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å: ${animalTypes.length}ÎßàÎ¶¨`);
                return true;
                
            } catch (error) {
                console.error('ÎèôÎ¨º JSON Î°úÎìú Ïã§Ìå®, Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©:', error);
                animalTypes = [
                    {emoji: 'üê∂', name: 'Í∞ïÏïÑÏßÄ', specialName: 'Î©çÎ©çÏôïÏûê', rarity: 1},
                    {emoji: 'üê±', name: 'Í≥†ÏñëÏù¥', specialName: 'ÏïºÏòπÍ≥µÏ£º', rarity: 1},
                    {emoji: 'üê∞', name: 'ÌÜ†ÎÅº', specialName: 'Íπ°Ï¥ùÎåÄÏû•', rarity: 1},
                    {emoji: 'ü¶Å', name: 'ÏÇ¨Ïûê', specialName: 'Ìô©Í∏àÍ∞àÍ∏∞Ïôï', rarity: 4},
                    {emoji: 'ü¶Ñ', name: 'Ïú†ÎãàÏΩò', specialName: 'ÏàúÏàòÏùò Îøî', rarity: 5}
                ];
                return false;
            }
        }

        async function loadWordForDifficulty(difficulty) {
            try {
                console.log(`Î†àÎ≤® ${difficulty} Îã®Ïñ¥ JSON ÌååÏùº Î°úÎî© ÏãúÏûë...`);
                const response = await fetch(`./words/level${difficulty}.json`);
                
                if (!response.ok) {
                    throw new Error(`JSON ÌååÏùº Î°úÎìú Ïã§Ìå®: ${response.status}`);
                }
                
                const data = await response.json();
                const words = data.words;
                
                if (!words || words.length === 0) {
                    throw new Error('JSON ÌååÏùºÏóê Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§');
                }
                
                const randomWord = words[Math.floor(Math.random() * words.length)];
                
                currentWordData = {
                    id: `json_${difficulty}_${Date.now()}`,
                    korean: randomWord.korean,
                    english: randomWord.english,
                    options: randomWord.options,
                    difficulty: difficulty,
                    source: 'json'
                };
                
                currentEnglishQuiz = {
                    answer: currentWordData.english,
                    wordId: currentWordData.id
                };
                
                console.log('JSONÏóêÏÑú Îã®Ïñ¥ Î°úÎìú ÏÑ±Í≥µ:', currentWordData);
                
            } catch (error) {
                console.error('JSON Îã®Ïñ¥ Î°úÎìú Ïã§Ìå®, Ìè¥Î∞± ÏÇ¨Ïö©:', error);
                
                // Ìè¥Î∞±: Í∏∞Ï°¥ ÌïòÎìúÏΩîÎî©Îêú Îã®Ïñ¥ ÏÇ¨Ïö©
                const fallbackWords = [
                    { question: 'ÏÇ¨Í≥º', answer: 'apple', options: ['apple', 'banana', 'orange', 'grape'] },
                    { question: 'Í≥†ÏñëÏù¥', answer: 'cat', options: ['cat', 'dog', 'bird', 'fish'] },
                    { question: 'Ï±Ö', answer: 'book', options: ['book', 'pen', 'paper', 'desk'] },
                    { question: 'Ïßë', answer: 'house', options: ['house', 'school', 'park', 'store'] },
                    { question: 'Î¨º', answer: 'water', options: ['water', 'juice', 'milk', 'tea'] }
                ];
                
                const fallbackQuiz = fallbackWords[Math.floor(Math.random() * fallbackWords.length)];
                
                currentWordData = {
                    id: 'fallback_' + Date.now(),
                    korean: fallbackQuiz.question,
                    english: fallbackQuiz.answer,
                    options: fallbackQuiz.options,
                    difficulty: difficulty,
                    source: 'fallback'
                };
                
                currentEnglishQuiz = {
                    answer: currentWordData.english,
                    wordId: currentWordData.id
                };
                
                console.log('Ìè¥Î∞± Îã®Ïñ¥ ÏÇ¨Ïö©:', currentWordData);
            }
        }

        // ==================== Í≤åÏûÑ ÌïµÏã¨ Ìï®Ïàò ====================
        
        window.selectDifficulty = function(level) {
            currentDifficulty = level;
            
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const selectedBtn = document.querySelector(`[data-level="${level}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            
            generateEnglishQuiz();
        }

        async function generateEnglishQuiz() {
            if (isLoadingWord) return;
            
            isLoadingWord = true;
            
            const questionElement = document.getElementById('english-question');
            const optionsContainer = document.getElementById('english-options');
            const speakButton = document.getElementById('speak-button');
            const feedbackElement = document.getElementById('feedback');
            
            questionElement.textContent = 'Îã®Ïñ¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...';
            optionsContainer.innerHTML = '';
            speakButton.style.display = 'none';
            feedbackElement.textContent = '';
            feedbackElement.className = 'feedback';
            
            try {
                await loadWordForDifficulty(currentDifficulty);
                console.log('Îã®Ïñ¥ Î°úÎìú ÏôÑÎ£å:', currentWordData);
                displayCurrentWord();
                updateWordStats();
                
            } catch (error) {
                console.error('Error generating quiz:', error);
                questionElement.textContent = 'Îã®Ïñ¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
            } finally {
                isLoadingWord = false;
            }
        }

        function displayCurrentWord() {
            if (!currentWordData) return;
            
            const questionElement = document.getElementById('english-question');
            const optionsContainer = document.getElementById('english-options');
            const speakButton = document.getElementById('speak-button');
            const wordSourceElement = document.getElementById('word-source');
            const sourceBadge = document.getElementById('source-badge');
            
            questionElement.textContent = `"${currentWordData.korean}"`;
            speakButton.style.display = 'inline';
            speakButton.onclick = () => speakWord(currentEnglishQuiz.answer);
            
            // Îã®Ïñ¥ Ï∂úÏ≤ò ÌëúÏãú
            wordSourceElement.style.display = 'block';
            
            if (currentWordData.source === 'json') {
                sourceBadge.className = 'source-badge json-file';
                sourceBadge.innerHTML = 'üìÅ JSON ÌååÏùº';
            } else {
                sourceBadge.className = 'source-badge fallback';
                sourceBadge.innerHTML = 'üîÑ ÎåÄÏ≤¥ Îã®Ïñ¥';
            }
            
            // ÏòµÏÖò ÏÉùÏÑ±
            const finalOptions = [...currentWordData.options].sort(() => Math.random() - 0.5);
            
            optionsContainer.innerHTML = '';
            finalOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'english-option-btn';
                button.innerText = option;
                button.onclick = () => checkEnglishQuizAnswer(option);
                optionsContainer.appendChild(button);
            });
        }

        function updateWordStats() {
            if (!currentWordData || !currentWordData.id) return;
            
            const progress = userProgress[currentWordData.id] || { correct: 0, incorrect: 0 };
            const total = progress.correct + progress.incorrect;
            const accuracy = total > 0 ? Math.round((progress.correct / total) * 100) : 0;
            
            document.getElementById('word-correct').textContent = progress.correct;
            document.getElementById('word-incorrect').textContent = progress.incorrect;
            document.getElementById('word-accuracy').textContent = accuracy;
            document.getElementById('learning-stats').style.display = 'block';
        }

        function speakWord(word) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                const voices = window.speechSynthesis.getVoices();
                let englishVoice = voices.find(voice => voice.lang.startsWith('en-US')) || voices.find(voice => voice.lang.startsWith('en'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                utterance.pitch = 1;
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        async function checkEnglishQuizAnswer(selectedOption) {
            const optionsContainer = document.getElementById('english-options');
            optionsContainer.querySelectorAll('.english-option-btn').forEach(btn => {
                btn.disabled = true;
            });

            const feedback = document.getElementById('feedback');
            const isCorrect = selectedOption === currentEnglishQuiz.answer;
            
            // ÌïôÏäµ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            if (currentWordData && currentWordData.id) {
                if (!userProgress[currentWordData.id]) {
                    userProgress[currentWordData.id] = { correct: 0, incorrect: 0, lastSeen: new Date() };
                }
                
                if (isCorrect) {
                    userProgress[currentWordData.id].correct++;
                } else {
                    userProgress[currentWordData.id].incorrect++;
                }
                userProgress[currentWordData.id].lastSeen = new Date();
            }
            
            if (isCorrect) {
                speakWord(currentEnglishQuiz.answer);
                
                // ÎÇúÏù¥ÎèÑÎ≥Ñ Ï†êÏàò Í≥ÑÏÇ∞
                let baseScore = 10;
                if (currentDifficulty === 2) baseScore = 20;
                else if (currentDifficulty === 3) baseScore = 30;
                
                const earnedScore = baseScore * gameState.level;
                gameState.score += earnedScore;
                
                feedback.textContent = `Ï†ïÎãµ! +${earnedScore}Ï†ê! ÎèôÎ¨ºÏùÑ Ïû°ÏïòÏñ¥Ïöî! üéâ`;
                feedback.className = 'feedback correct';
                
                const newAnimal = getRandomAnimal();
                addAnimal(newAnimal);
                
                if (gameState.score >= gameState.level * 5000) {
                    gameState.level++;
                    showLevelUp();
                }
                
                saveCurrentUserData();
                setTimeout(() => generateEnglishQuiz(), 1500);
            } else {
                feedback.textContent = `ÏïÑ! Ï†ïÎãµÏùÄ "${currentEnglishQuiz.answer}"ÏòÄÏñ¥Ïöî. Îã§Ïãú ÎèÑÏ†ÑÌïòÏÑ∏Ïöî!`;
                feedback.className = 'feedback incorrect';
                setTimeout(() => generateEnglishQuiz(), 2500);
            }
            
            updateUI();
            updateWordStats();
        }

        function getRandomAnimal() {
            const maxRarity = Math.min(Math.floor(gameState.level / 2) + 1, 6);
            const availableAnimals = animalTypes.filter(animal => animal.rarity <= maxRarity);
            const weights = availableAnimals.map(animal => Math.pow(0.7, animal.rarity - 1));
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            for (let i = 0; i < availableAnimals.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return availableAnimals[i];
                }
            }
            return availableAnimals[0];
        }

        function addAnimal(animal) {
            const key = animal.name;
            if (!gameState.animals[key]) {
                gameState.animals[key] = {
                    ...animal,
                    count: 0,
                    animalLevel: 1
                };
                gameState.speciesCount++;
                showNewAnimalAlert(animal);
            }
            
            gameState.animals[key].count++;
            gameState.totalAnimals++;
            
            updateAnimalCollection();
        }

        // ==================== ÏàòÌïô Î¨∏Ï†ú (Î†àÎ≤®ÏóÖ) ====================
        
        function generateMathProblemForLevelUp(animalLevel) {
            const difficulty = Math.min(Math.floor(animalLevel / 5) + 1, 4);
            let question = {};
            
            switch(difficulty) {
                case 1:
                    const a1 = Math.floor(Math.random() * 10) + 1;
                    const b1 = Math.floor(Math.random() * 10) + 1;
                    if (Math.random() > 0.5) { question = {text: `${a1} + ${b1}`, answer: a1 + b1}; } 
                    else { const l = Math.max(a1, b1), s = Math.min(a1, b1); question = {text: `${l} - ${s}`, answer: l - s}; }
                    break;
                case 2:
                    const a2 = Math.floor(Math.random() * 90) + 10;
                    const b2 = Math.floor(Math.random() * 90) + 10;
                    if (Math.random() > 0.5) { question = {text: `${a2} + ${b2}`, answer: a2 + b2}; }
                    else { const l = Math.max(a2, b2), s = Math.min(a2, b2); question = {text: `${l} - ${s}`, answer: l - s}; }
                    break;
                case 3:
                    const a3 = Math.floor(Math.random() * 8) + 2;
                    const b3 = Math.floor(Math.random() * 8) + 2;
                    question = {text: `${a3} √ó ${b3}`, answer: a3 * b3};
                    break;
                case 4:
                    const a4 = Math.floor(Math.random() * 900) + 100;
                    const b4 = Math.floor(Math.random() * 900) + 100;
                    if (Math.random() > 0.5) { question = {text: `${a4} + ${b4}`, answer: a4 + b4}; }
                    else { const l = Math.max(a4, b4), s = Math.min(a4, b4); question = {text: `${l} - ${s}`, answer: l - s}; }
                    break;
            }
            gameState.currentQuestion = question;
            document.getElementById('math-question').textContent = `${question.text} = ?`;
        }

        function startMathProblem(animalName) {
            const animal = gameState.animals[animalName];
            generateMathProblemForLevelUp(animal.animalLevel);
            
            const answerInput = document.getElementById('math-answer-input');
            const submitBtn = document.getElementById('math-submit-btn');
            
            answerInput.value = '';
            document.getElementById('math-feedback').textContent = '';
            
            answerInput.disabled = false;
            submitBtn.disabled = false;

            submitBtn.onclick = () => checkMathAnswer(animalName);
            document.getElementById('math-modal').style.display = 'flex';
            answerInput.focus();
        }

        function checkMathAnswer(animalName) {
            const answerInput = document.getElementById('math-answer-input');
            const submitBtn = document.getElementById('math-submit-btn');
            const userAnswer = parseInt(answerInput.value);
            const feedback = document.getElementById('math-feedback');
            
            if (isNaN(userAnswer)) {
                feedback.textContent = 'Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!';
                feedback.style.color = 'red';
                return;
            }
            
            answerInput.disabled = true;
            submitBtn.disabled = true;

            if (userAnswer === gameState.currentQuestion.answer) {
                const animal = gameState.animals[animalName];
                gameState.score += 15 * animal.animalLevel;
                animal.animalLevel++;
                
                feedback.textContent = `Ï†ïÎãµ! ${animal.name}Ïùò Î†àÎ≤®Ïù¥ ${animal.animalLevel}Ïù¥ ÎêòÏóàÏñ¥Ïöî!`;
                feedback.style.color = 'green';

                updateUI();
                updateAnimalCollection();
                saveCurrentUserData();
                setTimeout(closeMathModal, 1500);
            } else {
                feedback.textContent = `Îï°! Îã§Ïãú ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî.`;
                feedback.style.color = 'red';
                setTimeout(() => {
                    answerInput.disabled = false;
                    submitBtn.disabled = false;
                    answerInput.focus();
                }, 1000);
            }
        }

        function closeMathModal() {
            document.getElementById('math-modal').style.display = 'none';
        }

        // ==================== UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò ====================

        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('species-count').textContent = gameState.speciesCount;
            document.getElementById('total-animals').textContent = gameState.totalAnimals;
        }

        function updateAnimalCollection() {
            const collection = document.getElementById('animal-collection');
            if (!collection) return;
            collection.innerHTML = '';
            
            const sortedAnimals = Object.values(gameState.animals).sort((a, b) => b.rarity - a.rarity);
            
            sortedAnimals.forEach(animal => {
                if (animal.count === 0) return;

                const card = document.createElement('div');
                card.className = 'animal-card';
                
                let borderColor = '#87CEEB';
                if (animal.rarity >= 5) borderColor = '#FFD700';
                else if (animal.rarity >= 4) borderColor = '#9370DB';
                else if (animal.rarity >= 3) borderColor = '#32CD32';
                
                card.style.borderColor = borderColor;
                card.style.boxShadow = `0 6px 20px ${borderColor}40`;
                
                card.innerHTML = `
                    <span class="animal-emoji">${animal.emoji}</span>
                    <div class="animal-name">${animal.name} (${animal.count}ÎßàÎ¶¨)</div>
                    <div class="animal-level">Lv. ${animal.animalLevel || 1}</div>
                    <div class="special-name">"${animal.specialName}"</div>
                    <div class="rarity-badge">‚òÖ${animal.rarity}</div>
                `;
                
                card.onclick = () => startMathProblem(animal.name);
                collection.appendChild(card);
            });
        }
        
        function updateEncyclopedia() {
            const grid = document.getElementById('encyclopedia-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const collectedCount = gameState.speciesCount;
            const totalCount = animalTypes.length;
            document.getElementById('collection-progress').textContent = `${collectedCount} / ${totalCount}`;
            
            const progressPercent = totalCount > 0 ? (collectedCount / totalCount) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;

            animalTypes.forEach(animal => {
                const collectedAnimal = gameState.animals[animal.name];
                const card = document.createElement('div');
                card.className = 'encyclopedia-card';
                
                if (collectedAnimal && collectedAnimal.count > 0) {
                    card.innerHTML = `
                        <span class="animal-emoji">${animal.emoji}</span>
                        <div class="animal-name">${animal.name}</div>
                        <div class="animal-count">${collectedAnimal.count}ÎßàÎ¶¨ Î≥¥Ïú†</div>
                        <div class="rarity-badge">‚òÖ${animal.rarity}</div>
                    `;
                } else {
                    card.classList.add('uncollected');
                    card.innerHTML = `
                        <span class="animal-emoji">‚ùì</span>
                        <div class="animal-name">???</div>
                        <div class="animal-count">ÎØ∏Î∞úÍ≤¨</div>
                        <div class="rarity-badge">‚òÖ${animal.rarity}</div>
                    `;
                }
                grid.appendChild(card);
            });
        }

        // ==================== ÌäπÏàò Ìö®Í≥º Ìï®Ïàò ====================
        
        function showNewAnimalAlert(animal) {
            const alert = document.createElement('div');
            alert.className = 'new-animal-alert';
            alert.innerHTML = `
                <span class="new-animal-emoji">${animal.emoji}</span>
                <h3>ÏÉàÎ°úÏö¥ ÎèôÎ¨º Î∞úÍ≤¨! üéâ</h3>
                <p><strong>${animal.specialName}</strong> (${animal.name})ÏùÑ(Î•º) ÌöçÎìùÌñàÏäµÎãàÎã§!</p>
            `;
            document.body.appendChild(alert);
            setTimeout(() => { alert.remove(); }, 3000);
        }

        function showLevelUp() {
            const alert = document.createElement('div');
            alert.className = 'new-animal-alert';
            alert.innerHTML = `
                <span class="new-animal-emoji">‚≠ê</span>
                <h3>Î†àÎ≤® ÏóÖ! üéâ</h3>
                <p>Î†àÎ≤® ${gameState.level}Ïù¥ ÎêòÏóàÏäµÎãàÎã§!</p>
                <p>Îçî Ìù¨Í∑ÄÌïú ÎèôÎ¨ºÏùÑ ÎßåÎÇ† Ïàò ÏûàÏñ¥Ïöî!</p>
            `;
            document.body.appendChild(alert);
            setTimeout(() => { alert.remove(); }, 3000);
        }

        // ==================== ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Î∞è Îç∞Ïù¥ÌÑ∞ Ìï®Ïàò ====================

        async function saveCurrentUserData() {
            if (!currentUserProfile.name || !window.firebase) return;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/profiles", currentUserProfile.name);
            
            const dataToSave = {
                ...currentUserProfile,
                score: gameState.score,
                level: gameState.level,
                animals: gameState.animals,
                totalAnimals: gameState.totalAnimals,
                speciesCount: gameState.speciesCount,
                lastPlayed: new Date().toISOString()
            };

            try {
                await window.firebase.setDoc(userDocRef, dataToSave, { merge: true });
                console.log("Data saved for", currentUserProfile.name);
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }

        async function loadUserData(userName) {
            if (!window.firebase) return null;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/profiles", userName);
            const docSnap = await window.firebase.getDoc(userDocRef);

            if (docSnap.exists()) {
                return docSnap.data();
            } else {
                return null;
            }
        }

        async function hashPin(pin, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function handleSignup() {
            const nameInput = document.getElementById('player-name-input');
            const pinInput = document.getElementById('player-pin-input');
            const feedback = document.getElementById('login-feedback');
            const name = nameInput.value.trim();
            const pin = pinInput.value;

            if (!name || !pin) {
                feedback.textContent = "Ïù¥Î¶ÑÍ≥º PINÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
                return;
            }
            if (!/^\d{4}$/.test(pin)) {
                feedback.textContent = "PINÏùÄ 4ÏûêÎ¶¨ Ïà´ÏûêÏó¨Ïïº Ìï©ÎãàÎã§.";
                return;
            }

            feedback.textContent = "ÌôïÏù∏ Ï§ë...";
            const existingProfile = await loadUserData(name);
            if (existingProfile) {
                feedback.textContent = "Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ Ïù¥Î¶ÑÏûÖÎãàÎã§.";
                return;
            }

            const hashedPin = await hashPin(pin, name);
            const newProfile = {
                name: name,
                pinHash: hashedPin,
                score: 0,
                level: 1,
                animals: {},
                totalAnimals: 0,
                speciesCount: 0,
                createdAt: new Date().toISOString(),
                lastPlayed: new Date().toISOString()
            };

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = window.firebase.doc(window.firebase.db, "artifacts", appId, "public/data/profiles", newProfile.name);
            await window.firebase.setDoc(userDocRef, newProfile);

            alert(`üéâ ${name} ÌîåÎ†àÏù¥Ïñ¥ ÏÉùÏÑ± ÏôÑÎ£å!`);
            await startGameWithProfile(newProfile);
        }

        async function handleLogin() {
            const nameInput = document.getElementById('player-name-input');
            const pinInput = document.getElementById('player-pin-input');
            const feedback = document.getElementById('login-feedback');
            const name = nameInput.value.trim();
            const pin = pinInput.value;

            if (!name || !pin) {
                feedback.textContent = "Ïù¥Î¶ÑÍ≥º PINÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
                return;
            }

            feedback.textContent = "Î°úÍ∑∏Ïù∏ Ï§ë...";
            const profileData = await loadUserData(name);

            if (!profileData) {
                feedback.textContent = "Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÌîåÎ†àÏù¥Ïñ¥ÏûÖÎãàÎã§.";
                return;
            }

            const hashedPin = await hashPin(pin, name);
            if (hashedPin === profileData.pinHash) {
                await startGameWithProfile(profileData);
            } else {
                feedback.textContent = "PINÏù¥ ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.";
            }
        }

        async function startGameWithProfile(profileData) {
            currentUserProfile = profileData;
            gameState = {
                score: profileData.score || 0,
                level: profileData.level || 1,
                animals: profileData.animals || {},
                totalAnimals: profileData.totalAnimals || 0,
                speciesCount: profileData.speciesCount || 0,
                currentQuestion: {}
            };

            document.getElementById('login-overlay').style.display = 'none';
            document.querySelector('.game-container').style.display = 'block';
            document.getElementById('current-user-name').textContent = currentUserProfile.name;
            
            if (animalTypes.length === 0) {
                await window.loadAnimalsFromJSON();
            }
            
            updateUI();
            updateAnimalCollection();
            selectDifficulty(1);
            showPage('game', document.querySelector('.nav-btn'));
        }

        window.logout = function() {
            saveCurrentUserData();
            currentUserProfile = {};
            gameState = {};
            document.getElementById('login-overlay').style.display = 'flex';
            document.querySelector('.game-container').style.display = 'none';
            document.getElementById('player-name-input').value = '';
            document.getElementById('player-pin-input').value = '';
            document.getElementById('login-feedback').textContent = '';
            window.updateHallOfFame();
        }

        async function getAllProfiles() {
            if (!window.firebase) return [];
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const profilesColRef = window.firebase.collection(window.firebase.db, "artifacts", appId, "public/data/profiles");
            const querySnapshot = await window.firebase.getDocs(profilesColRef);
            const profiles = [];
            querySnapshot.forEach((doc) => {
                profiles.push(doc.data());
            });
            return profiles;
        }

        window.updateHallOfFame = async function() {
            try {
                const profiles = await getAllProfiles();
                if (profiles.length === 0) {
                     document.querySelector('#fame-species .player-name').textContent = `ÏïÑÏßÅ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.`;
                     document.querySelector('#fame-level .player-name').textContent = `ÏÉàÎ°úÏö¥ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÎêòÏñ¥Î≥¥ÏÑ∏Ïöî!`;
                    return;
                }

                let mostSpecies = { name: '-', count: -1 };
                let highestLevel = { name: '-', animal: '-', level: 0 };

                profiles.forEach(p => {
                    if ((p.speciesCount || 0) > mostSpecies.count) {
                        mostSpecies = { name: p.name, count: p.speciesCount };
                    }
                    if (p.animals) {
                        Object.values(p.animals).forEach(a => {
                            if ((a.animalLevel || 1) > highestLevel.level) {
                                highestLevel = { name: p.name, animal: a.name, level: a.animalLevel };
                            }
                        });
                    }
                });

                document.querySelector('#fame-species .player-name').textContent = `${mostSpecies.name} (${mostSpecies.count}Ï¢Ö)`;
                document.querySelector('#fame-level .player-name').textContent = `${highestLevel.name} (Lv.${highestLevel.level} ${highestLevel.animal})`;
            } catch (error) {
                console.error('Î™ÖÏòàÏùò Ï†ÑÎãπ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
            }
        }

        // ==================== ÌéòÏù¥ÏßÄ Í¥ÄÎ¶¨ ====================

        window.showPage = function(pageName, element) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(pageName + '-page').classList.add('active');
            if (element) {
                element.classList.add('active');
            }
            
            const gameStats = document.getElementById('game-stats');
            const userInfo = document.getElementById('user-info');
            
            if (pageName === 'game') {
                gameStats.style.display = 'flex';
                userInfo.style.display = 'block';
            } else if (pageName === 'encyclopedia') {
                gameStats.style.display = 'none';
                userInfo.style.display = 'block';
                updateEncyclopedia();
            } else {
                gameStats.style.display = 'none';
                userInfo.style.display = 'none';
            }
        }

        // ==================== Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ====================
        
        document.getElementById('login-btn').addEventListener('click', async () => {
            try {
                await handleLogin();
            } catch (error) {
                console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', error);
                document.getElementById('login-feedback').textContent = "Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
            }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            try {
                await handleSignup();
            } catch (error) {
                console.error('ÌöåÏõêÍ∞ÄÏûÖ Ïò§Î•ò:', error);
                document.getElementById('login-feedback').textContent = "ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
            }
        });

        document.getElementById('player-pin-input').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                try {
                    await handleLogin();
                } catch (error) {
                    console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', error);
                    document.getElementById('login-feedback').textContent = "Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
                }
            }
        });

        // ÏùåÏÑ± Ìï©ÏÑ± Ï§ÄÎπÑ
        window.speechSynthesis.onvoiceschanged = () => {
            window.speechSynthesis.getVoices();
        };

        console.log('üêæ ÎèôÎ¨º ÏàòÏßë ÌïôÏäµ Í≤åÏûÑÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§! (v7.0 - Clean Rebuild)');
    </script>
</body>
</html>
