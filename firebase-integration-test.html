<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ Firebase Integration Test</title>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #FFB6C1 100%); 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #2C5530; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 10px; 
            background: rgba(255,255,255,0.7); 
            border-left: 5px solid #4169E1; 
        }
        .status { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            font-weight: bold; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button { 
            background: linear-gradient(45deg, #28a745, #20c997); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 10px 5px; 
            transition: all 0.3s ease; 
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ Firebase Integration Test</h1>
        <div class="info status">
            <strong>ğŸ“‹ í…ŒìŠ¤íŠ¸ ëª©ì :</strong> Firebase ë©€í‹°í”Œë ˆì´ì–´ ê¸°ëŠ¥ ë° ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ê²€ì¦
        </div>
        
        <div class="test-section">
            <h3>ğŸ¯ í…ŒìŠ¤íŠ¸ ì§„í–‰ ìƒí™©</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="progress-text">í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...</div>
            <button onclick="runManualTests()">ğŸš€ ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
            <button onclick="clearResults()">ğŸ§¹ ê²°ê³¼ ì§€ìš°ê¸°</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
            <div id="test-results">
                <div class="warning status">í…ŒìŠ¤íŠ¸ê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” ìƒì„¸ ë¡œê·¸</h3>
            <div class="log-output" id="log-output">
                í…ŒìŠ¤íŠ¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ® ì‹¤ì œ ê²Œì„ ì—°ê²°</h3>
            <div class="info status">
                Firebase í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•˜ë©´ ì‹¤ì œ ê²Œì„ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
            <button onclick="window.open('./', '_blank')">ğŸ¯ ê²Œì„ ì—´ê¸°</button>
        </div>
    </div>

    <!-- Firebase ëª¨ë“ˆ import -->
    <script type="module">
        // Firebase ë° ê²Œì„ ëª¨ë“ˆ import
        import { initializeFirebase, handleLogin } from './js/auth/firebase-auth.js';
        import { testFirebaseConnection, saveUserProfile, loadUserProfile, 
                 getGlobalLeaderboard, updateGameScore, updateAnimalCollection } from './js/game/firebase-data.js';

        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        window.currentUserProfile = null;
        window.currentUserId = null;
        
        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¶”ì 
        let testProgress = 0;
        const totalTests = 5;
        const testResults = {};
        
        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logEl = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(step, testName, success) {
            testProgress = step;
            const percent = (step / totalTests) * 100;
            
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = 
                `í…ŒìŠ¤íŠ¸ ì§„í–‰: ${step}/${totalTests} - ${testName}`;
            
            testResults[testName] = success;
        }
        
        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
        function displayResults() {
            const resultsEl = document.getElementById('test-results');
            const passedTests = Object.values(testResults).filter(Boolean).length;
            const totalTestCount = Object.keys(testResults).length;
            
            let html = '';
            
            // ì „ì²´ ê²°ê³¼
            if (passedTests === totalTestCount) {
                html += '<div class="success status">ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! Firebase ë©€í‹°í”Œë ˆì´ì–´ ê¸°ëŠ¥ì´ ì™„ì „íˆ ì‘ë™í•©ë‹ˆë‹¤.</div>';
            } else {
                html += `<div class="error status">âš ï¸ ${totalTestCount - passedTests}ê°œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ì¼ë¶€ ê¸°ëŠ¥ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.</div>`;
            }
            
            // ê°œë³„ í…ŒìŠ¤íŠ¸ ê²°ê³¼
            html += '<h4>ğŸ“‹ ìƒì„¸ ê²°ê³¼:</h4>';
            for (const [testName, success] of Object.entries(testResults)) {
                const statusClass = success ? 'success' : 'error';
                const icon = success ? 'âœ…' : 'âŒ';
                html += `<div class="${statusClass} status">${icon} ${testName}</div>`;
            }
            
            resultsEl.innerHTML = html;
        }
        
        // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
        async function waitForFirebase(maxWait = 15000) {
            log('ğŸ”¥ Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWait) {
                if (window.firebase && window.currentUserId) {
                    log(`âœ… Firebase ì¤€ë¹„ ì™„ë£Œ (ì‚¬ìš©ì ID: ${window.currentUserId})`);
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            log('âŒ Firebase ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ');
            return false;
        }
        
        // í…ŒìŠ¤íŠ¸ 1: Firebase ì—°ê²°
        async function test1_FirebaseConnection() {
            log('ğŸ§ª í…ŒìŠ¤íŠ¸ 1: Firebase ì—°ê²° í…ŒìŠ¤íŠ¸...');
            updateProgress(1, 'Firebase ì—°ê²°', false);
            
            try {
                const isConnected = await testFirebaseConnection();
                if (isConnected) {
                    log('âœ… Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ');
                    updateProgress(1, 'Firebase ì—°ê²°', true);
                    return true;
                } else {
                    log('âŒ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
                    return false;
                }
            } catch (error) {
                log(`âŒ Firebase ì—°ê²° ì˜¤ë¥˜: ${error.message}`);
                return false;
            }
        }
        
        // í…ŒìŠ¤íŠ¸ 2: ì‚¬ìš©ì ì¸ì¦
        async function test2_Authentication() {
            log('ğŸ§ª í…ŒìŠ¤íŠ¸ 2: ì‚¬ìš©ì ì¸ì¦ í…ŒìŠ¤íŠ¸...');
            updateProgress(2, 'ì‚¬ìš©ì ì¸ì¦', false);
            
            try {
                // ì„ì‹œ DOM ìš”ì†Œ ìƒì„±
                const nameInput = document.createElement('input');
                nameInput.id = 'player-name-input';
                nameInput.value = 'ì•„ë¹ ';
                document.body.appendChild(nameInput);
                
                const pinInput = document.createElement('input');
                pinInput.id = 'player-pin-input';
                pinInput.value = '9329';
                document.body.appendChild(pinInput);
                
                const feedback = document.createElement('div');
                feedback.id = 'login-feedback';
                document.body.appendChild(feedback);
                
                // ë¡œê·¸ì¸ ì‹œë„
                await handleLogin();
                
                // ê²°ê³¼ í™•ì¸
                if (window.currentUserProfile && window.currentUserProfile.name === 'ì•„ë¹ ') {
                    log('âœ… ì‚¬ìš©ì ì¸ì¦ í…ŒìŠ¤íŠ¸ ì„±ê³µ');
                    updateProgress(2, 'ì‚¬ìš©ì ì¸ì¦', true);
                    
                    // DOM ì •ë¦¬
                    document.body.removeChild(nameInput);
                    document.body.removeChild(pinInput);
                    document.body.removeChild(feedback);
                    
                    return true;
                } else {
                    log('âŒ ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨: í”„ë¡œí•„ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ');
                    return false;
                }
            } catch (error) {
                log(`âŒ ì‚¬ìš©ì ì¸ì¦ ì˜¤ë¥˜: ${error.message}`);
                return false;
            }
        }
        
        // í…ŒìŠ¤íŠ¸ 3: í”„ë¡œí•„ ë™ê¸°í™”
        async function test3_ProfileSync() {
            log('ğŸ§ª í…ŒìŠ¤íŠ¸ 3: í”„ë¡œí•„ ë™ê¸°í™” í…ŒìŠ¤íŠ¸...');
            updateProgress(3, 'í”„ë¡œí•„ ë™ê¸°í™”', false);
            
            try {
                if (!window.currentUserProfile) {
                    throw new Error('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const success = await saveUserProfile(window.currentUserProfile);
                if (success) {
                    log('âœ… í”„ë¡œí•„ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì„±ê³µ');
                    updateProgress(3, 'í”„ë¡œí•„ ë™ê¸°í™”', true);
                    return true;
                } else {
                    log('âŒ í”„ë¡œí•„ ë™ê¸°í™” ì‹¤íŒ¨');
                    return false;
                }
            } catch (error) {
                log(`âŒ í”„ë¡œí•„ ë™ê¸°í™” ì˜¤ë¥˜: ${error.message}`);
                return false;
            }
        }
        
        // í…ŒìŠ¤íŠ¸ 4: ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ
        async function test4_Leaderboard() {
            log('ğŸ§ª í…ŒìŠ¤íŠ¸ 4: ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ í…ŒìŠ¤íŠ¸...');
            updateProgress(4, 'ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ', false);
            
            try {
                const players = await getGlobalLeaderboard();
                log(`âœ… ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ: ${players.length}ëª… ë¡œë“œë¨`);
                updateProgress(4, 'ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ', true);
                return true;
            } catch (error) {
                log(`âŒ ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ ì˜¤ë¥˜: ${error.message}`);
                return false;
            }
        }
        
        // í…ŒìŠ¤íŠ¸ 5: ì‹¤ì‹œê°„ ê²Œì„ ë°ì´í„° ë™ê¸°í™”
        async function test5_GameplaySync() {
            log('ğŸ§ª í…ŒìŠ¤íŠ¸ 5: ì‹¤ì‹œê°„ ê²Œì„ ë°ì´í„° ë™ê¸°í™” í…ŒìŠ¤íŠ¸...');
            updateProgress(5, 'ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”', false);
            
            try {
                if (!window.currentUserProfile) {
                    throw new Error('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const originalScore = window.currentUserProfile.totalScore || 0;
                const newScore = originalScore + 150;
                
                // ì ìˆ˜ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
                await updateGameScore(newScore);
                log(`ğŸ“Š ì ìˆ˜ ë™ê¸°í™” ì™„ë£Œ: ${newScore}ì `);
                
                // ë™ë¬¼ ìˆ˜ì§‘ ë™ê¸°í™” í…ŒìŠ¤íŠ¸
                const newAnimal = `Firebaseí…ŒìŠ¤íŠ¸ë™ë¬¼_${Date.now()}`;
                await updateAnimalCollection(newAnimal);
                log(`ğŸ¾ ë™ë¬¼ ìˆ˜ì§‘ ë™ê¸°í™” ì™„ë£Œ: ${newAnimal}`);
                
                log('âœ… ì‹¤ì‹œê°„ ê²Œì„ ë°ì´í„° ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì„±ê³µ');
                updateProgress(5, 'ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”', true);
                return true;
            } catch (error) {
                log(`âŒ ì‹¤ì‹œê°„ ê²Œì„ ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜: ${error.message}`);
                return false;
            }
        }
        
        // ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runAllTests() {
            log('ğŸš€ Firebase í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
            const firebaseReady = await waitForFirebase();
            if (!firebaseReady) {
                log('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ë¡œ í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨');
                displayResults();
                return;
            }
            
            // í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            await test1_FirebaseConnection();
            await test2_Authentication();
            await test3_ProfileSync();
            await test4_Leaderboard();
            await test5_GameplaySync();
            
            // ìµœì¢… ê²°ê³¼ í‘œì‹œ
            displayResults();
            
            const passedTests = Object.values(testResults).filter(Boolean).length;
            log(`ğŸ¯ í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${passedTests}/${totalTests} ì„±ê³µ`);
        }
        
        // ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹œì‘
        window.runManualTests = function() {
            log('ğŸ® ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            runAllTests();
        };
        
        // ê²°ê³¼ ì§€ìš°ê¸°
        window.clearResults = function() {
            document.getElementById('log-output').textContent = 'í…ŒìŠ¤íŠ¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...\n';
            document.getElementById('test-results').innerHTML = '<div class="warning status">í…ŒìŠ¤íŠ¸ê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-text').textContent = 'í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...';
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì´ˆê¸°í™”
            for (const key in testResults) {
                delete testResults[key];
            }
            testProgress = 0;
            
            log('ğŸ§¹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        };
        
        // Firebase ì¤€ë¹„ ì½œë°±
        window.onFirebaseReady = function(user) {
            if (user) {
                window.currentUserId = user.uid;
                log(`ğŸ”‘ Firebase ì¸ì¦ ì™„ë£Œ: ${user.uid}`);
            } else {
                log('âŒ Firebase ì¸ì¦ ì‹¤íŒ¨');
            }
        };
        
        // Firebase ì´ˆê¸°í™”
        async function initialize() {
            log('ğŸ”¥ Firebase ì´ˆê¸°í™” ì¤‘...');
            try {
                const initialized = await initializeFirebase();
                if (initialized) {
                    log('âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ');
                    
                    // ìë™ í…ŒìŠ¤íŠ¸ ì‹œì‘ (3ì´ˆ í›„)
                    setTimeout(() => {
                        log('â° ìë™ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
                        runAllTests();
                    }, 3000);
                } else {
                    log('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨');
                }
            } catch (error) {
                log(`âŒ Firebase ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        initialize();
    </script>
</body>
</html>